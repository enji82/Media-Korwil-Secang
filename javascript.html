<div id="appModal" class="modal-overlay">
    <div class="modal-content">
        <div id="modalSpinner" style="display: none;"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div></div>
        <h3 id="modalTitle"></h3>
        <p id="modalMessage"></p>
        <div class="modal-actions">
            <button id="modalOkBtn" class="submit-btn" style="background-color: #3498db;">OK</button>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="deleteModalTitle">Konfirmasi Hapus</h3>
        <div id="deleteModalBody"></div>
        <div class="modal-actions">
            <button id="cancelDeleteBtn" class="cancel-btn">Batal</button>
            <button id="confirmDeleteBtn" class="delete-btn-confirm">Ya, Hapus</button>
        </div>
    </div>
</div>

<script>
/**
 * ===================================================================
 * ======================= 1. FUNGSI INTI & UTILITAS =================
 * ===================================================================
 */

function showAppModal(state, message, redirectPage = null) {
    const modal = document.getElementById('appModal');
    const spinner = document.getElementById('modalSpinner');
    const title = document.getElementById('modalTitle');
    const msg = document.getElementById('modalMessage');
    const okBtn = document.getElementById('modalOkBtn');
    spinner.style.display = 'none';
    okBtn.style.display = 'block';
    msg.innerHTML = message;
    if (state === 'loading') {
        title.textContent = "Memproses...";
        spinner.style.display = 'block';
        okBtn.style.display = 'none';
    } else if (state === 'success') {
        title.textContent = 'Sukses!';
        title.style.color = '#27ae60';
        okBtn.textContent = 'OK';
        okBtn.onclick = () => {
            modal.classList.remove('show');
            if (redirectPage) loadPage(null, redirectPage);
        };
    } else if (state === 'info') {
        title.textContent = 'Informasi Penting';
        title.style.color = '#00c3ff';
        okBtn.textContent = 'Mengerti';
        okBtn.onclick = () => modal.classList.remove('show');
    } else { // 'error'
        title.textContent = 'Error!';
        title.style.color = '#e74c3c';
        okBtn.textContent = 'OK';
        okBtn.onclick = () => modal.classList.remove('show');
    }
    modal.classList.add('show');
}

function loadPage(event, pageName, params = {}) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    const contentArea = document.getElementById('main-content');
    contentArea.innerHTML = '<div class="loading-container"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div><p>Memuat halaman...</p></div>';
    
    google.script.run
        .withSuccessHandler(html => {
            try {
                contentArea.innerHTML = html;
                if (typeof pageInitializers !== 'undefined' && typeof pageInitializers[pageName] === 'function') {
                    pageInitializers[pageName](params);
                }
                updateActiveMenu(pageName);
                addRequiredStars(); // <-- DITAMBAHKAN: Panggil fungsi untuk menambahkan bintang
            } catch (e) {
                console.error("Client-side error after loading page:", e);
                contentArea.innerHTML = `<div class="error-box"><h3>Error JavaScript di Browser!</h3><p><strong>Pesan:</strong> ${e.message}</p><p><strong>Stack:</strong> ${e.stack}</p></div>`;
            }
        })
        .withFailureHandler(err => {
            console.error("Server-side error during include:", err);
            contentArea.innerHTML = `<div class="error-box"><h3>Gagal Memuat Konten!</h3><p>Pastikan file HTML 'page_${pageName}.html' ada dan namanya sudah benar.</p><p><strong>Pesan Server:</strong> ${err.message}</p></div>`;
        })
        .include('page_' + pageName);
}

function updateActiveMenu(pageName) {
    document.querySelectorAll('.sidebar-menu a').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.sidebar-menu .has-submenu').forEach(el => el.classList.remove('open'));

    let activeLink = document.querySelector(`.sidebar-menu a[data-page="${pageName}"]`);
    let startElement = null;

    if (activeLink) {
        activeLink.classList.add('active');
        startElement = activeLink;
    } else {
        const parentPageName = pageName.replace('_menu', '');
        const parentLink = document.querySelector(`.sidebar-menu a[data-page-parent="${parentPageName}"]`);
        
        if (parentLink) {
            parentLink.classList.add('active');
            parentLink.parentElement.classList.add('open');
            startElement = parentLink;
        }
    }

    if (!startElement) return;

    let parent = startElement.closest('.has-submenu');
    while (parent) {
        parent.classList.add('open');
        const parentAnchor = parent.querySelector('a[data-page-parent]');
        if (parentAnchor) {
            parentAnchor.classList.add('active');
        }
        parent = parent.parentElement.closest('.has-submenu');
    }
}

/**
 * [BARU] Fungsi untuk menambahkan tanda bintang (*) pada label input yang wajib diisi.
 */
function addRequiredStars() {
    const form = document.querySelector('#main-content form');
    if (form) {
        form.querySelectorAll('input[required], select[required], textarea[required]').forEach(input => {
            const label = form.querySelector(`label[for="${input.id}"]`);
            if (label && !label.querySelector('.required-star')) {
                label.innerHTML += ' <span class="required-star">*</span>';
            }
        });
    }
}

const debounce = (func, timeout = 150) => {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => { func.apply(this, args); }, timeout);
    };
};

/**
 * [BARU & DIPERBAIKI] Fungsi reusable untuk dropdown informasi.
 * @param {string} buttonId - ID dari tombol dropdown.
 * @param {string} contentId - ID dari kontainer konten dropdown.
 * @param {string} serverFunctionName - Nama fungsi di code.gs yang akan dipanggil.
 */
function setupInfoDropdown(buttonId, contentId, serverFunctionName) {
    const infoBtn = document.getElementById(buttonId);
    const contentDiv = document.getElementById(contentId);

    if (!infoBtn || !contentDiv) return;

    let isDataLoaded = false;

    infoBtn.onclick = function() {
        const isOpen = this.classList.toggle('active');
        contentDiv.style.maxHeight = isOpen ? (contentDiv.scrollHeight + "px") : "0px";

        if (isOpen && !isDataLoaded) {
            google.script.run
                .withSuccessHandler(infoItems => {
                    if (infoItems && infoItems.length > 0) {
                        const infoContent = `<ul style="text-align: left; padding: 10px 20px 10px 35px; line-height: 1.6; margin: 0;">${infoItems.map(item => `<li>${item}</li>`).join('')}</ul>`;
                        contentDiv.innerHTML = infoContent;
                    } else {
                        contentDiv.innerHTML = '<p style="padding: 15px;">Informasi tidak ditemukan.</p>';
                    }
                    contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                    isDataLoaded = true;
                })
                .withFailureHandler(err => {
                    contentDiv.innerHTML = `<p style="color:red; padding: 15px;">Gagal memuat: ${err.message}</p>`;
                    contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                })
                [serverFunctionName]();
        }
    };
}


/**
 * ===================================================================
 * =================== 2. FUNGSI INISIALISASI HALAMAN ================
 * ===================================================================
 */

function initHomePage() {
    document.querySelectorAll('#main-content .menu-button').forEach((button, index) => {
        button.style.animationDelay = `${index * 0.07}s`;
    });
}

function initSubMenuPage() {
    document.querySelectorAll('#main-content .menu-button').forEach((button, index) => {
        button.style.animationDelay = `${index * 0.07}s`;
    });
}

// --- Modul SK Pembagian Tugas (Semua fungsi lengkap) ---

function initSkUnggahPage() {
    const form = document.getElementById('manualUploadForm');
    if (!form) return;

    function populateSingleDropdown(elementId, optionsArray, defaultText) {
        const dropdown = document.getElementById(elementId);
        if (!dropdown) return;
        dropdown.innerHTML = `<option value="" disabled selected>${defaultText}</option>`;
        if (optionsArray && optionsArray.length > 0) {
            optionsArray.forEach(item => {
                let option = document.createElement("option");
                option.value = item;
                option.textContent = item;
                dropdown.appendChild(option);
            });
        }
    }

    google.script.run
        .withSuccessHandler(optionsObject => {
            populateSingleDropdown("namaSD", optionsObject["Nama SD"], "Pilih Sekolah");
            populateSingleDropdown("tahunAjaran", optionsObject["Tahun Ajaran"], "Pilih Tahun Ajaran");
            populateSingleDropdown("semester", optionsObject["Semester"], "Pilih Semester");
            populateSingleDropdown("kriteriaSK", optionsObject["Kriteria SK"], "Pilih Kriteria SK");
        })
        .withFailureHandler(error => console.error('Gagal memuat opsi form SK:', error))
        .getMasterSkOptions();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = document.getElementById('submitBtn');
        submitButton.disabled = true;
        showAppModal('loading', 'Sedang memproses dan mengunggah file...');
        const file = document.getElementById('fileUpload').files[0];
        if (!file || file.size > 1024 * 1024) {
            showAppModal('error', 'File PDF maksimal 1 MB harus dipilih.');
            submitButton.disabled = false;
            return;
        }
        const reader = new FileReader();
        reader.onload = event => {
            const fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
            const formData = {
                namaSD: form.namaSD.value,
                tahunAjaran: form.tahunAjaran.value,
                semester: form.semester.value,
                kriteriaSK: form.kriteriaSK.value,
                nomorSK: form.nomorSK.value,
                tanggalSK: form.tanggalSK.value,
                fileData: fileData
            };
            google.script.run
                .withSuccessHandler(response => showAppModal('success', response, 'sk_riwayat'))
                .withFailureHandler(error => {
                    showAppModal('error', `Gagal menyimpan: ${error.message}`);
                    submitButton.disabled = false;
                })
                .processManualForm(formData);
        };
        reader.readAsDataURL(file);
    });
}

function initSkRiwayatPage() {
    let allDataRows = [], headerCols = [], filterIndices = {}, currentPage = 1, rowsPerPage = 15, currentFilteredRows = [];
    
    function buildTable() {
        const tableBody = document.getElementById('riwayatTable').querySelector('tbody');
        if (!tableBody) return;
        tableBody.innerHTML = '';
        const pageCount = Math.max(1, Math.ceil(currentFilteredRows.length / rowsPerPage));
        if (currentPage > pageCount) currentPage = pageCount;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = currentFilteredRows.slice(start, end);
        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${headerCols.length + 1}">Tidak ada data yang cocok.</td></tr>`;
        } else {
            paginatedRows.forEach((cols, index) => {
                const tr = document.createElement('tr');
                let rowHTML = `<td>${start + index + 1}</td>`;
                cols.forEach((cellData, i) => {
                    cellData = cellData || '-';
                    if (headerCols[i] === 'Dokumen' && typeof cellData === 'string' && cellData.startsWith('http')) {
                        rowHTML += `<td class="view-btn-container"><a href="${cellData}" target="_blank" class="action-btn view-btn"><i class="fas fa-eye"></i> Lihat</a></td>`;
                    } else {
                        rowHTML += `<td>${cellData}</td>`;
                    }
                });
                tr.innerHTML = rowHTML;
                tableBody.appendChild(tr);
            });
        }
        setupPagination();
    }

    function setupPagination() {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        if (pageCount <= 1) { paginationContainer.style.display = 'none'; return; }
        paginationContainer.style.display = 'flex';
        const pageInfo = document.createElement('span');
        pageInfo.className = 'page-info';
        pageInfo.textContent = `Halaman ${currentPage} dari ${pageCount}`;
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '«';
        prevBtn.className = 'page-btn';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; buildTable(); } };
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '»';
        nextBtn.className = 'page-btn';
        nextBtn.disabled = currentPage === pageCount;
        nextBtn.onclick = () => { if (currentPage < pageCount) { currentPage++; buildTable(); } };
        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
    }

    function applyFilters() {
        const filterTahun = document.getElementById('filterTahun').value;
        const filterSemester = document.getElementById('filterSemester').value;
        const filterNama = document.getElementById('filterNamaSekolah').value;
        currentFilteredRows = allDataRows.filter(cols => {
            const tahunMatch = (filterTahun === "") || (String(cols[filterIndices.tahun]) === filterTahun);
            const semesterMatch = (filterSemester === "") || (String(cols[filterIndices.semester]) === filterSemester);
            const namaMatch = (filterNama === "") || (String(cols[filterIndices.nama]) === filterNama);
            return tahunMatch && semesterMatch && namaMatch;
        });
        currentPage = 1;
        buildTable();
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('riwayatTable').querySelector('thead');
        const tableBody = document.getElementById('riwayatTable').querySelector('tbody');
        if (!dataArray || dataArray.length < 2) {
            loadingStatus.innerHTML = "<p>Tidak ada data riwayat untuk ditampilkan.</p>"; return;
        }
        headerCols = dataArray[0].map(h => String(h).trim());
        allDataRows = dataArray.slice(1);
        
        const updateIndex = headerCols.indexOf('Update');
        if (updateIndex > -1) {
          headerCols.splice(updateIndex, 1);
          allDataRows.forEach(row => row.splice(updateIndex, 1));
        }

        const headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th>No.</th>';
        headerCols.forEach(header => { headerRow.innerHTML += `<th>${header}</th>`; });
        tableHead.innerHTML = '';
        tableHead.appendChild(headerRow);
        
        rowsPerPage = 15; // Fallback
        tableBody.innerHTML = '';
        
        filterIndices = { tahun: headerCols.indexOf('Tahun Ajaran'), semester: headerCols.indexOf('Semester'), nama: headerCols.indexOf('Nama SD') };
        
        Object.keys(filterIndices).forEach(key => {
            const selectId = 'filter' + key.charAt(0).toUpperCase() + key.slice(1);
            const realSelect = document.getElementById(key === 'nama' ? 'filterNamaSekolah' : selectId);
            if (!realSelect) return;
            const uniqueValues = [...new Set(allDataRows.map(row => String(row[filterIndices[key]])))];
            realSelect.innerHTML = `<option value="">Semua</option>`;
            const sortOrder = (key === 'tahun') ? uniqueValues.sort().reverse() : uniqueValues.sort();
            sortOrder.forEach(val => { if(val && val.trim() !== '') realSelect.add(new Option(val, val)); });
            realSelect.addEventListener('change', applyFilters);
        });
        
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'block';
        applyFilters();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getRiwayatPengirimanSKData();
}

function initSkStatusPage() {
    let allDataRows = [], headerCols = [], currentPage = 1, rowsPerPage = 15;
    
    function buildTable() {
        const tableBody = document.getElementById('statusTable').querySelector('tbody');
        if (!tableBody) return;
        tableBody.innerHTML = '';
        const pageCount = Math.max(1, Math.ceil(allDataRows.length / rowsPerPage));
        if (currentPage > pageCount) currentPage = pageCount;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = allDataRows.slice(start, end);
        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${headerCols.length + 1}">Tidak ada data.</td></tr>`;
        } else {
            paginatedRows.forEach((cols, index) => {
                const tr = document.createElement('tr');
                let rowHTML = `<td>${start + index + 1}</td>`;
                cols.forEach((cellData, i) => {
                    rowHTML += `<td>${cellData || '-'}</td>`;
                });
                tr.innerHTML = rowHTML;
                tableBody.appendChild(tr);
            });
        }
        setupPagination();
    }

    function setupPagination() {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        const pageCount = Math.ceil(allDataRows.length / rowsPerPage);
        if (pageCount <= 1) { paginationContainer.style.display = 'none'; return; }
        paginationContainer.style.display = 'flex';
        const pageInfo = document.createElement('span');
        pageInfo.className = 'page-info';
        pageInfo.textContent = `Halaman ${currentPage} dari ${pageCount}`;
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '«';
        prevBtn.className = 'page-btn';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; buildTable(); } };
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '»';
        nextBtn.className = 'page-btn';
        nextBtn.disabled = currentPage === pageCount;
        nextBtn.onclick = () => { if (currentPage < pageCount) { currentPage++; buildTable(); } };
        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('statusTable').querySelector('thead');
        const tableBody = document.getElementById('statusTable').querySelector('tbody');
        if (!dataArray || dataArray.length < 2) {
            loadingStatus.innerHTML = "<p>Tidak ada data status untuk ditampilkan.</p>";
            return;
        }
        headerCols = dataArray[0].map(h => String(h).trim());
        allDataRows = dataArray.slice(1);
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th>No.</th>';
        headerCols.forEach(header => { headerRow.innerHTML += `<th>${header}</th>`; });
        tableHead.innerHTML = '';
        tableHead.appendChild(headerRow);
        
        rowsPerPage = 15; // Fallback
        tableBody.innerHTML = '';
        
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'block';
        buildTable();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getStatusPengirimanSKData();
}

function initSkKelolaPage() {
    let allDataRows = [], allHeaders = [], currentFilteredRows = [], currentPage = 1, rowsPerPage = 15;
 
    function buildTable() {
        const tableBody = document.getElementById('kelolaTable').querySelector('tbody');
        if (!tableBody) return;
        tableBody.innerHTML = '';
        const pageCount = Math.max(1, Math.ceil(currentFilteredRows.length / rowsPerPage));
        if (currentPage > pageCount) currentPage = pageCount;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = currentFilteredRows.slice(start, end);

        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders.length + 1}">Tidak ada data yang cocok.</td></tr>`;
        } else {
            paginatedRows.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${start + index + 1}</td>`;

                allHeaders.forEach(header => {
                    const td = document.createElement('td');
                    if (header === 'Aksi') {
                        td.className = 'action-buttons';
                        const editBtn = document.createElement('button');
                        editBtn.className = 'action-btn edit-btn';
                        editBtn.innerHTML = `<i class="fas fa-pencil-alt"></i> Edit`;
                        editBtn.onclick = (e) => loadPage(e, 'sk_edit', { rowIndex: row.rowIndex });
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'action-btn delete-btn';
                        deleteBtn.innerHTML = `<i class="fas fa-trash"></i> Hapus`;
                        deleteBtn.onclick = () => showDeleteConfirmation(row);
                        
                        td.appendChild(editBtn);
                        td.appendChild(deleteBtn);
                    } else {
                        let cellData = row.data[header] || '-';
                        if (header === 'Dokumen' && typeof cellData === 'string' && cellData.startsWith('http')) {
                            td.className = 'view-btn-container';
                            td.innerHTML = `<a href="${cellData}" target="_blank" class="action-btn view-btn"><i class="fas fa-eye"></i> Lihat</a>`;
                        } else {
                            td.textContent = cellData;
                        }
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
        setupPagination();
    }
 
    function setupPagination() {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        if (pageCount <= 1) { paginationContainer.style.display = 'none'; return; }
        paginationContainer.style.display = 'flex';
        const pageInfo = document.createElement('span');
        pageInfo.className = 'page-info';
        pageInfo.textContent = `Halaman ${currentPage} dari ${pageCount}`;
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '«';
        prevBtn.className = 'page-btn';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; buildTable(); } };
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '»';
        nextBtn.className = 'page-btn';
        nextBtn.disabled = currentPage === pageCount;
        nextBtn.onclick = () => { if (currentPage < pageCount) { currentPage++; buildTable(); } };
        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
    }
 
    function applyFilters() {
        const filterTahun = document.getElementById('filterTahun').value;
        const filterSemester = document.getElementById('filterSemester').value;
        const filterNama = document.getElementById('filterNamaSekolah').value;
        currentFilteredRows = allDataRows.filter(row => {
            const tahunMatch = (filterTahun === "") || (row.data['Tahun Ajaran'] === filterTahun);
            const semesterMatch = (filterSemester === "") || (row.data['Semester'] === filterSemester);
            const namaMatch = (filterNama === "") || (row.data['Nama SD'] === filterNama);
            return tahunMatch && semesterMatch && namaMatch;
        });
        currentPage = 1;
        buildTable();
    }
 
    function showDeleteConfirmation(rowInfo) {
        const modal = document.getElementById('deleteModal');
        if (!modal) return;
        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');
        const cancelBtn = modal.querySelector('#cancelDeleteBtn');
        modalTitle.textContent = 'Konfirmasi Hapus';
        modalBody.innerHTML = `<p>Apakah Anda yakin ingin menghapus data SK ini?</p><div style="font-weight: bold; margin: 15px 0; background:rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; line-height: 1.5; text-align: left;">Sekolah: ${rowInfo.data['Nama SD']}<br>Tahun Ajaran: ${rowInfo.data['Tahun Ajaran']}</div>`;
        confirmBtn.style.display = 'inline-flex';
        confirmBtn.textContent = 'Ya, Hapus';
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.onclick = () => showDeletePrompt(rowInfo);
        cancelBtn.onclick = () => modal.classList.remove('show');
        modal.classList.add('show');
    }
 
    function showDeletePrompt(rowInfo) {
        const modal = document.getElementById('deleteModal');
        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');
        modalTitle.textContent = 'Masukkan Kode Hapus';
        modalBody.innerHTML = `<p>Kode hapus dapat ditanyakan ke admin Korwil.</p><input type="password" id="kodeHapusInput" class="custom-modal-input" autocomplete="off" placeholder="Masukkan Kode Hapus">`;
        confirmBtn.textContent = 'Konfirmasi & Hapus';
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.onclick = () => processDeletion(rowInfo);
        setTimeout(() => document.getElementById('kodeHapusInput').focus(), 100);
    }
 
    function processDeletion(rowInfo) {
        const deleteCode = document.getElementById('kodeHapusInput').value;
        if (!deleteCode) { 
            showAppModal('error', 'Kode hapus tidak boleh kosong.');
            return; 
        }
        showAppModal('loading', 'Menghapus data dan file terkait...');
        google.script.run
            .withSuccessHandler(response => {
                document.getElementById('deleteModal').classList.remove('show');
                showAppModal('success', response, 'sk_kelola');
            })
            .withFailureHandler(error => showAppModal('error', error.message))
            .deleteSKData(rowInfo.rowIndex, deleteCode);
    }
 
    function initializePage(data) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('kelolaTable').querySelector('thead');
        if (data.error || !data.rows || data.rows.length === 0) {
            loadingStatus.innerHTML = `<p>Tidak ada data untuk dikelola.</p>`; return;
        }

        allHeaders = data.headers;
        allDataRows = data.rows;
        
        const docIndex = allHeaders.indexOf('Dokumen');
        if (docIndex > -1) {
            allHeaders.splice(docIndex + 1, 0, 'Aksi');
        }
        
        tableHead.innerHTML = `<tr><th>No.</th>${allHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;
        
        rowsPerPage = 15; // fallback
        
        const uniqueValues = { tahun: [], semester: [], nama: [] };
        allDataRows.forEach(row => {
            uniqueValues.tahun.push(row.data['Tahun Ajaran']);
            uniqueValues.semester.push(row.data['Semester']);
            uniqueValues.nama.push(row.data['Nama SD']);
        });
        const populateSelect = (id, values, sortReverse = false) => {
            const select = document.getElementById(id);
            if (!select) return;
            select.innerHTML = '<option value="">Semua</option>';
            let sortedValues = [...new Set(values)].filter(Boolean).sort();
            if(sortReverse) sortedValues.reverse();
            sortedValues.forEach(val => select.add(new Option(val, val)));
            select.addEventListener('change', applyFilters);
        };
        populateSelect('filterTahun', uniqueValues.tahun, true);
        populateSelect('filterSemester', uniqueValues.semester);
        populateSelect('filterNamaSekolah', uniqueValues.nama);
        loadingStatus.style.display = 'none';
        document.querySelector('.filter-container').style.display = 'flex';
        tableWrapper.style.display = 'block'; 
        document.getElementById('pagination-container').style.display = 'flex';
        applyFilters();
    }
 
    google.script.run.withSuccessHandler(initializePage).withFailureHandler(err => {
        document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal: ${err.message}</p>`
    }).getSKDataForManagement();
}

function initSkEditPage(params) {
    const rowIndex = params ? params.rowIndex : null;
    if (!rowIndex) {
        document.getElementById('main-content').innerHTML = `<p style="color:red;">Error: ID baris tidak ditemukan.</p>`;
        return;
    }
    const form = document.getElementById('skEditForm');
    const loadingDiv = document.getElementById('loading-data');
    form.querySelector('#rowIndex').value = rowIndex;
    google.script.run.withSuccessHandler(options => {
        google.script.run.withSuccessHandler(rowData => {
            const fieldMapping = {
                'Nama SD': 'namaSD', 'Tahun Ajaran': 'tahunAjaran', 'Semester': 'semester',
                'Kriteria SK': 'kriteriaSK', 'Nomor SK': 'nomorSK', 'Tanggal SK': 'tanggalSK'
            };
            for (const key in options) {
                const elementId = fieldMapping[key];
                if (elementId) {
                    const select = document.getElementById(elementId);
                    if (select && Array.isArray(options[key])) {
                        select.innerHTML = options[key].map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    }
                }
            }
            for (const key in rowData) {
                const elementId = fieldMapping[key];
                if (elementId) {
                    const field = document.getElementById(elementId);
                    if (field) {
                        const savedValue = rowData[key];
                        if (field.tagName === 'SELECT') {
                            field.value = savedValue;
                            let optionExists = Array.from(field.options).some(opt => opt.value === savedValue);
                            if (!optionExists && savedValue) {
                                const newOption = new Option(savedValue, savedValue);
                                field.add(newOption);
                                field.value = savedValue;
                            }
                        }
                        else if (key === 'Tanggal SK' && savedValue) {
                            const parts = savedValue.split('/');
                            if (parts.length === 3) {
                                field.value = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            } else {
                                field.value = savedValue;
                            }
                        } else {
                            field.value = savedValue;
                        }
                    }
                }
            }
            const fileLink = rowData['Dokumen'];
            document.getElementById('existingFileLink').innerHTML = fileLink ? `<a href="${fileLink}" target="_blank">Lihat File Saat Ini</a>` : 'Tidak ada file.';
            
            loadingDiv.style.display = 'none';
            form.style.display = 'block';
        }).withFailureHandler(err => alert(`Gagal memuat data baris: ${err.message}`)).getSKDataByRow(rowIndex);
    }).withFailureHandler(err => alert(`Gagal memuat opsi dropdown: ${err.message}`)).getMasterSkOptions();
 
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        const submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        showAppModal('loading', 'Menyimpan perubahan...');
        const formDataObj = {
            rowIndex: form.rowIndex.value, 'Semester': document.getElementById('semester').value,
            'Kriteria SK': document.getElementById('kriteriaSK').value, 'Nomor SK': document.getElementById('nomorSK').value,
            'Tanggal SK': document.getElementById('tanggalSK').value,
        };
        const fileInput = document.getElementById('fileSK');
        const file = fileInput.files[0];
        const sendData = (data) => {
            google.script.run
                .withSuccessHandler(res => showAppModal('success', res, 'sk_kelola'))
                .withFailureHandler(err => {
                    showAppModal('error', err.message);
                    submitButton.disabled = false;
                })
                .updateSKData(data);
        };
        if (file) {
            if (file.size > 1024 * 1024) {
                showAppModal('error', 'Ukuran file baru tidak boleh lebih dari 1 MB.');
                submitButton.disabled = false; return;
            }
            const reader = new FileReader();
            reader.onload = function (event) {
                formDataObj.fileData = {
                    fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1]
                };
                sendData(formDataObj);
            };
            reader.readAsDataURL(file);
        } else {
            sendData(formDataObj);
        }
    });
}

function initSkArsipPage() {
    const MAIN_FOLDER_ID = "1GwIow8B4O1OWoq3nhpzDbMO53LXJJUKs";
    let breadcrumbTrail = [];
    const viewContainer = document.getElementById('view-container');
    const breadcrumbDiv = document.getElementById('breadcrumb');

    function updateBreadcrumb() {
        const fragment = document.createDocumentFragment();
        breadcrumbTrail.forEach((item, index) => {
            if (index > 0) { 
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                separator.style.margin = '0 5px';
                fragment.appendChild(separator);
            }
            const span = document.createElement('span');
            span.textContent = item.name;
            if (index < breadcrumbTrail.length - 1) {
                span.onclick = () => {
                    breadcrumbTrail.length = index;
                    if (item.type === 'root') {
                        renderTahunAjaranView();
                    } else if (item.type === 'tahun') {
                        renderSemesterView(item.id, item.name);
                    }
                };
            } else {
                span.classList.add('inactive');
            }
            fragment.appendChild(span);
        });
        breadcrumbDiv.innerHTML = '';
        breadcrumbDiv.appendChild(fragment);
    }

    function showLoading() {
        viewContainer.innerHTML = '<div class="loading-container"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div><p>Memuat...</p></div>';
    }

    function renderTahunAjaranView() {
        viewContainer.classList.remove('view-container-scrollable');
        breadcrumbTrail = [{ name: 'Tahun Ajaran', type: 'root', id: MAIN_FOLDER_ID }];
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(folders => {
            if (!folders || folders.length === 0) { 
                viewContainer.innerHTML = '<p>Tidak ada folder tahun ajaran ditemukan.</p>'; 
            } else {
                viewContainer.innerHTML = '<div class="card-grid"></div>';
                const cardGrid = viewContainer.querySelector('.card-grid');
                folders.forEach((folder, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.innerHTML = `<i class="fas fa-calendar-alt"></i><span>${folder.name}</span>`;
                    card.onclick = () => renderSemesterView(folder.id, folder.name);
                    cardGrid.appendChild(card);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat folder: ${err.message}</p>`;
        }).getFolders(MAIN_FOLDER_ID);
    }

    function renderSemesterView(tahunId, tahunName) {
        viewContainer.classList.remove('view-container-scrollable');
        breadcrumbTrail.push({ name: tahunName, type: 'tahun', id: tahunId });
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(folders => {
            if (!folders || folders.length === 0) { 
                viewContainer.innerHTML = '<p>Tidak ada folder semester ditemukan.</p>'; 
            } else {
                viewContainer.innerHTML = '<div class="card-grid"></div>';
                const cardGrid = viewContainer.querySelector('.card-grid');
                folders.sort((a, b) => a.name.localeCompare(b.name)).forEach((folder, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.innerHTML = `<i class="fas fa-folder-open"></i><span>${folder.name}</span>`;
                    card.onclick = () => renderFileView(folder.id, folder.name);
                    cardGrid.appendChild(card);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat folder: ${err.message}</p>`;
        }).getFolders(tahunId);
    }

    function renderFileView(semesterId, semesterName) {
        viewContainer.classList.add('view-container-scrollable');
        breadcrumbTrail.push({ name: semesterName, type: 'semester', id: semesterId });
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(files => {
            if (!files || files.length === 0) {
                viewContainer.innerHTML = '<p>Tidak ada file ditemukan di folder ini.</p>';
            } else {
                viewContainer.innerHTML = '<div class="file-list-container"></div>';
                const fileList = viewContainer.querySelector('.file-list-container');
                files.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.style.animationDelay = `${index * 0.03}s`;
                    fileItem.innerHTML = `<i class="fas fa-file-pdf"></i><a href="${file.url}" target="_blank">${file.name}</a>`;
                    fileList.appendChild(fileItem);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat file: ${err.message}</p>`;
        }).getFiles(semesterId);
    }
    
    renderTahunAjaranView();
}


// --- Modul Laporan Bulan (Semua fungsi lengkap dan diperbaiki) ---

function initLapbulUnggahPage() {
    initSubMenuPage(); 
    setupInfoDropdown('showInfoBtn', 'infoDropdownContent', 'getLapbulInfo');
}


function initLapbulFormPaudPage(params) {
    const form = document.getElementById('lapbulFormPaud');
    if (!form) return;

    const bulanSelect = form.querySelector('[name="laporanBulan"]');
    const tahunSelect = form.querySelector('[name="tahun"]');
    const jenjangSelect = document.getElementById('jenjang');
    const namaSekolahSelect = document.getElementById('namaSekolah');
    const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const d = new Date();
    const currentYear = d.getFullYear();
    const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
    bulanSelect.innerHTML = bulanOptions.map((m, i) => `<option value="${m}" ${i === prevMonthIndex ? 'selected' : ''}>${m}</option>`).join('');
    tahunSelect.innerHTML = [currentYear, currentYear - 1].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');

    showAppModal('loading', 'Memuat daftar sekolah...');
    google.script.run
        .withSuccessHandler(schoolLists => {
            const handleJenjangChange = () => {
                const selectedJenjang = jenjangSelect.value;
                const schoolList = schoolLists[selectedJenjang] || [];
                namaSekolahSelect.innerHTML = '<option value="" disabled selected>-- Pilih Sekolah --</option>';
                schoolList.forEach(school => {
                    namaSekolahSelect.add(new Option(school, school));
                });
                namaSekolahSelect.disabled = false;
            };
            jenjangSelect.addEventListener('change', handleJenjangChange);
            document.getElementById('appModal').classList.remove('show');
        })
        .withFailureHandler(err => showAppModal('error', `Gagal memuat daftar sekolah: ${err.message}`))
        .getPaudSchoolLists();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showAppModal('loading', 'Mengirim data dan mengunggah file...');
        const file = document.getElementById('fileLapbul').files[0];
        if (!file || file.size > 300 * 1024) { // 300 KB Limit
            showAppModal('error', 'File PDF dengan ukuran maksimal 300 KB harus dipilih.');
            submitButton.disabled = false;
            return;
        }
        const reader = new FileReader();
        reader.onload = event => {
            const fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
            const formData = Object.fromEntries(new FormData(form));
            formData.fileData = fileData;
            google.script.run
                .withSuccessHandler(response => showAppModal('success', response, 'lapbul_riwayat'))
                .withFailureHandler(error => {
                    showAppModal('error', `Gagal: ${error.message}`);
                    submitButton.disabled = false;
                })
                .processLapbulFormPaud(formData);
        };
        reader.readAsDataURL(file);
    });
}

function initLapbulFormSdPage() {
    const form = document.getElementById('lapbulFormSd');
    if (!form) return;

    function generateKelasHTML(kelas) {
        const rombels = ['A', 'B', 'C'];
        const agama = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
        let rombelInputsHTML = '';
        for (const rombel of rombels) {
            rombelInputsHTML += `<div class="rombel-input-group" id="rombel-${kelas}-${rombel}" style="display: none;"><label class="rombel-group-label">Kelas ${kelas}${rombel}</label><div class="murid-input-pair"><div class="form-group"><label>Laki-laki</label><input type="number" name="k${kelas}_rombel_${rombel.toLowerCase()}_L" value="0" min="0" required></div><div class="form-group"><label>Perempuan</label><input type="number" name="k${kelas}_rombel_${rombel.toLowerCase()}_P" value="0" min="0" required></div></div></div>`;
        }
        rombelInputsHTML += `<div class="rombel-input-group" id="rombel-${kelas}-Tunggal" style="display: none;"><label class="rombel-group-label">Kelas ${kelas}</label><div class="murid-input-pair"><div class="form-group"><label>Laki-laki</label><input type="number" name="k${kelas}_rombel_tunggal_L" value="0" min="0" required></div><div class="form-group"><label>Perempuan</label><input type="number" name="k${kelas}_rombel_tunggal_P" value="0" min="0" required></div></div></div>`;
        let agamaInputsHTML = '';
        for (const ag of agama) {
            const agId = ag.toLowerCase();
            const isIslam = ag === 'Islam';
            agamaInputsHTML += `<div class="form-grid agama-row"><div class="form-group"><label>${ag}</label><select class="agama-toggle" data-kelas="${kelas}" data-agama="${agId}"><option value="Ada" ${isIslam ? 'selected' : ''}>Ada</option><option value="Tidak Ada" ${!isIslam ? 'selected' : ''}>Tidak Ada</option></select></div><div class="agama-input-pair" id="agama-input-${kelas}-${agId}" style="display: ${isIslam ? 'grid' : 'none'};"><div class="form-group"><label>Laki-laki</label><input type="number" name="k${kelas}_agama_${agId}_L" value="0" min="0" required></div><div class="form-group"><label>Perempuan</label><input type="number" name="k${kelas}_agama_${agId}_P" value="0" min="0" required></div></div></div>`;
        }
        return `<div class="form-grid"><div class="form-group"><label>Jumlah Rombel Kelas ${kelas}</label><select class="rombel-toggle" name="k${kelas}_jumlah_rombel" data-kelas="${kelas}"><option value="0">0</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option></select></div></div><h4 class="sub-section-title">Jumlah Murid per Rombel</h4><div class="rombel-container" id="rombel-container-${kelas}">${rombelInputsHTML}</div><h4 class="sub-section-title">Jumlah Murid per Agama</h4><div class="agama-container">${agamaInputsHTML}</div>`;
    }
    function generatePtkNegeriHTML() {
    return `
    <fieldset class="ptk-fieldset">
      <legend>Data Jumlah PTK (Negeri)</legend>
      
      <fieldset class="ptk-sub-fieldset">
        <legend>Kepala Sekolah</legend>
        <div class="ptk-row ptk-grid-2">
            <div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_ks_pns" value="0" min="0" max="1"></div>
            <div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_ks_pppk" value="0" min="0" max="1"></div>
        </div>
      </fieldset>

      <fieldset class="ptk-sub-fieldset">
        <legend>Guru</legend>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Kelas</label><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_kelas_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_kelas_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_kelas_pppkpw" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_kelas_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PAI</label><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_pai_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_pai_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_pai_pppkpw" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_pai_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PJOK</label><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_pjok_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_pjok_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_pjok_pppkpw" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_pjok_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PA Kristen</label><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_kristen_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_kristen_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_kristen_pppkpw" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_kristen_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Bhs. Inggris</label><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_inggris_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Mapel Lainnya</label><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_lainnya_gtt" value="0" min="0"></div></div>
      </fieldset>

      <fieldset class="ptk-sub-fieldset">
        <legend>Tenaga Kependidikan</legend>
        <div class="ptk-row has-label ptk-grid-4"><label>Operator</label><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_tendik_operator_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_tendik_operator_pppkpw" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_operator_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Pengelola Umum</label><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_tendik_pengelola_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_tendik_pengelola_pppkpw" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_pengelola_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Penjaga Sekolah</label><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_penjaga_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Tenaga Administrasi</label><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_tas_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Pustakawan</label><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_pustakawan_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Tendik Lainnya</label><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_lainnya_ptt" value="0" min="0"></div></div>
      </fieldset>
    </fieldset>
    `;
    }

    function generatePtkSwastaHTML() {
    return `
    <fieldset class="ptk-fieldset">
      <legend>Data Jumlah PTK (Swasta)</legend>
      <fieldset class="ptk-sub-fieldset">
        <legend>Kepala Sekolah</legend>
        <div class="ptk-row ptk-grid-2">
            <div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_ks_gty" value="0" min="0" max="1"></div>
            <div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_ks_gtt" value="0" min="0" max="1"></div>
        </div>
      </fieldset>
      <fieldset class="ptk-sub-fieldset">
        <legend>Guru</legend>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Kelas</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_kelas_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_kelas_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PAI</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_pai_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_pai_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PJOK</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_pjok_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_pjok_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PA Kristen</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_kristen_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_kristen_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Bhs. Inggris</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_inggris_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_inggris_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Mapel Lainnya</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_lainnya_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_lainnya_gtt" value="0" min="0"></div></div>
      </fieldset>
      <fieldset class="ptk-sub-fieldset">
        <legend>Tenaga Kependidikan</legend>
        <div class="ptk-row has-label ptk-grid-4"><label>Operator</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_operator_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_operator_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Pengelola Umum</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_pengelola_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_pengelola_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Penjaga Sekolah</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_penjaga_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_penjaga_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Tenaga Administrasi</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_tas_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_tas_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Pustakawan</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_pustakawan_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_pustakawan_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Tendik Lainnya</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_lainnya_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_lainnya_ptt" value="0" min="0"></div></div>
      </fieldset>
    </fieldset>
    `;
    }
    
    (function setupInitialDropdowns() {
        const bulanSelect = form.querySelector('[name="laporanBulan"]');
        const tahunSelect = form.querySelector('[name="tahun"]');
        const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const d = new Date();
        const currentYear = d.getFullYear();
        const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
        bulanSelect.innerHTML = bulanOptions.map((m, i) => `<option value="${m}" ${i === prevMonthIndex ? 'selected' : ''}>${m}</option>`).join('');
        tahunSelect.innerHTML = [currentYear, currentYear - 1].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
    })();

    function setupDataSekolah(schoolLists) {
        const statusSekolah = document.getElementById('statusSekolah');
        const namaSekolah = document.getElementById('namaSekolah');
        const ptkContainer = document.getElementById('ptk-section-container');
        ptkContainer.innerHTML = `<div id="ptk-negeri">${generatePtkNegeriHTML()}</div> <div id="ptk-swasta">${generatePtkSwastaHTML()}</div>`;
        const ptkNegeri = document.getElementById('ptk-negeri');
        const ptkSwasta = document.getElementById('ptk-swasta');
        ptkNegeri.style.display = 'none';
        ptkSwasta.style.display = 'none';
        statusSekolah.addEventListener('change', function() {
            const status = this.value;
            const schoolList = status === 'Negeri' ? schoolLists.SDN : schoolLists.SDS;
            namaSekolah.innerHTML = '<option value="" disabled selected>-- Pilih Sekolah --</option>';
            schoolList.forEach(school => namaSekolah.add(new Option(school, school)));
            namaSekolah.disabled = false;
            if (status === 'Negeri') {
                ptkNegeri.style.display = 'block';
                ptkSwasta.style.display = 'none';
            } else if (status === 'Swasta') {
                ptkNegeri.style.display = 'none';
                ptkSwasta.style.display = 'block';
            }
        });
    }

    function setupDataMurid() {
        const tabsContainer = document.getElementById('kelas-tabs');
        const contentContainer = document.getElementById('kelas-content-container');
        for (let i = 1; i <= 6; i++) {
            tabsContainer.innerHTML += `<button type="button" class="tab-link ${i === 1 ? 'active' : ''}" data-kelas="${i}">Kelas ${i}</button>`;
            const content = document.createElement('div');
            content.id = `kelas-content-${i}`;
            content.className = 'tab-content';
            content.style.display = i === 1 ? 'block' : 'none';
            content.innerHTML = generateKelasHTML(i);
            contentContainer.appendChild(content);
            document.getElementById(`rombel-${i}-Tunggal`).style.display = 'block';
        }
        tabsContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('tab-link')) {
                document.querySelectorAll('.tab-link').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
                e.target.classList.add('active');
                document.getElementById(`kelas-content-${e.target.dataset.kelas}`).style.display = 'block';
            }
        });
        contentContainer.addEventListener('change', function(e) {
            const target = e.target;
            if (target.classList.contains('rombel-toggle')) {
                const kelas = target.dataset.kelas;
                const count = parseInt(target.value, 10);
                document.querySelectorAll(`#rombel-container-${kelas} .rombel-input-group`).forEach(el => el.style.display = 'none');
                if (count === 1) {
                    document.getElementById(`rombel-${kelas}-Tunggal`).style.display = 'block';
                } else if (count === 2) {
                    document.getElementById(`rombel-${kelas}-A`).style.display = 'block';
                    document.getElementById(`rombel-${kelas}-B`).style.display = 'block';
                } else if (count === 3) {
                    document.getElementById(`rombel-${kelas}-A`).style.display = 'block';
                    document.getElementById(`rombel-${kelas}-B`).style.display = 'block';
                    document.getElementById(`rombel-${kelas}-C`).style.display = 'block';
                }
            }
            if (target.classList.contains('agama-toggle')) {
                const kelas = target.dataset.kelas;
                const agama = target.dataset.agama;
                const show = target.value === 'Ada';
                document.getElementById(`agama-input-${kelas}-${agama}`).style.display = show ? 'grid' : 'none';
            }
        });
    }

    showAppModal('loading', 'Memuat data sekolah...');
    google.script.run
        .withSuccessHandler(schoolLists => {
            setupDataSekolah(schoolLists);
            setupDataMurid();
            document.getElementById('appModal').classList.remove('show');
        })
        .withFailureHandler(err => showAppModal('error', `Gagal memuat data sekolah: ${err.message}`))
        .getSdSchoolLists();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showAppModal('loading', 'Mengirim data dan mengunggah file...');
        const file = document.getElementById('fileLapbul').files[0];
        if (!file || file.size > 300 * 1024) {
            showAppModal('error', 'File PDF dengan ukuran maksimal 300 KB harus dipilih.');
            submitButton.disabled = false;
            return;
        }
        const reader = new FileReader();
        reader.onload = event => {
            const fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
            const formData = Object.fromEntries(new FormData(form));
            formData.fileData = fileData;
            google.script.run
                .withSuccessHandler(response => showAppModal('success', response, 'lapbul_riwayat'))
                .withFailureHandler(error => {
                    showAppModal('error', `Gagal: ${error.message}`);
                    submitButton.disabled = false;
                })
                .processLapbulFormSd(formData);
        };
        reader.readAsDataURL(file);
    });
}

function initLapbulRiwayatPage() {
    let allDataRows = [], headerCols = [], filterIndices = {}, currentPage = 1, rowsPerPage = 15, currentFilteredRows = [];
    let jenjangIndex = -1; // Variabel baru untuk menyimpan posisi kolom Jenjang

    function buildTable() {
        const tableBody = document.getElementById('lapbulRiwayatTable').querySelector('tbody');
        if (!tableBody) return;
        tableBody.innerHTML = '';
        const pageCount = Math.max(1, Math.ceil(currentFilteredRows.length / rowsPerPage));
        if (currentPage > pageCount) currentPage = pageCount;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = currentFilteredRows.slice(start, end);
        
        // Menghitung jumlah kolom yang akan ditampilkan (tanpa Jenjang)
        const visibleColsCount = jenjangIndex > -1 ? headerCols.length - 1 : headerCols.length;

        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${visibleColsCount + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
        } else {
            paginatedRows.forEach((cols, index) => {
                const tr = document.createElement('tr');
                let rowHTML = `<td>${start + index + 1}</td>`;
                cols.forEach((cellData, i) => {
                    // [KUNCI PERUBAHAN] Lewati (jangan render) sel jika itu adalah kolom Jenjang
                    if (i === jenjangIndex) return;

                    cellData = cellData || '-';
                    if (headerCols[i] === 'Dokumen' && typeof cellData === 'string' && cellData.startsWith('http')) {
                        rowHTML += `<td class="view-btn-container"><a href="${cellData}" target="_blank" class="action-btn view-btn"><i class="fas fa-eye"></i> Lihat</a></td>`;
                    } else {
                        rowHTML += `<td>${cellData}</td>`;
                    }
                });
                tr.innerHTML = rowHTML;
                tableBody.appendChild(tr);
            });
        }
        setupPagination();
    }
    
    function setupPagination() {
        // ... (Fungsi ini tidak perlu diubah)
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        if (pageCount <= 1) { paginationContainer.style.display = 'none'; return; }
        paginationContainer.style.display = 'flex';
        const pageInfo = document.createElement('span');
        pageInfo.className = 'page-info';
        pageInfo.textContent = `Halaman ${currentPage} dari ${pageCount}`;
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '«';
        prevBtn.className = 'page-btn';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; buildTable(); } };
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '»';
        nextBtn.className = 'page-btn';
        nextBtn.disabled = currentPage === pageCount;
        nextBtn.onclick = () => { if (currentPage < pageCount) { currentPage++; buildTable(); } };
        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
    }
    
    function applyFilters() {
        // ... (Fungsi ini tidak perlu diubah)
        const filterTahun = document.getElementById('filterTahun').value;
        const filterJenjang = document.getElementById('filterJenjang').value;
        const filterNama = document.getElementById('filterNamaSekolah').value;
        currentFilteredRows = allDataRows.filter(cols => {
            const tahunMatch = (filterTahun === "") || (String(cols[filterIndices.tahun]) === filterTahun);
            const jenjangMatch = (filterJenjang === "") || (String(cols[filterIndices.jenjang]) === filterJenjang);
            const namaMatch = (filterNama === "") || (String(cols[filterIndices.nama]) === filterNama);
            return tahunMatch && jenjangMatch && namaMatch;
        });
        currentPage = 1;
        buildTable();
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('lapbulRiwayatTable').querySelector('thead');
        if (!dataArray || dataArray.length < 2) {
            loadingStatus.innerHTML = "<p>Tidak ada data riwayat untuk ditampilkan.</p>"; return;
        }
        headerCols = dataArray[0].map(h => String(h).trim());
        allDataRows = dataArray.slice(1);

        // [KUNCI PERUBAHAN] Cari tahu di mana posisi kolom "Jenjang" berada
        jenjangIndex = headerCols.indexOf('Jenjang');

        const headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th>No.</th>';
        headerCols.forEach((header, i) => {
            // [KUNCI PERUBAHAN] Hanya tambahkan header ke tabel jika bukan "Jenjang"
            if (i !== jenjangIndex) {
                headerRow.innerHTML += `<th>${header}</th>`;
            }
        });
        tableHead.innerHTML = '';
        tableHead.appendChild(headerRow);
        
        rowsPerPage = calculateRowsPerPage('lapbulRiwayatTable');

        // Logika filter tetap sama, karena `headerCols` masih berisi "Jenjang"
        filterIndices = { tahun: headerCols.indexOf('Tahun'), jenjang: headerCols.indexOf('Jenjang'), nama: headerCols.indexOf('Nama Sekolah') };
        
        const populateFilter = (elementId, colIndex, sortReverse = false) => {
            const select = document.getElementById(elementId);
            if (!select) return;
            const uniqueValues = [...new Set(allDataRows.map(row => String(row[colIndex])))].filter(Boolean);
            select.innerHTML = `<option value="">Semua</option>`;
            let sortedValues = uniqueValues.sort();
            if (sortReverse) sortedValues.reverse();
            sortedValues.forEach(val => select.add(new Option(val, val)));
            select.addEventListener('change', applyFilters);
        };
        populateFilter('filterTahun', filterIndices.tahun, true);
        populateFilter('filterJenjang', filterIndices.jenjang);
        populateFilter('filterNamaSekolah', filterIndices.nama);
        
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'block';
        applyFilters();
    }

    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => { document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`; })
        .getLapbulRiwayatData();

    window.addEventListener('resize', debounce(() => { if (document.getElementById('lapbulRiwayatTable')) { rowsPerPage = calculateRowsPerPage('lapbulRiwayatTable'); buildTable(); } }));
}

function initLapbulStatusPage() {
    let allDataRows = [],
        headerCols = [],
        currentFilteredRows = [],
        currentPage = 1,
        rowsPerPage = 15;

    function buildTable() {
        const tableBody = document.getElementById('lapbulStatusTable').querySelector('tbody');
        const tableHead = document.getElementById('lapbulStatusTable').querySelector('thead');
        if (!tableBody || !tableHead) return;

        // [PERBAIKAN] Menambahkan header "No." secara manual
        let headerHTML = '<tr><th>No.</th>'; 
        headerCols.forEach(header => {
            headerHTML += `<th>${header}</th>`;
        });
        headerHTML += '</tr>';
        tableHead.innerHTML = headerHTML;

        tableBody.innerHTML = '';
        const pageCount = Math.max(1, Math.ceil(currentFilteredRows.length / rowsPerPage));
        if (currentPage > pageCount) currentPage = pageCount;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = currentFilteredRows.slice(start, end);

        // [PERBAIKAN] Menyesuaikan colspan jika tidak ada data
        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${headerCols.length + 1}">Tidak ada data yang cocok.</td></tr>`;
        } else {
            paginatedRows.forEach((rowData, index) => {
                const tr = document.createElement('tr');
                // [PERBAIKAN] Menambahkan sel untuk kolom "No."
                let rowHTML = `<td>${start + index + 1}</td>`; 
                rowData.values.forEach(cellData => {
                    let displayCell = cellData;
                    if (cellData === 'T') {
                        displayCell = '<span style="color: var(--color-green); font-weight: bold;">✓</span>';
                    } else if (cellData === 'F') {
                        displayCell = '<span style="color: var(--color-red); font-weight: bold;">✗</span>';
                    }
                    rowHTML += `<td>${displayCell || '-'}</td>`;
                });
                tr.innerHTML = rowHTML;
                tableBody.appendChild(tr);
            });
        }
        setupPagination();
    }
    
    function setupPagination() {
        // ... (fungsi ini tidak perlu diubah)
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        if (pageCount <= 1) {
            paginationContainer.style.display = 'none';
            return;
        }
        paginationContainer.style.display = 'flex';
        const pageInfo = document.createElement('span');
        pageInfo.className = 'page-info';
        pageInfo.textContent = `Halaman ${currentPage} dari ${pageCount}`;
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '«';
        prevBtn.className = 'page-btn';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
            if (currentPage > 1) { currentPage--; buildTable(); }
        };
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '»';
        nextBtn.className = 'page-btn';
        nextBtn.disabled = currentPage === pageCount;
        nextBtn.onclick = () => {
            if (currentPage < pageCount) { currentPage++; buildTable(); }
        };
        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
    }

    function applyFilters() {
        // ... (fungsi ini tidak perlu diubah)
        const filterTahun = document.getElementById('filterTahun').value;
        const filterJenjang = document.getElementById('filterJenjang').value;
        const filterStatus = document.getElementById('filterStatus').value;
        
        currentFilteredRows = allDataRows.filter(row => {
            const tahunMatch = (filterTahun === "") || (row.filters.tahun === filterTahun);
            const jenjangMatch = (filterJenjang === "") || (row.filters.jenjang === filterJenjang);
            const statusMatch = (filterStatus === "") || (row.filters.status === filterStatus);
            return tahunMatch && jenjangMatch && statusMatch;
        });
        currentPage = 1;
        buildTable();
    }

    function initializePage(serverData) {
        // ... (fungsi ini tidak perlu diubah)
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');

        if (serverData && serverData.error) {
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${serverData.error}</p>`;
            return;
        }
        if (!serverData || !serverData.rows || serverData.rows.length === 0) {
            loadingStatus.innerHTML = `<p>Tidak ada data status untuk ditampilkan.</p>`;
            return;
        }

        headerCols = serverData.headers;
        allDataRows = serverData.rows;
        rowsPerPage = calculateRowsPerPage('lapbulStatusTable');
        
        const populateFilter = (elementId, options) => {
            const select = document.getElementById(elementId);
            if (!select || !options) return;
            select.innerHTML = '<option value="">Semua</option>';
            options.forEach(opt => select.add(new Option(opt, opt)));
            select.addEventListener('change', applyFilters);
        };
        
        populateFilter('filterTahun', serverData.filters.tahun);
        populateFilter('filterJenjang', serverData.filters.jenjang);
        populateFilter('filterStatus', serverData.filters.status);
        
        const tahunSelect = document.getElementById('filterTahun');
        if (tahunSelect) {
            const currentYear = new Date().getFullYear().toString();
            if ([...tahunSelect.options].some(opt => opt.value === currentYear)) {
                tahunSelect.value = currentYear;
            }
        }
        
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'block';
        document.getElementById('pagination-container').style.display = 'flex';
        
        applyFilters();
    }

    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data dari server: ${error.message}</p>`;
        })
        .getLapbulStatusData();
}

function initLapbulArsipPage() {
    const FOLDER_IDS = {
        'KB': '18CxRT-eledBGRtHW1lFd2AZ8Bub6q5ra',
        'TK': '1WUNz_BSFmcwRVlrG67D2afm9oJ-bVI9H',
        'SD': '1I8DRQYpBbTt1mJwtD1WXVD6UK51TC8El'
    };

    let breadcrumbTrail = [];
    const viewContainer = document.getElementById('view-container');
    const breadcrumbDiv = document.getElementById('breadcrumb');

    function updateBreadcrumb() {
        const fragment = document.createDocumentFragment();
        breadcrumbTrail.forEach((item, index) => {
            if (index > 0) {
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                separator.style.margin = '0 5px';
                fragment.appendChild(separator);
            }
            const span = document.createElement('span');
            span.textContent = item.name;

            if (index < breadcrumbTrail.length - 1) {
                // --- PERBAIKAN LOGIKA DI SINI ---
                span.onclick = () => {
                    breadcrumbTrail.length = index; // Potong breadcrumb ke posisi yang diklik
                    // Cek apakah yang diklik adalah level root "Jenjang"
                    if (item.type === 'root') {
                        renderJenjangView(); // Jika ya, panggil fungsi untuk menampilkan jenjang
                    } else {
                        renderFolderView(item.id, item.name); // Jika tidak, panggil fungsi untuk folder biasa
                    }
                };
            } else {
                span.classList.add('inactive');
            }
            fragment.appendChild(span);
        });
        breadcrumbDiv.innerHTML = '';
        breadcrumbDiv.appendChild(fragment);
    }

    function showLoading() {
        viewContainer.innerHTML = '<div class="loading-container"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div><p>Memuat...</p></div>';
    }

    function renderJenjangView() {
        viewContainer.classList.remove('view-container-scrollable');
        // Saat kembali ke jenjang, reset breadcrumb ke kondisi awal
        breadcrumbTrail = [{ name: 'Jenjang', type: 'root', id: null }];
        updateBreadcrumb();
        viewContainer.innerHTML = '<div class="card-grid"></div>';
        const cardGrid = viewContainer.querySelector('.card-grid');
        
        const jenjang = [
            { name: 'KB', icon: 'fa-cubes', color: '#3498db' },
            { name: 'TK', icon: 'fa-shapes', color: '#9b59b6' },
            { name: 'SD', icon: 'fa-school', color: '#e74c3c' }
        ];

        jenjang.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.animationDelay = `${index * 0.05}s`;
            card.innerHTML = `<i class="fas ${item.icon}" style="color: ${item.color};"></i><span>${item.name}</span>`;
            card.onclick = () => renderFolderView(FOLDER_IDS[item.name], item.name);
            cardGrid.appendChild(card);
        });
    }

    function renderFolderView(folderId, folderName) {
        viewContainer.classList.remove('view-container-scrollable');
        // Hanya tambahkan ke breadcrumb jika belum ada
        if (breadcrumbTrail[breadcrumbTrail.length - 1].id !== folderId) {
            breadcrumbTrail.push({ name: folderName, id: folderId, type: 'folder' });
        }
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(folders => {
            if (!folders || folders.length === 0) {
                renderFileView(folderId, folderName);
            } else {
                viewContainer.innerHTML = '<div class="card-grid"></div>';
                const cardGrid = viewContainer.querySelector('.card-grid');
                folders.forEach((folder, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.innerHTML = `<i class="fas fa-folder-open"></i><span>${folder.name}</span>`;
                    card.onclick = () => renderFolderView(folder.id, folder.name);
                    cardGrid.appendChild(card);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat folder: ${err.message}</p>`;
        }).getFolders(folderId);
    }

    function renderFileView(folderId, folderName) {
        viewContainer.classList.add('view-container-scrollable');
        if (breadcrumbTrail[breadcrumbTrail.length - 1].id !== folderId) {
             breadcrumbTrail.push({ name: folderName, id: folderId, type: 'folder' });
        }
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(files => {
            if (!files || files.length === 0) {
                viewContainer.innerHTML = '<p>Tidak ada file ditemukan di folder ini.</p>';
            } else {
                viewContainer.innerHTML = '<div class="file-list-container"></div>';
                const fileList = viewContainer.querySelector('.file-list-container');
                files.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.style.animationDelay = `${index * 0.03}s`;
                    fileItem.innerHTML = `<i class="fas fa-file-pdf"></i><a href="${file.url}" target="_blank">${file.name}</a>`;
                    fileList.appendChild(fileItem);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat file: ${err.message}</p>`;
        }).getFiles(folderId);
    }
    
    renderJenjangView();
}

function initLapbulKelolaPage() {
    let allDataRows = [], allHeaders = [], currentFilteredRows = [], currentPage = 1, rowsPerPage = 15;

    function buildTable() {
        const tableBody = document.getElementById('lapbulKelolaTable').querySelector('tbody');
        if (!tableBody) return;
        tableBody.innerHTML = '';
        const pageCount = Math.max(1, Math.ceil(currentFilteredRows.length / rowsPerPage));
        if (currentPage > pageCount) currentPage = pageCount;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = currentFilteredRows.slice(start, end);

        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
        } else {
            paginatedRows.forEach((rowInfo, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${start + index + 1}</td>`; // Tambahkan sel No.

                // Loop melalui header dan buat setiap sel satu per satu
                allHeaders.forEach(header => {
                    const td = document.createElement('td');
                    let cellData = rowInfo.data[header];

                    if (header === 'Aksi') {
                        td.className = 'action-buttons';
                        const editPage = rowInfo.source === 'PAUD' ? 'lapbul_edit_paud' : 'lapbul_edit_sd';
                        
                        const editBtn = document.createElement('button');
                        editBtn.className = 'action-btn edit-btn';
                        editBtn.innerHTML = `<i class="fas fa-pencil-alt"></i> Edit`;
                        editBtn.onclick = (e) => loadPage(e, editPage, { rowIndex: rowInfo.rowIndex, source: rowInfo.source });
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'action-btn delete-btn';
                        deleteBtn.innerHTML = `<i class="fas fa-trash"></i> Hapus`;
                        deleteBtn.onclick = () => showDeleteConfirmation(rowInfo);
                        
                        td.appendChild(editBtn);
                        td.appendChild(deleteBtn);

                    } else if (header === 'Dokumen' && typeof cellData === 'string' && cellData.startsWith('http')) {
                        td.className = 'view-btn-container';
                        td.innerHTML = `<a href="${cellData}" target="_blank" class="action-btn view-btn"><i class="fas fa-eye"></i> Lihat</a>`;
                    
                    } else {
                        td.textContent = cellData || '-';
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
        setupPagination();
    }
    
    function setupPagination() {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        if (pageCount <= 1) { paginationContainer.style.display = 'none'; return; }
        paginationContainer.style.display = 'flex';
        const pageInfo = document.createElement('span');
        pageInfo.className = 'page-info';
        pageInfo.textContent = `Halaman ${currentPage} dari ${pageCount}`;
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '«';
        prevBtn.className = 'page-btn';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; buildTable(); } };
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '»';
        nextBtn.className = 'page-btn';
        nextBtn.disabled = currentPage === pageCount;
        nextBtn.onclick = () => { if (currentPage < pageCount) { currentPage++; buildTable(); } };
        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
    }
    
    // [KUNCI PERBAIKAN] Fungsi ini dikembalikan
    function updateNamaSekolahFilter() {
        const jenjangFilter = document.getElementById('filterJenjang').value;
        const namaSekolahFilter = document.getElementById('filterNamaSekolah');
        if (!namaSekolahFilter) return;
        
        // Simpan nilai yang sedang dipilih
        const currentNamaSekolah = namaSekolahFilter.value;

        const filteredData = (jenjangFilter === "") ? allDataRows : allDataRows.filter(row => row.data['Jenjang'] === jenjangFilter);
        const uniqueSekolah = [...new Set(filteredData.map(row => row.data['Nama Sekolah']))].filter(Boolean).sort();
        
        namaSekolahFilter.innerHTML = '<option value="">Semua</option>';
        uniqueSekolah.forEach(nama => { namaSekolahFilter.add(new Option(nama, nama)); });

        // Coba set kembali nilai yang tadi dipilih jika masih ada di opsi baru
        if ([...namaSekolahFilter.options].some(opt => opt.value === currentNamaSekolah)) {
            namaSekolahFilter.value = currentNamaSekolah;
        }
    }

    function applyFilters() {
        const filterTahun = document.getElementById('filterTahun').value;
        const filterJenjang = document.getElementById('filterJenjang').value;
        const filterNama = document.getElementById('filterNamaSekolah').value;
        
        currentFilteredRows = allDataRows.filter(row => {
            const tahunMatch = (filterTahun === "") || (String(row.data['Tahun']).trim() === filterTahun);
            const jenjangMatch = (filterJenjang === "") || (row.data['Jenjang'] === jenjangFilter);
            const namaMatch = (filterNama === "") || (row.data['Nama Sekolah'] === filterNama);
            return tahunMatch && jenjangMatch && namaMatch;
        });
        currentPage = 1;
        buildTable();
    }
    
    // [BARU] Fungsi-fungsi untuk proses penghapusan
    function showDeleteConfirmation(rowInfo) {
        const modal = document.getElementById('deleteModal');
        if (!modal) return;
        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');
        const cancelBtn = modal.querySelector('#cancelDeleteBtn');
        modalTitle.textContent = 'Konfirmasi Hapus';
        modalBody.innerHTML = `<p>Yakin ingin menghapus Laporan Bulan ini?</p><div style="font-weight: bold; margin: 15px 0; background:rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; line-height: 1.5; text-align: left;">Sekolah: ${rowInfo.data['Nama Sekolah']}<br>Bulan: ${rowInfo.data['Bulan']} ${rowInfo.data['Tahun']}</div>`;
        confirmBtn.style.display = 'inline-flex';
        confirmBtn.textContent = 'Ya, Hapus';
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.onclick = () => showDeletePrompt(rowInfo);
        cancelBtn.onclick = () => modal.classList.remove('show');
        modal.classList.add('show');
    }
 
    function showDeletePrompt(rowInfo) {
        const modal = document.getElementById('deleteModal');
        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');
        modalTitle.textContent = 'Masukkan Kode Hapus';
        modalBody.innerHTML = `<p>Kode hapus dapat ditanyakan ke admin Korwil.</p><input type="password" id="kodeHapusInput" class="custom-modal-input" autocomplete="off" placeholder="Masukkan Kode Hapus">`;
        confirmBtn.textContent = 'Konfirmasi & Hapus';
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.onclick = () => processDeletion(rowInfo);
        setTimeout(() => document.getElementById('kodeHapusInput').focus(), 100);
    }
 
    function processDeletion(rowInfo) {
        const deleteCode = document.getElementById('kodeHapusInput').value;
        if (!deleteCode) { 
            showAppModal('error', 'Kode hapus tidak boleh kosong.');
            return; 
        }
        showAppModal('loading', 'Menghapus data dan file terkait...');
        google.script.run
            .withSuccessHandler(response => {
                document.getElementById('deleteModal').classList.remove('show');
                showAppModal('success', response, 'lapbul_kelola'); // Muat ulang halaman setelah sukses
            })
            .withFailureHandler(error => showAppModal('error', error.message))
            .deleteLapbulData(rowInfo.rowIndex, rowInfo.source, deleteCode); // Panggil fungsi backend
    }

    function initializePage(serverData) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('lapbulKelolaTable').querySelector('thead');
        if (serverData.error || !serverData.rows || serverData.rows.length === 0) {
            loadingStatus.innerHTML = `<p>Tidak ada data untuk dikelola.</p>`; return;
        }
        allHeaders = serverData.headers;
        allDataRows = serverData.rows;
        const docIndex = allHeaders.indexOf('Dokumen');
        if (docIndex > -1) {
            allHeaders.splice(docIndex + 1, 0, 'Aksi');
        }
        tableHead.innerHTML = `<tr><th>No.</th>${allHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;
        rowsPerPage = calculateRowsPerPage('lapbulKelolaTable');
        const populateStaticFilter = (elementId, key, sortReverse = false) => {
            const select = document.getElementById(elementId);
            if (!select) return;
            const uniqueValues = [...new Set(allDataRows.map(row => row.data[key]))].filter(Boolean);
            let sorted = uniqueValues.sort();
            if (sortReverse) sorted.reverse();
            select.innerHTML = '<option value="">Semua</option>';
            sorted.forEach(val => select.add(new Option(val, val)));
        };
        populateStaticFilter('filterTahun', 'Tahun', true);
        populateStaticFilter('filterJenjang', 'Jenjang');
        document.getElementById('filterJenjang').addEventListener('change', () => {
            updateNamaSekolahFilter(); 
            applyFilters();
        });
        document.getElementById('filterNamaSekolah').addEventListener('change', applyFilters);
        document.getElementById('filterTahun').addEventListener('change', applyFilters);
        updateNamaSekolahFilter();
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'block';
        document.getElementById('pagination-container').style.display = 'flex';
        applyFilters();
    }
    
    // Panggilan eksekusi utama
    google.script.run
        .withFailureHandler(err => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Error komunikasi: ${err.message}</p>`;
        })
        .withSuccessHandler(initializePage)
        .getLapbulKelolaData();
}

function initLapbulEditPaudPage(params) {
    if (!params || !params.rowIndex) {
        document.getElementById('main-content').innerHTML = `<div class="error-box"><h3>Error</h3><p>Parameter untuk edit data tidak ditemukan.</p></div>`;
        return;
    }

    const form = document.getElementById('lapbulEditFormPaud');
    const loadingDiv = document.getElementById('loading-data');
    const formContainer = document.getElementById('edit-form-container');
    
    const lockField = (fieldName) => {
        const field = form.querySelector(`[name="${fieldName}"]`);
        if (field) {
            field.disabled = true;
            field.style.backgroundColor = 'rgba(0,0,0,0.3)';
            field.style.cursor = 'not-allowed';
            if (field.tagName === 'INPUT') field.readOnly = true;
        }
    };

    google.script.run
        .withSuccessHandler(rowData => {
            if (!rowData || Object.keys(rowData).length === 0) {
                loadingDiv.innerHTML = `<p style="color:red;">Gagal: Data untuk baris ${params.rowIndex} tidak ditemukan.</p>`;
                return;
            }
            
            form.querySelector('[name="rowIndex"]').value = params.rowIndex;

            const bulanSelect = form.querySelector('[name="Bulan"]');
            const tahunSelect = form.querySelector('[name="Tahun"]');
            const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            bulanSelect.innerHTML = bulanOptions.map(m => `<option value="${m}">${m}</option>`).join('');
            const currentYear = new Date().getFullYear();
            tahunSelect.innerHTML = [currentYear + 1, currentYear, currentYear - 1, currentYear - 2].map(y => `<option value="${y}">${y}</option>`).join('');
            
            for (const key in rowData) {
                const field = form.querySelector(`[name="${key}"]`);
                if (field) field.value = rowData[key];
            }
            
            lockField('Bulan');
            lockField('Tahun');
            lockField('Status');
            lockField('Jenjang');
            lockField('Nama Sekolah');

            const fileLinkContainer = document.getElementById('existingFileLink');
            if (rowData['Dokumen']) {
                 fileLinkContainer.innerHTML = `<a href="${rowData['Dokumen']}" target="_blank">Lihat File Saat Ini</a>`;
            } else {
                 fileLinkContainer.innerHTML = 'Tidak ada file.';
            }

            loadingDiv.style.display = 'none';
            formContainer.style.display = 'block';
        })
        .withFailureHandler(err => {
            loadingDiv.innerHTML = `<p style="color:red;">Gagal memuat data baris: ${err.message}</p>`;
        })
        .getLapbulDataByRow(params.rowIndex, params.source);

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showAppModal('loading', 'Menyimpan perubahan...');

        // --- PERBAIKAN UTAMA DI SINI ---
        // Buat objek payload baru dengan kunci yang benar (camelCase)
        const payload = {
            rowIndex: form.querySelector('[name="rowIndex"]').value,
            source: form.querySelector('[name="source"]').value,
            // Ambil nilai dari field yang terkunci
            laporanBulan: form.querySelector('[name="Bulan"]').value,
            tahun: form.querySelector('[name="Tahun"]').value,
            jenjang: form.querySelector('[name="Jenjang"]').value,
            namaSekolah: form.querySelector('[name="Nama Sekolah"]').value,
            // Ambil nilai dari field yang bisa diedit
            'NPSN': form.querySelector('[name="NPSN"]').value,
            'Jumlah Rombel': form.querySelector('[name="Jumlah Rombel"]').value,
            'Status': form.querySelector('[name="Status"]').value
            // Anda bisa menambahkan field lain yang bisa diedit di sini
        };

        const file = form.querySelector('input[type="file"]').files[0];

        const sendData = (data) => {
            google.script.run
                .withSuccessHandler(res => showAppModal('success', res, 'lapbul_kelola'))
                .withFailureHandler(err => {
                    showAppModal('error', err.message);
                    if (submitButton) submitButton.disabled = false;
                })
                .updateLapbulData(data);
        };

        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                payload.fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
                sendData(payload);
            };
            reader.readAsDataURL(file);
        } else {
            sendData(payload);
        }
    });
}

function initLapbulEditSdPage(params) {
    if (!params || !params.rowIndex) {
        document.getElementById('main-content').innerHTML = `<div class="error-box"><h3>Error</h3><p>Parameter untuk edit data tidak ditemukan.</p></div>`;
        return;
    }

    const form = document.getElementById('lapbulEditFormSd');
    const loadingDiv = document.getElementById('loading-data');
    const formContainer = document.getElementById('edit-form-container');

    // --- SEMUA FUNGSI BANTU SEKARANG ADA DI DALAM SATU FUNGSI INI ---
    function generateKelasHTML(kelas) {
        const rombels = ['A', 'B', 'C'];
        const agama = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
        let rombelInputsHTML = `<div class="rombel-input-group" id="rombel-${kelas}-Tunggal" style="display: none;"><label class="rombel-group-label">Kelas ${kelas}</label><div class="murid-input-pair"><div class="form-group"><label>Laki-laki</label><input type="number" name="K${kelas} L" value="0" min="0" required></div><div class="form-group"><label>Perempuan</label><input type="number" name="K${kelas} P" value="0" min="0" required></div></div></div>`;
        for (const rombel of rombels) {
            rombelInputsHTML += `<div class="rombel-input-group" id="rombel-${kelas}-${rombel}" style="display: none;"><label class="rombel-group-label">Kelas ${kelas}${rombel}</label><div class="murid-input-pair"><div class="form-group"><label>Laki-laki</label><input type="number" name="K${kelas}${rombel} L" value="0" min="0" required></div><div class="form-group"><label>Perempuan</label><input type="number" name="K${kelas}${rombel} P" value="0" min="0" required></div></div></div>`;
        }
        let agamaInputsHTML = '';
        for (const ag of agama) {
            const agId = ag;
            agamaInputsHTML += `<div class="form-grid agama-row"><div class="form-group"><label>${ag}</label><select class="agama-toggle" data-kelas="${kelas}" data-agama="${agId}"><option value="Ada">Ada</option><option value="Tidak Ada" selected>Tidak Ada</option></select></div><div class="agama-input-pair" id="agama-input-${kelas}-${agId}" style="display: none;"><div class="form-group"><label>Laki-laki</label><input type="number" name="K${kelas} ${agId} L" value="0" min="0" required></div><div class="form-group"><label>Perempuan</label><input type="number" name="K${kelas} ${agId} P" value="0" min="0" required></div></div></div>`;
        }
        return `<div class="form-grid"><div class="form-group"><label>Jumlah Rombel Kelas ${kelas}</label><select class="rombel-toggle" name="Rombel ${kelas}" data-kelas="${kelas}"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div></div><h4 class="sub-section-title">Jumlah Murid per Rombel</h4><div class="rombel-container" id="rombel-container-${kelas}">${rombelInputsHTML}</div><h4 class="sub-section-title">Jumlah Murid per Agama</h4><div class="agama-container">${agamaInputsHTML}</div>`;
    }
    function generatePtkNegeriHTML() {
        return `<fieldset class="ptk-fieldset"><legend>Data Jumlah PTK (Negeri)</legend><fieldset class="ptk-sub-fieldset"><legend>Kepala Sekolah</legend><div class="ptk-row ptk-grid-2"><div class="form-group"><label>PNS</label><input type="number" name="KS PNS" value="0" min="0" max="1"></div><div class="form-group"><label>PPPK</label><input type="number" name="KS PPPK" value="0" min="0" max="1"></div></div></fieldset><fieldset class="ptk-sub-fieldset"><legend>Guru</legend><div class="ptk-row has-label"><label>Guru Kelas</label><div class="form-group"><label>PNS</label><input type="number" name="GK PNS" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="GK PPPK" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="GK PPPK PW" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="GK GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru PAI</label><div class="form-group"><label>PNS</label><input type="number" name="GPAI PNS" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="GPAI PPPK" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="GPAI PPPK PW" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="GPAI GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru PJOK</label><div class="form-group"><label>PNS</label><input type="number" name="GPJOK PNS" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="GPJOK PPPK" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="GPJOK PPPK PW" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="GPJOK GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru PA Kristen</label><div class="form-group"><label>PNS</label><input type="number" name="GPAKris PNS" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="GPAKris PPPK" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="GPAKris PPPK PW" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="GPAKris GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru Bhs. Inggris</label><div class="form-group"><label>GTT</label><input type="number" name="GTT Inggris" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru Mapel Lainnya</label><div class="form-group"><label>GTT</label><input type="number" name="GTT Lain" value="0" min="0"></div></div></fieldset><fieldset class="ptk-sub-fieldset"><legend>Tenaga Kependidikan</legend><div class="ptk-row has-label"><label>Operator</label><div class="form-group"><label>PPPK</label><input type="number" name="OLO PPPK" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="OLO PPPK PW" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="OLO PTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Pengelola Umum</label><div class="form-group"><label>PPPK</label><input type="number" name="PUO PPPK" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="PUO PPPK PW" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="PUO PTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Penjaga Sekolah</label><div class="form-group"><label>PTT</label><input type="number" name="PTT Penjaga" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Tenaga Administrasi</label><div class="form-group"><label>PTT</label><input type="number" name="PTT Admin" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Pustakawan</label><div class="form-group"><label>PTT</label><input type="number" name="PTT Perpus" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Tendik Lainnya</label><div class="form-group"><label>PTT</label><input type="number" name="PTT Lain" value="0" min="0"></div></div></fieldset></fieldset>`;
    }
    function generatePtkSwastaHTML() {
        return `<fieldset class="ptk-fieldset"><legend>Data Jumlah PTK (Swasta)</legend><fieldset class="ptk-sub-fieldset"><legend>Kepala Sekolah</legend><div class="ptk-row ptk-grid-2"><div class="form-group"><label>GTY</label><input type="number" name="SDS KS GTY" value="0" min="0" max="1"></div><div class="form-group"><label>GTT</label><input type="number" name="SDS KS GTT" value="0" min="0" max="1"></div></div></fieldset><fieldset class="ptk-sub-fieldset"><legend>Guru</legend><div class="ptk-row has-label"><label>Guru Kelas</label><div class="form-group"><label>GTY</label><input type="number" name="SDS GK GTY" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="SDS GK GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru PAI</label><div class="form-group"><label>GTY</label><input type="number" name="SDS GPAI GTY" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="SDS GPAI GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru PJOK</label><div class="form-group"><label>GTY</label><input type="number" name="SDS GPJOK GTY" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="SDS GPJOK GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru PA Kristen</label><div class="form-group"><label>GTY</label><input type="number" name="SDS GKRIS GTY" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="SDS GKRIS GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru Bhs. Inggris</label><div class="form-group"><label>GTY</label><input type="number" name="SDS ING GTY" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="SDS ING GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru Mapel Lainnya</label><div class="form-group"><label>GTY</label><input type="number" name="SDS GLAIN GTY" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="SDS GLAIN GTT" value="0" min="0"></div></div></fieldset><fieldset class="ptk-sub-fieldset"><legend>Tenaga Kependidikan</legend><div class="ptk-row has-label"><label>Operator</label><div class="form-group"><label>PTY</label><input type="number" name="SDS OLO PTY" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="SDS OLO PTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Pengelola Umum</label><div class="form-group"><label>PTY</label><input type="number" name="SDS PUO PTY" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="SDS PUO PTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Penjaga Sekolah</label><div class="form-group"><label>PTY</label><input type="number" name="SDS Penjaga PTY" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="SDS Penjaga PTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Tenaga Administrasi</label><div class="form-group"><label>PTY</label><input type="number" name="SDS Admin PTY" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="SDS Admin PTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Pustakawan</label><div class="form-group"><label>PTY</label><input type="number" name="SDS Perpus PTY" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="SDS Perpus PTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Tendik Lainnya</label><div class="form-group"><label>PTY</label><input type="number" name="SDS Tendik Lain PTY" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="SDS Tendik Lain PTT" value="0" min="0"></div></div></fieldset></fieldset>`;
    }
    function setupFormUI() {
        const tabsContainer = document.getElementById('kelas-tabs');
        const contentContainer = document.getElementById('kelas-content-container');
        tabsContainer.innerHTML = ''; contentContainer.innerHTML = '';
        for (let i = 1; i <= 6; i++) {
            tabsContainer.innerHTML += `<button type="button" class="tab-link ${i === 1 ? 'active' : ''}" data-kelas="${i}">Kelas ${i}</button>`;
            const content = document.createElement('div');
            content.id = `kelas-content-${i}`; content.className = 'tab-content';
            content.style.display = i === 1 ? 'block' : 'none';
            content.innerHTML = generateKelasHTML(i);
            contentContainer.appendChild(content);
        }
        tabsContainer.addEventListener('click', function(e) { if (e.target.classList.contains('tab-link')) { document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none'); e.target.classList.add('active'); document.getElementById(`kelas-content-${e.target.dataset.kelas}`).style.display = 'block'; } });
        contentContainer.addEventListener('change', function(e) { 
            const t = e.target; 
            if (t.classList.contains('rombel-toggle')) { 
                const k = t.dataset.kelas, c = parseInt(t.value, 10); 
                document.querySelectorAll(`#rombel-container-${k} .rombel-input-group`).forEach(el => el.style.display = 'none'); 
                if (c === 1) { 
                    document.getElementById(`rombel-${k}-Tunggal`).style.display = 'block'; 
                } else if (c > 1) { 
                    ['A', 'B', 'C'].slice(0, c).forEach(r => {
                        const rombelEl = document.getElementById(`rombel-${k}-${r}`);
                        if (rombelEl) rombelEl.style.display = 'block';
                    });
                } 
            } 
            if (t.classList.contains('agama-toggle')) { 
                document.getElementById(`agama-input-${t.dataset.kelas}-${t.dataset.agama}`).style.display = t.value === 'Ada' ? 'grid' : 'none'; 
            } 
        });
        document.getElementById('ptk-section-container').innerHTML = `<div id="ptk-negeri" style="display:none;">${generatePtkNegeriHTML()}</div><div id="ptk-swasta" style="display:none;">${generatePtkSwastaHTML()}</div>`;
    }
    function lockField(fieldName) {
        const field = form.querySelector(`[name="${fieldName}"]`);
        if (field) { field.disabled = true; field.style.cssText = 'background-color: rgba(0,0,0,0.3); cursor: not-allowed;'; if (field.tagName === 'INPUT') field.readOnly = true; }
    }

    // --- PROSES UTAMA ---
    setupFormUI();

    google.script.run
        .withSuccessHandler(rowData => {
            if (!rowData || Object.keys(rowData).length === 0) {
                loadingDiv.innerHTML = `<p style="color:red;">Gagal: Data untuk baris ${params.rowIndex} tidak ditemukan.</p>`;
                return;
            }

            form.querySelector('[name="rowIndex"]').value = params.rowIndex;
            
            for (const header in rowData) {
                const fieldName = header.trim();
                const field = form.querySelector(`[name="${fieldName}"]`);
                if (field) {
                    let value = rowData[header];
                    if (field.type === 'number' && (value === '' || value === null || value === undefined)) {
                        value = '0';
                    }
                    field.value = value;
                }
            }
            
            const agama = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
            for (let i = 1; i <= 6; i++) {
                agama.forEach(ag => {
                    const L = parseInt(rowData[`K${i} ${ag} L`] || 0, 10);
                    const P = parseInt(rowData[`K${i} ${ag} P`] || 0, 10);
                    const selectAgama = form.querySelector(`.agama-toggle[data-kelas="${i}"][data-agama="${ag}"]`);
                    if (selectAgama) {
                        selectAgama.value = (L + P > 0) ? 'Ada' : 'Tidak Ada';
                    }
                });
            }

            form.querySelectorAll('select').forEach(select => {
                select.dispatchEvent(new Event('change', { bubbles: true }));
            });

            const bulanSelect = form.querySelector('[name="Bulan"]');
            const tahunSelect = form.querySelector('[name="Tahun"]');
            const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            bulanSelect.innerHTML = bulanOptions.map(m => `<option value="${m}">${m}</option>`).join('');
            const currentYear = new Date().getFullYear();
            tahunSelect.innerHTML = [currentYear + 1, currentYear, currentYear - 1, currentYear - 2].map(y => `<option value="${y}">${y}</option>`).join('');
            bulanSelect.value = rowData['Bulan'];
            tahunSelect.value = rowData['Tahun'];

            if (rowData['Status'] === 'Negeri') {
                document.getElementById('ptk-negeri').style.display = 'block';
            } else if (rowData['Status'] === 'Swasta') {
                document.getElementById('ptk-swasta').style.display = 'block';
            }

            lockField('Bulan'); lockField('Tahun'); lockField('Status'); lockField('Nama Sekolah');
            
            const fileLinkContainer = document.getElementById('existingFileLink');
            if (rowData['Dokumen']) { fileLinkContainer.innerHTML = `<a href="${rowData['Dokumen']}" target="_blank">Lihat File Saat Ini</a>`; } else { fileLinkContainer.innerHTML = 'Tidak ada file.'; }

            loadingDiv.style.display = 'none';
            formContainer.style.display = 'block';
        })
        .withFailureHandler(err => { loadingDiv.innerHTML = `<p style="color:red;">Gagal memuat data baris: ${err.message}</p>`; })
        .getLapbulDataByRow(params.rowIndex, params.source);

    form.addEventListener('submit', function (e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showAppModal('loading', 'Menyimpan perubahan...');
        
        const payload = {};
        const allFields = form.querySelectorAll('input, select, textarea');
        allFields.forEach(field => {
            if (field.name) {
                payload[field.name] = field.value;
            }
        });
        
        payload.laporanBulan = form.querySelector('[name="Bulan"]').value;
        payload.tahun = form.querySelector('[name="Tahun"]').value;
        payload.namaSekolah = form.querySelector('[name="Nama Sekolah"]').value;

        const file = form.querySelector('input[type="file"]').files[0];

        const sendData = (data) => {
            google.script.run
                .withSuccessHandler(res => {
                    if (res && res.error) {
                         showAppModal('error', res.error);
                         if (submitButton) submitButton.disabled = false;
                    } else {
                         showAppModal('success', res, 'lapbul_kelola');
                    }
                })
                .withFailureHandler(err => {
                    showAppModal('error', err.message);
                    if (submitButton) submitButton.disabled = false;
                })
                .updateLapbulData(data);
        };

        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                payload.fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
                sendData(payload);
            };
            reader.readAsDataURL(file);
        } else {
            sendData(payload);
        }
      });
  }

function initLapbulUnduhFormatPage() {
    // Jalankan animasi untuk tombol Unduh
    initSubMenuPage();

    const infoBtn = document.getElementById('infoDropdownBtn');
    const contentDiv = document.getElementById('infoDropdownContent');

    if (!infoBtn || !contentDiv) return;

    let isDataLoaded = false;

    infoBtn.onclick = function() {
        // Toggle (buka/tutup) dropdown
        const isOpen = this.classList.toggle('active');
        contentDiv.style.maxHeight = isOpen ? contentDiv.scrollHeight + "px" : "0px";

        // Jika dropdown dibuka dan data belum dimuat, panggil server
        if (isOpen && !isDataLoaded) {
            google.script.run
                .withSuccessHandler(infoItems => {
                    if (infoItems && infoItems.length > 0) {
                        const infoContent = `
                            <ul style="text-align: left; padding: 10px 20px 10px 35px; line-height: 1.6; margin: 0;">
                                ${infoItems.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        `;
                        contentDiv.innerHTML = infoContent;
                    } else {
                        contentDiv.innerHTML = '<p style="padding: 15px;">Informasi tidak ditemukan.</p>';
                    }
                    // Sesuaikan kembali tinggi dropdown setelah konten dimuat
                    contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                    isDataLoaded = true;
                })
                .withFailureHandler(err => {
                    contentDiv.innerHTML = `<p style="color:red; padding: 15px;">Gagal memuat: ${err.message}</p>`;
                    contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                })
                .getUnduhFormatInfo();
        }
    };
}

// --- Modul Data PTK ---

function initPtkKeadaanPaudPage() {
    let allDataRows = [], headerCols = [], filterIndices = {}, currentFilteredRows = [];

    function buildTable() {
        const tableBody = document.getElementById('keadaanPtkPaudTable').querySelector('tbody');
        const tableFoot = document.getElementById('keadaanPtkPaudTable').querySelector('tfoot');
        if (!tableBody || !tableFoot) return;

        tableBody.innerHTML = '';
        tableFoot.innerHTML = ''; 

        const namaSekolahIndex = headerCols.indexOf('Nama Sekolah');
        const jmlPtkIndex = headerCols.indexOf('JML PTK');

        if (currentFilteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${headerCols.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }
        
        // Render baris data
        currentFilteredRows.forEach((cols, index) => {
            const tr = document.createElement('tr');
            let rowHTML = `<td>${index + 1}</td>`;
            cols.forEach((cellData, colIndex) => {
                let displayData = (String(cellData) === '0' || !cellData) ? '-' : cellData;
                let cellClasses = [];
                if (colIndex === namaSekolahIndex) cellClasses.push('cell-align-left');
                if (colIndex === jmlPtkIndex) cellClasses.push('cell-font-bold');
                const classString = cellClasses.length > 0 ? ` class="${cellClasses.join(' ')}"` : '';
                rowHTML += `<td${classString}>${displayData}</td>`;
            });
            tr.innerHTML = rowHTML;
            tableBody.appendChild(tr);
        });

        // --- Logika Baru untuk Baris "Jumlah" ---
        const totals = new Array(headerCols.length).fill(0);
        const sumStartIndex = headerCols.indexOf('Jumlah Rombel');

        currentFilteredRows.forEach(row => {
            // Memastikan penjumlahan hanya untuk data numerik
            for (let i = sumStartIndex; i < headerCols.length; i++) {
                const value = parseInt(row[i], 10);
                if (!isNaN(value)) totals[i] += value;
            }
        });

        let totalRowHTML = '<tr>';
        totalRowHTML += '<td>-</td>'; // Sel untuk kolom "No."

        headerCols.forEach((header, i) => {
            if (i === namaSekolahIndex) {
                totalRowHTML += '<td class="cell-align-left">JUMLAH</td>';
            } else if (i >= sumStartIndex) {
                const totalClass = (i === jmlPtkIndex) ? ' class="cell-font-bold"' : '';
                totalRowHTML += `<td${totalClass}>${totals[i] || '-'}</td>`;
            } else {
                totalRowHTML += '<td>-</td>';
            }
        });

        totalRowHTML += '</tr>';
        tableFoot.innerHTML = totalRowHTML;
    }
    
    function applyFilters() {
        const filterJenjang = document.getElementById('filterJenjang').value;
        currentFilteredRows = allDataRows.filter(cols => {
            const jenjangMatch = (filterJenjang === "") || (filterIndices.jenjang === -1) || (String(cols[filterIndices.jenjang]) === filterJenjang);
            return jenjangMatch;
        });
        buildTable();
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('keadaanPtkPaudTable').querySelector('thead');

        if (!dataArray || dataArray.length < 2) {
            loadingStatus.innerHTML = "<p>Tidak ada data untuk ditampilkan.</p>"; 
            return;
        }

        headerCols = dataArray[0];
        allDataRows = dataArray.slice(1);
        
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th>No.</th>' + headerCols.map(header => `<th>${header}</th>`).join('');
        tableHead.innerHTML = '';
        tableHead.appendChild(headerRow);
        
        filterIndices = { jenjang: headerCols.indexOf('Jenjang') };
        
        const jenjangSelect = document.getElementById('filterJenjang');
        if (jenjangSelect && filterIndices.jenjang !== -1) {
            const uniqueValues = [...new Set(allDataRows.map(row => String(row[filterIndices.jenjang])))];
            jenjangSelect.innerHTML = `<option value="">Semua</option>`;
            uniqueValues.sort().forEach(val => { 
                if(val && val.trim() !== '') jenjangSelect.add(new Option(val, val)); 
            });
            jenjangSelect.addEventListener('change', applyFilters);
        }
        
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'block';
        applyFilters();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getKeadaanPtkPaudData();
}

function initPtkKeadaanSdPage() {
    let allDataRows = [], headerRow1 = [], headerRow2 = [], filterIndices = {}, currentFilteredRows = [];
    
    // Objek untuk memetakan header ke kelas CSS
    const colorMapping = {
        'Kepala Sekolah': 'ptk-sd-color-ks',
        'Guru Kelas': 'ptk-sd-color-guru-utama',
        'Guru PAI': 'ptk-sd-color-guru-utama',
        'Guru PJOK': 'ptk-sd-color-guru-utama',
        'Guru PA Kristen': 'ptk-sd-color-guru-utama',
        'Guru B. Inggris': 'ptk-sd-color-guru-lain',
        'Guru Mapel Lain': 'ptk-sd-color-guru-lain',
        'Operator Layanan Operasional': 'ptk-sd-color-operator',
        'Pengelola Umum Operasional': 'ptk-sd-color-pengelola',
        'Penjaga': 'ptk-sd-color-tendik-lain',
        'Tenaga Administrasi': 'ptk-sd-color-tendik-lain',
        'Pustakawan': 'ptk-sd-color-tendik-lain',
        'Tendik Lainnya': 'ptk-sd-color-tendik-lain',
        // KODE BARU DITAMBAHKAN DI SINI
        'Jumlah Seluruh PTK': 'ptk-sd-color-total'
    };

    function buildTable() {
        const table = document.getElementById('keadaanPtkSdTable');
        const tableHead = table.querySelector('thead');
        const tableBody = table.querySelector('tbody');
        const tableFoot = table.querySelector('tfoot');
        if (!tableBody || !tableFoot || !tableHead) return;

        // --- Membangun Header ---
        let firstRowHTML = '<th rowspan="2">No.</th>';
        let secondRowHTML = '';
        let headerClasses = new Array(headerRow1.length).fill('');
        let i = 0;
        while (i < headerRow1.length) {
            const topHeader = headerRow1[i];
            const isGroupHeader = topHeader && (i + 1 < headerRow1.length && !headerRow1[i + 1]);
            
            // Logika untuk memberikan warna pada header
            let currentClass = colorMapping[topHeader] || '';

            if (isGroupHeader) {
                let colspan = 1;
                while ((i + colspan) < headerRow1.length && !headerRow1[i + colspan]) {
                    headerClasses[i + colspan - 1] = currentClass;
                    colspan++;
                }
                headerClasses[i + colspan - 1] = currentClass;
                firstRowHTML += `<th colspan="${colspan}" class="${currentClass}">${topHeader}</th>`;
                for (let j = 0; j < colspan; j++) {
                    secondRowHTML += `<th class="${currentClass}">${headerRow2[i + j]}</th>`;
                }
                i += colspan;
            } else {
                // Terapkan juga untuk header yang tidak berkelompok
                headerClasses[i] = currentClass;
                firstRowHTML += `<th rowspan="2" class="${currentClass}">${topHeader}</th>`;
                i++;
            }
        }
        tableHead.innerHTML = `<tr>${firstRowHTML}</tr><tr>${secondRowHTML}</tr>`;
        
        // --- Membangun Isi Tabel (Body) ---
        tableBody.innerHTML = '';
        if (currentFilteredRows.length === 0) {
            const colspan = headerRow1.length + 1;
            tableBody.innerHTML = `<tr><td colspan="${colspan}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            tableFoot.innerHTML = '';
            return;
        }
        
        currentFilteredRows.forEach((row, index) => {
            let bodyRowHTML = `<td>${index + 1}</td>`;
            row.forEach((cell, cellIndex) => {
                bodyRowHTML += `<td class="${headerClasses[cellIndex] || ''}">${(cell === '0' || cell === '') ? '-' : cell}</td>`;
            });
            tableBody.innerHTML += `<tr>${bodyRowHTML}</tr>`;
        });

        // --- Membangun Baris Jumlah (Footer) ---
        const totals = new Array(headerRow1.length).fill(0);
        currentFilteredRows.forEach(row => {
            for (let i = 4; i < headerRow1.length; i++) {
                const value = parseInt(row[i], 10);
                if (!isNaN(value)) totals[i] += value;
            }
        });
        
        let totalRowHTML = '<tr>';
        totalRowHTML += '<td>-</td>';
        totalRowHTML += '<td class="cell-align-left">JUMLAH</td>';
        totalRowHTML += '<td>-</td><td>-</td><td>-</td>';
        
        for (let i = 4; i < totals.length; i++) {
            totalRowHTML += `<td class="${headerClasses[i] || ''}">${totals[i] || '-'}</td>`;
        }
        totalRowHTML += '</tr>';
        tableFoot.innerHTML = totalRowHTML;
    }
    
    function applyFilters() {
        const filterStatus = document.getElementById('filterStatusSekolah').value;
        currentFilteredRows = allDataRows.filter(row => {
            return (filterStatus === "") || (filterIndices.status === -1) || (String(row[filterIndices.status]) === filterStatus);
        });
        buildTable();
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');

        if (!dataArray || dataArray.length < 3) {
            loadingStatus.innerHTML = "<p>Data tidak lengkap atau tidak ditemukan.</p>"; 
            return;
        }

        headerRow1 = dataArray[0];
        headerRow2 = dataArray[1];
        allDataRows = dataArray.slice(2);

        filterIndices = { status: headerRow1.indexOf('Status') };
        
        const statusSelect = document.getElementById('filterStatusSekolah');
        if (statusSelect && filterIndices.status !== -1) {
            const uniqueValues = [...new Set(allDataRows.map(row => String(row[filterIndices.status])))];
            statusSelect.innerHTML = `<option value="">Semua</option>`;
            uniqueValues.sort().forEach(val => { 
                if(val && val.trim() !== '') statusSelect.add(new Option(val, val)); 
            });
            statusSelect.addEventListener('change', applyFilters);
        }
        
        loadingStatus.style.display = 'none';
        document.querySelector('.filter-container').style.display = 'flex';
        tableWrapper.style.display = 'block';
        applyFilters();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getKeadaanPtkSdData();
}

function initPtkJumlahBulananPaudPage() {
    let allDataRows = [], headerCols = [], filterIndices = {}, currentFilteredRows = [];
    let hiddenColumnIndices = [];

    // [SOLUSI DEFINITIF] Logika buildTable kini meniru 'Keadaan PTK PAUD' - tanpa paginasi.
    function buildTable() {
        const tableBody = document.getElementById('ptkJumlahBulananPaudTable').querySelector('tbody');
        const tableFoot = document.getElementById('ptkJumlahBulananPaudTable').querySelector('tfoot');
        if (!tableBody || !tableFoot) return;

        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        tableFoot.classList.remove('has-content');

        const visibleColsCount = headerCols.length - hiddenColumnIndices.length;

        if (currentFilteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${visibleColsCount + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }
        
        const jmlPtkIndex = headerCols.indexOf('JML PTK');

        // Menampilkan SEMUA baris yang sudah difilter, tanpa paginasi
        currentFilteredRows.forEach((cols, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${index + 1}</td>`;
            cols.forEach((cellData, i) => {
                if (hiddenColumnIndices.includes(i)) return;
                const displayData = (cellData === '0' || !cellData) ? '-' : cellData;
                const isBold = (i === jmlPtkIndex) ? ' class="cell-font-bold"' : '';
                tr.innerHTML += `<td${isBold}>${displayData}</td>`;
            });
            tableBody.appendChild(tr);
        });

        // Logika untuk baris jumlah (tfoot) tidak berubah
        const totals = new Array(headerCols.length).fill(0);
        const sumStartIndex = headerCols.indexOf('Jumlah Rombel');
        currentFilteredRows.forEach(row => {
            for (let i = sumStartIndex; i < headerCols.length; i++) {
                if (!isNaN(parseInt(row[i], 10))) totals[i] += parseInt(row[i], 10);
            }
        });

        const totalRow = document.createElement('tr');
        totalRow.innerHTML = '<td>-</td>';
        headerCols.forEach((header, i) => {
            if (hiddenColumnIndices.includes(i)) return;
            let cellHTML = '<td>-</td>';
            if (i === headerCols.indexOf('Nama Sekolah')) {
                cellHTML = '<td style="text-align: left;">JUMLAH</td>';
            } else if (i >= sumStartIndex) {
                const isBold = (i === jmlPtkIndex) ? ' class="cell-font-bold"' : '';
                cellHTML = `<td${isBold}>${totals[i] || '-'}</td>`;
            }
            totalRow.innerHTML += cellHTML;
        });
        tableFoot.appendChild(totalRow);
    }
    
    function applyFilters() {
        const filterTahun = document.getElementById('filterTahun').value;
        const filterBulan = document.getElementById('filterBulan').value;
        const filterJenjang = document.getElementById('filterJenjang').value;
        currentFilteredRows = allDataRows.filter(cols => {
            const tahunMatch = (filterTahun === "") || (String(cols[filterIndices.tahun]) === filterTahun);
            const bulanMatch = (filterBulan === "") || (String(cols[filterIndices.bulan]) === filterBulan);
            const jenjangMatch = (filterJenjang === "") || (String(cols[filterIndices.jenjang]) === filterJenjang);
            return tahunMatch && bulanMatch && jenjangMatch;
        });
        buildTable();
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('ptkJumlahBulananPaudTable').querySelector('thead');
        if (!dataArray || dataArray.length < 2) {
            loadingStatus.innerHTML = "<p>Tidak ada data untuk ditampilkan.</p>"; return;
        }

        headerCols = dataArray[0];
        allDataRows = dataArray.slice(1);
        hiddenColumnIndices = [headerCols.indexOf('Tahun'), headerCols.indexOf('Bulan')];
        
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th>No.</th>' + headerCols.filter((h, i) => !hiddenColumnIndices.includes(i)).map(header => `<th>${header}</th>`).join('');
        tableHead.innerHTML = ''; tableHead.appendChild(headerRow);
        
        filterIndices = { tahun: headerCols.indexOf('Tahun'), bulan: headerCols.indexOf('Bulan'), jenjang: headerCols.indexOf('Jenjang')};
        
        const populateFilter = (elementId, colIndex, sortReverse = false) => {
            const select = document.getElementById(elementId);
            if (!select || colIndex === -1) return;
            const uniqueValues = [...new Set(allDataRows.map(row => String(row[colIndex])))];
            select.innerHTML = `<option value="">Semua</option>`;
            let sorted = uniqueValues.sort((a, b) => {
                if (elementId === 'filterBulan') {
                    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                    return monthNames.indexOf(a) - monthNames.indexOf(b);
                }
                return a.localeCompare(b, undefined, {numeric: true});
            });
            if (sortReverse) sorted.reverse();
            sorted.forEach(val => select.add(new Option(val, val)));
            select.addEventListener('change', applyFilters);
        };
        
        populateFilter('filterTahun', filterIndices.tahun, true);
        populateFilter('filterBulan', filterIndices.bulan);
        populateFilter('filterJenjang', filterIndices.jenjang);

        const d = new Date();
        const currentYear = d.getFullYear().toString();
        const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const lastMonthName = monthNames[prevMonthIndex];

        const tahunSelect = document.getElementById('filterTahun');
        if (tahunSelect && [...tahunSelect.options].some(opt => opt.value === currentYear)) {
            tahunSelect.value = currentYear;
        }
        const bulanSelect = document.getElementById('filterBulan');
        if (bulanSelect && [...bulanSelect.options].some(opt => opt.value === lastMonthName)) {
            bulanSelect.value = lastMonthName;
        }

        applyFilters(); 
        
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'block';
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => { document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`; })
        .getJumlahPtkPaudBulananData();
}

function initPtkDaftarPaudPage() {
    let allDataRows = [], headerCols = [], currentFilteredRows = [], currentPage = 1, rowsPerPage = 15;
    let filterIndices = {};
    let hiddenColumnIndices = [];

    // [PERBAIKAN FINAL] Menggunakan metode perhitungan dari halaman 'Kelola PTK PAUD'
    function calculateRowsPerPage() {
        const tableContainer = document.querySelector('.table-container');
        if (!tableContainer) return 15;
        const rowHeight = 40; // Ketinggian baris tetap sebagai dasar pembagian
        
        // Menghitung sisa ruang dengan mengurangi posisi atas tabel dari total tinggi jendela
        const availableHeight = window.innerHeight - tableContainer.getBoundingClientRect().top - 160; 
        
        return Math.max(5, Math.floor(availableHeight / rowHeight));
    }

    function buildTable() {
        const tableBody = document.getElementById('daftarPtkPaudTable').querySelector('tbody');
        if (!tableBody) return;

        const visibleColsCount = headerCols.length - hiddenColumnIndices.length;
        
        tableBody.innerHTML = '';
        const pageCount = Math.max(1, Math.ceil(currentFilteredRows.length / rowsPerPage));
        if (currentPage > pageCount) currentPage = pageCount;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = currentFilteredRows.slice(start, end);

        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${visibleColsCount + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
        } else {
            paginatedRows.forEach((cols, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${start + index + 1}</td>`;
                cols.forEach((cellData, i) => {
                    if (hiddenColumnIndices.includes(i)) return;
                    tr.innerHTML += `<td>${cellData || '-'}</td>`;
                });
                tableBody.appendChild(tr);
            });
        }
        setupPagination();
    }
    
    function setupPagination() {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        if (pageCount <= 1) { paginationContainer.style.display = 'none'; return; }
        paginationContainer.style.display = 'flex';
        const pageInfo = document.createElement('span');
        pageInfo.className = 'page-info';
        pageInfo.textContent = `Halaman ${currentPage} dari ${pageCount}`;
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '«'; prevBtn.className = 'page-btn';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; buildTable(); } };
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '»'; nextBtn.className = 'page-btn';
        nextBtn.disabled = currentPage === pageCount;
        nextBtn.onclick = () => { if (currentPage < pageCount) { currentPage++; buildTable(); } };
        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
    }
    
    function applyFilters() {
        const filterJenjang = document.getElementById('filterJenjang').value;
        const filterNamaLembaga = document.getElementById('filterNamaLembaga').value;
        const filterStatus = document.getElementById('filterStatus').value;
        
        currentFilteredRows = allDataRows.filter(cols => {
            const jenjangMatch = (filterJenjang === "") || (String(cols[filterIndices.jenjang]) === filterJenjang);
            const namaLembagaMatch = (filterNamaLembaga === "") || (String(cols[filterIndices.namaLembaga]) === filterNamaLembaga);
            const statusMatch = (filterStatus === "") || (String(cols[filterIndices.status]) === filterStatus);
            return jenjangMatch && namaLembagaMatch && statusMatch;
        });
        currentPage = 1;
        buildTable();
    }
    
    function updateNamaLembagaFilter() {
        const jenjangFilter = document.getElementById('filterJenjang').value;
        const namaLembagaFilter = document.getElementById('filterNamaLembaga');
        
        const filteredData = (jenjangFilter === "") ? allDataRows : allDataRows.filter(row => row[filterIndices.jenjang] === jenjangFilter);
        const uniqueLembaga = [...new Set(filteredData.map(row => row[filterIndices.namaLembaga]))].filter(Boolean).sort();
        
        namaLembagaFilter.innerHTML = '<option value="">Semua</option>';
        uniqueLembaga.forEach(nama => namaLembagaFilter.add(new Option(nama, nama)));
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('daftarPtkPaudTable').querySelector('thead');
        if (!dataArray || dataArray.length < 2) {
            loadingStatus.innerHTML = "<p>Tidak ada data untuk ditampilkan.</p>"; return;
        }

        headerCols = dataArray[0];
        allDataRows = dataArray.slice(1);
        
        filterIndices = { jenjang: 0, namaLembaga: 1, status: 3 };
        hiddenColumnIndices = [0, 1, 3];
        
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th>No.</th>' + headerCols.filter((h, i) => !hiddenColumnIndices.includes(i)).map(header => `<th>${header}</th>`).join('');
        tableHead.innerHTML = ''; tableHead.appendChild(headerRow);
        
        const jenjangSelect = document.getElementById('filterJenjang');
        const uniqueJenjang = [...new Set(allDataRows.map(row => row[filterIndices.jenjang]))].filter(Boolean).sort();
        jenjangSelect.innerHTML = `<option value="">Semua</option>`;
        uniqueJenjang.forEach(val => jenjangSelect.add(new Option(val, val)));

        const statusSelect = document.getElementById('filterStatus');
        const uniqueStatus = [...new Set(allDataRows.map(row => row[filterIndices.status]))].filter(Boolean).sort();
        statusSelect.innerHTML = `<option value="">Semua</option>`;
        uniqueStatus.forEach(val => statusSelect.add(new Option(val, val)));
        statusSelect.addEventListener('change', applyFilters);

        jenjangSelect.addEventListener('change', () => {
            updateNamaLembagaFilter();
            applyFilters();
        });
        document.getElementById('filterNamaLembaga').addEventListener('change', applyFilters);

        updateNamaLembagaFilter();
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'block';
        
        // Panggil kalkulasi setelah semua elemen filter dan tabel siap
        rowsPerPage = calculateRowsPerPage();
        applyFilters();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => { document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`; })
        .getDaftarPtkPaudData();
}

function initPtkKelolaPaudPage() {
    let allDataRows = [], currentFilteredRows = [], currentPage = 1, rowsPerPage = 15;

    // [BARU] Fungsi untuk menampilkan konfirmasi Hapus (Modal Pertama)
    function showDeleteConfirmationPtk(rowInfo) {
        const modal = document.getElementById('deleteModal');
        if (!modal) return;
        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');
        
        modalTitle.textContent = 'Konfirmasi Hapus';
        modalBody.innerHTML = `<p>Apakah Anda yakin ingin menghapus data PTK ini?</p>
                             <div style="font-weight: bold; margin: 15px 0; background:rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; line-height: 1.5; text-align: left;">
                               Nama: ${rowInfo.data['Nama']}<br>Lembaga: ${rowInfo.data['Nama Lembaga']}
                             </div>`;
        
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.textContent = 'Ya, Hapus';
        newConfirmBtn.onclick = () => showDeletePromptPtk(rowInfo); // Lanjut ke modal kedua

        modal.querySelector('#cancelDeleteBtn').onclick = () => modal.classList.remove('show');
        modal.classList.add('show');
    }

    // [BARU] Fungsi untuk menampilkan modal input kode hapus (Modal Kedua)
    function showDeletePromptPtk(rowInfo) {
        const modal = document.getElementById('deleteModal');
        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');

        modalTitle.textContent = 'Masukkan Kode Hapus';
        modalBody.innerHTML = `<p>Hubungi admin Korwil untuk mendapatkan kode.</p>
                             <input type="password" id="kodeHapusInput" class="custom-modal-input" autocomplete="off" placeholder="Masukkan Kode Hapus">`;
        
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.textContent = 'Konfirmasi & Hapus';
        newConfirmBtn.onclick = () => processFinalPtkDeletion(rowInfo);

        setTimeout(() => document.getElementById('kodeHapusInput').focus(), 100);
    }

    // [BARU] Fungsi untuk memproses penghapusan final
    function processFinalPtkDeletion(rowInfo) {
        const deleteCode = document.getElementById('kodeHapusInput').value;
        if (!deleteCode) {
            alert('Kode hapus tidak boleh kosong.');
            return;
        }

        showAppModal('loading', 'Menghapus data...');
        google.script.run
            .withSuccessHandler(response => {
                document.getElementById('deleteModal').classList.remove('show');
                showAppModal('success', response, 'ptk_kelola_paud');
            })
            .withFailureHandler(error => showAppModal('error', error.message))
            .deletePtkPaudData(rowInfo.rowIndex, deleteCode);
    }

    function calculateRowsPerPage() {
        const tableContainer = document.querySelector('.table-container');
        if (!tableContainer) return 15;
        const rowHeight = 40;
        const availableHeight = window.innerHeight - tableContainer.getBoundingClientRect().top - 160;
        return Math.max(5, Math.floor(availableHeight / rowHeight));
    }

    function buildTable() {
        const tbody = document.querySelector('#kelolaPtkPaudTable tbody');
        tbody.innerHTML = '';
        const start = (currentPage - 1) * rowsPerPage;
        const paginated = currentFilteredRows.slice(start, start + rowsPerPage);

        if (paginated.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9">Tidak ada data yang cocok.</td></tr>`;
            return;
        }

        paginated.forEach((rowInfo, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${start + index + 1}</td>
                <td>${rowInfo.data['Nama'] || '-'}</td>
                <td>${rowInfo.data['Nama Lembaga'] || '-'}</td>
                <td>${rowInfo.data['Status'] || '-'}</td>
                <td>${rowInfo.data['NIP/NIY'] || '-'}</td>
                <td>${rowInfo.data['Jabatan'] || '-'}</td>
                <td class="action-buttons">
                    <button class="action-btn edit-btn"><i class="fas fa-pencil-alt"></i> Edit</button>
                    <button class="action-btn delete-btn"><i class="fas fa-trash"></i> Hapus</button>
                </td>
                <td>${rowInfo.data['Tanggal Input'] || '-'}</td>
                <td>${rowInfo.data['Update'] || '-'}</td>
            `;
            
            // [PERBAIKAN] Fungsikan tombol setelah baris dibuat
            tr.querySelector('.edit-btn').onclick = (e) => loadPage(e, 'ptk_edit_paud', { rowIndex: rowInfo.rowIndex });
            tr.querySelector('.delete-btn').onclick = () => showDeleteConfirmationPtk(rowInfo);

            tbody.appendChild(tr);
        });

        setupPagination();
    }

    function setupPagination() {
        const container = document.getElementById('pagination-container');
        container.innerHTML = '';
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        if (pageCount <= 1) { container.style.display = 'none'; return; }
        container.style.display = 'flex';

        const prev = document.createElement('button');
        prev.textContent = '«';
        prev.className = 'page-btn';
        prev.disabled = currentPage === 1;
        prev.onclick = () => { currentPage--; buildTable(); };

        const info = document.createElement('span');
        info.className = 'page-info';
        info.textContent = `Halaman ${currentPage} dari ${pageCount}`;

        const next = document.createElement('button');
        next.textContent = '»';
        next.className = 'page-btn';
        next.disabled = currentPage === pageCount;
        next.onclick = () => { currentPage++; buildTable(); };

        container.append(prev, info, next);
    }

    function updateNamaLembagaFilter() {
        const jenjang = document.getElementById('filterJenjang').value;
        const lembagaSelect = document.getElementById('filterNamaLembaga');
        const filtered = (jenjang === "") ? allDataRows : allDataRows.filter(r => r.data['Jenjang'] === jenjang);
        const lembaga = [...new Set(filtered.map(r => r.data['Nama Lembaga']))].filter(Boolean).sort();

        const currentSelection = lembagaSelect.value;
        lembagaSelect.innerHTML = '<option value="">Semua Lembaga</option>';
        lembaga.forEach(nama => lembagaSelect.add(new Option(nama, nama)));
        if ([...lembagaSelect.options].some(opt => opt.value === currentSelection)) {
            lembagaSelect.value = currentSelection;
        }
    }

    function applyFilters() {
        const jenjang = document.getElementById('filterJenjang').value;
        const lembaga = document.getElementById('filterNamaLembaga').value;

        currentFilteredRows = allDataRows.filter(r =>
            (jenjang === "" || r.data['Jenjang'] === jenjang) &&
            (lembaga === "" || r.data['Nama Lembaga'] === lembaga)
        );

        currentPage = 1;
        buildTable();
    }

    function initializePage(serverData) {
        const loading = document.getElementById('loadingStatus');
        const wrapper = document.getElementById('tableWrapper');
        const thead = document.querySelector('#kelolaPtkPaudTable thead');

        loading.style.display = 'none';
        wrapper.style.display = 'block';

        if (serverData.error || !serverData.rows) {
            wrapper.innerHTML = `<p style="color:red; text-align:center;">Gagal memuat data: ${serverData.error || 'Data tidak ditemukan.'}</p>`;
            return;
        }

        allDataRows = serverData.rows;

        const finalHeaders = ['No.', 'Nama', 'Nama Lembaga', 'Status', 'NIP/NIY', 'Jabatan', 'Aksi', 'Tanggal Input', 'Update'];
        thead.innerHTML = `<tr>${finalHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;
        rowsPerPage = calculateRowsPerPage();

        if (allDataRows.length > 0) {
            const jenjangSelect = document.getElementById('filterJenjang');
            const uniqueJenjang = [...new Set(allDataRows.map(r => r.data['Jenjang']))].filter(Boolean).sort();
            jenjangSelect.innerHTML = '<option value="">Semua Jenjang</option>';
            uniqueJenjang.forEach(j => jenjangSelect.add(new Option(j, j)));

            jenjangSelect.addEventListener('change', () => {
                updateNamaLembagaFilter();
                applyFilters();
            });
            document.getElementById('filterNamaLembaga').addEventListener('change', applyFilters);
            updateNamaLembagaFilter();
        }
        
        applyFilters();
    }

    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(err => {
            const loading = document.getElementById('loadingStatus');
            loading.style.display = 'none';
            document.getElementById('tableWrapper').style.display = 'block';
            document.getElementById('tableWrapper').innerHTML = `<p style="color:red; text-align:center;">Gagal memuat data dari server: ${err.message}</p>`;
        })
        .getKelolaPtkPaudData();
}

function initPtkTambahPaudPage() {
    const form = document.getElementById('addPtkPaudForm');
    if (!form) return;

    showAppModal('loading', 'Memuat opsi formulir...');

    google.script.run
        .withSuccessHandler(options => {
            if (options.error) {
                showAppModal('error', `Gagal memuat opsi: ${options.error}`);
                return;
            }

            const jenjangSelect = form.querySelector('#jenjang');
            const lembagaSelect = form.querySelector('#namaLembaga');
            const statusSelect = form.querySelector('#status');
            const jabatanSelect = form.querySelector('#jabatan');

            // Isi dropdown Jenjang
            jenjangSelect.innerHTML = '<option value="" disabled selected>-- Pilih Jenjang --</option>';
            options['Jenjang'].forEach(j => jenjangSelect.add(new Option(j, j)));

            // Isi dropdown Status
            statusSelect.innerHTML = '<option value="" disabled selected>-- Pilih Status --</option>';
            options['Status'].forEach(s => statusSelect.add(new Option(s, s)));

            // Isi dropdown Jabatan
            jabatanSelect.innerHTML = '<option value="" disabled selected>-- Pilih Jabatan --</option>';
            options['Jabatan'].forEach(j => jabatanSelect.add(new Option(j, j)));

            // Logika untuk mengubah Nama Lembaga berdasarkan Jenjang
            jenjangSelect.addEventListener('change', function() {
                const selectedJenjang = this.value;
                const lembagaOptions = options['Nama Lembaga'][selectedJenjang] || [];
                lembagaSelect.innerHTML = '<option value="" disabled selected>-- Pilih Lembaga --</option>';
                lembagaOptions.forEach(l => lembagaSelect.add(new Option(l, l)));
                lembagaSelect.disabled = false;
            });
            
            document.getElementById('appModal').classList.remove('show'); // Sembunyikan modal loading
        })
        .withFailureHandler(err => showAppModal('error', `Gagal memuat opsi form: ${err.message}`))
        .getNewPtkPaudOptions();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showAppModal('loading', 'Menyimpan data PTK baru...');

        const formData = Object.fromEntries(new FormData(form));
        
        google.script.run
            .withSuccessHandler(response => {
                showAppModal('success', response, 'ptk_kelola_paud');
            })
            .withFailureHandler(error => {
                showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .addNewPtkPaud(formData);
    });
}

function initPtkEditPaudPage(params) {
    const form = document.getElementById('editPtkPaudForm');
    const loadingDiv = document.getElementById('loading-data');
    if (!form || !params || !params.rowIndex) {
        document.getElementById('main-content').innerHTML = `<p style="color:red; text-align:center;">Error: Parameter untuk edit tidak ditemukan.</p>`;
        return;
    }

    form.querySelector('[name="rowIndex"]').value = params.rowIndex;

    // 1. Ambil semua opsi dropdown
    google.script.run.withSuccessHandler(options => {
        // 2. Ambil data spesifik untuk baris ini
        google.script.run.withSuccessHandler(rowData => {
            if (options.error || rowData.error) {
                showAppModal('error', options.error || rowData.error);
                return;
            }

            // --- Isi semua dropdown dengan opsi dari server ---
            const jenjangSelect = form.querySelector('#jenjang');
            jenjangSelect.innerHTML = '<option value="" disabled>-- Pilih Jenjang --</option>';
            options['Jenjang'].forEach(j => jenjangSelect.add(new Option(j, j)));

            ['Status', 'Jabatan'].forEach(key => {
                const select = form.querySelector(`#${key.toLowerCase()}`);
                select.innerHTML = `<option value="" disabled>-- Pilih ${key} --</option>`;
                options[key].forEach(opt => select.add(new Option(opt, opt)));
            });
            
            // --- Isi form dengan data yang ada ---
            for (const key in rowData) {
                const field = form.querySelector(`[name="${key}"]`);
                if (field) {
                    field.value = rowData[key];
                }
            }
            
            // --- Atur dropdown Nama Lembaga ---
            const lembagaSelect = form.querySelector('#namaLembaga');
            const selectedJenjang = jenjangSelect.value;
            const lembagaOptions = options['Nama Lembaga'][selectedJenjang] || [];
            lembagaSelect.innerHTML = '<option value="">-- Pilih Lembaga --</option>';
            lembagaOptions.forEach(l => lembagaSelect.add(new Option(l, l)));
            lembagaSelect.value = rowData['Nama Lembaga']; // Set nilai yang sudah tersimpan

            // Tambahkan event listener untuk mengubah lembaga jika jenjang diubah
            jenjangSelect.addEventListener('change', function() {
                const newJenjang = this.value;
                const newLembagaOptions = options['Nama Lembaga'][newJenjang] || [];
                lembagaSelect.innerHTML = '<option value="">-- Pilih Lembaga --</option>';
                newLembagaOptions.forEach(l => lembagaSelect.add(new Option(l, l)));
                lembagaSelect.disabled = false;
            });

            // Sembunyikan loading dan tampilkan form
            loadingDiv.style.display = 'none';
            form.style.display = 'block';

        }).withFailureHandler(err => showAppModal('error', `Gagal mengambil data baris: ${err.message}`)).getPtkPaudDataByRow(params.rowIndex);
    }).withFailureHandler(err => showAppModal('error', `Gagal memuat opsi form: ${err.message}`)).getNewPtkPaudOptions();

    // Logika saat form disubmit
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showAppModal('loading', 'Menyimpan perubahan...');

        const formData = Object.fromEntries(new FormData(form));
        
        google.script.run
            .withSuccessHandler(response => {
                showAppModal('success', response, 'ptk_kelola_paud');
            })
            .withFailureHandler(error => {
                showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .updatePtkPaudData(formData);
    });
}

/**
 * ===================================================================
 * =================== 3. OBJEK INISIALISASI & TRIGGER ===============
 * ===================================================================
 */

const pageInitializers = {
    'home': initHomePage,
    'sk_menu': initSubMenuPage,
    'sk_unggah': initSkUnggahPage,
    'sk_riwayat': initSkRiwayatPage,
    'sk_status': initSkStatusPage,
    'sk_kelola': initSkKelolaPage,
    'sk_edit': initSkEditPage,
    'sk_arsip': initSkArsipPage,
    'lapbul_menu': initSubMenuPage,
    'lapbul_unggah': initLapbulUnggahPage,
    'lapbul_form_paud': initLapbulFormPaudPage,
    'lapbul_form_sd': initLapbulFormSdPage,
    'lapbul_riwayat': initLapbulRiwayatPage,
    'lapbul_status': initLapbulStatusPage,
    'lapbul_arsip': initLapbulArsipPage,
    'lapbul_kelola': initLapbulKelolaPage,
    'lapbul_edit_paud': initLapbulEditPaudPage,
    'lapbul_edit_sd': initLapbulEditSdPage,
    'lapbul_unduh_format': initLapbulUnduhFormatPage,
    'ptk_menu': initSubMenuPage,
    'ptk_paud_menu': initSubMenuPage,
    'ptk_sd_menu': initSubMenuPage,
    'ptk_keadaan_paud': initPtkKeadaanPaudPage,
    'ptk_keadaan_sd': initPtkKeadaanSdPage,
    'ptk_jumlah_bulanan_paud': initPtkJumlahBulananPaudPage,
    'ptk_daftar_paud': initPtkDaftarPaudPage,
    'ptk_kelola_paud': initPtkKelolaPaudPage,
    'ptk_tambah_paud': initPtkTambahPaudPage,
    'ptk_edit_paud': initPtkEditPaudPage,
    'ptk_daftar_sd_negeri': initSubMenuPage,
    'ptk_daftar_sd_swasta': initSubMenuPage,
    'ptk_kelola_sd': initSubMenuPage,
    'ptk_kebutuhan_sd_negeri': initSubMenuPage,
    'ptk_bezetting_sd_negeri': initSubMenuPage,
    'murid_menu': initSubMenuPage,
    'siaba_menu': initSubMenuPage,
    'pns_menu': initSubMenuPage,
    'rapor_pendidikan_menu': initSubMenuPage,
    'tata_naskah_menu': initSubMenuPage,
    'mutasi_murid_menu': initSubMenuPage,
    'tapera_sitara_menu': initSubMenuPage,
    'administrasi_sekolah_menu': initSubMenuPage,
    'data_sekolah_menu': initSubMenuPage,
    'komunitas_belajar_menu': initSubMenuPage,
    'gelar_karya_menu': initSubMenuPage
};

document.addEventListener('DOMContentLoaded', () => {
    loadPage(null, 'home');
    document.body.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        if (!link) return;
        const pageName = link.dataset.page;
        const isSubmenuToggle = link.hasAttribute('data-page-parent');
        if (isSubmenuToggle) {
            e.preventDefault();
            link.parentElement.classList.toggle('open');
        }
        if (pageName) {
            e.preventDefault();
            loadPage(null, pageName);
        }
    });
});
</script>

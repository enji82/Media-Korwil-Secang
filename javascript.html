<div id="appModal" class="modal-overlay">
    <div class="modal-content">
        <div id="modalSpinner" style="display: none;"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div></div>
        <h3 id="modalTitle"></h3>
        <p id="modalMessage"></p>
        <div class="modal-actions">
            <button id="modalOkBtn" class="submit-btn" style="background-color: #3498db;">OK</button>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="deleteModalTitle">Konfirmasi Hapus</h3>
        <div id="deleteModalBody"></div>
        <div class="modal-actions">
            <button id="cancelDeleteBtn" class="cancel-btn">Batal</button>
            <button id="confirmDeleteBtn" class="delete-btn-confirm">Ya, Hapus</button>
        </div>
    </div>
</div>


<script>
/**
 * ===================================================================
 * ======================= 1. FUNGSI INTI & UTILITAS =================
 * ===================================================================
 */

function showAppModal(state, message, redirectPage = null) {
    const modal = document.getElementById('appModal');
    const spinner = document.getElementById('modalSpinner');
    const title = document.getElementById('modalTitle');
    const msg = document.getElementById('modalMessage');
    const okBtn = document.getElementById('modalOkBtn');
    spinner.style.display = 'none';
    okBtn.style.display = 'block';
    msg.innerHTML = message;
    if (state === 'loading') {
        title.textContent = "Memproses...";
        spinner.style.display = 'block';
        okBtn.style.display = 'none';
    } else if (state === 'success') {
        title.textContent = 'Sukses!';
        title.style.color = '#27ae60';
        okBtn.textContent = 'OK';
        okBtn.onclick = () => {
            modal.classList.remove('show');
            if (redirectPage) loadPage(null, redirectPage);
        };
    } else if (state === 'info') {
        title.textContent = 'Informasi Penting';
        title.style.color = '#00c3ff';
        okBtn.textContent = 'Mengerti';
        okBtn.onclick = () => modal.classList.remove('show');
    } else { // 'error'
        title.textContent = 'Error!';
        title.style.color = '#e74c3c';
        okBtn.textContent = 'OK';
        okBtn.onclick = () => modal.classList.remove('show');
    }
    modal.classList.add('show');
}

function loadPage(event, pageName, params = {}) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    const contentArea = document.getElementById('main-content');
    contentArea.innerHTML = '<div class="loading-container"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div><p>Memuat halaman...</p></div>';
    
    google.script.run
        .withSuccessHandler(html => {
            try {
                contentArea.innerHTML = html;
                if (typeof pageInitializers !== 'undefined' && typeof pageInitializers[pageName] === 'function') {
                    pageInitializers[pageName](params);
                }
                updateActiveMenu(pageName);
            } catch (e) {
                console.error("Client-side error after loading page:", e);
                contentArea.innerHTML = `<div class="error-box"><h3>Error JavaScript di Browser!</h3><p><strong>Pesan:</strong> ${e.message}</p></div>`;
            }
        })
        .withFailureHandler(err => {
            console.error("Server-side error during include:", err);
            contentArea.innerHTML = `<div class="error-box"><h3>Gagal Memuat Konten!</h3><p>Pastikan file HTML 'page_${pageName}.html' ada dan namanya sudah benar.</p><p><strong>Pesan Server:</strong> ${err.message}</p></div>`;
        })
        .include('page_' + pageName);
}

function updateActiveMenu(pageName) {
    document.querySelectorAll('.sidebar-menu a').forEach(el => el.classList.remove('active'));
    const activeLink = document.querySelector(`.sidebar-menu a[data-page="${pageName}"]`);
    if (activeLink) {
        activeLink.classList.add('active');
        const parentLi = activeLink.closest('.has-submenu');
        document.querySelectorAll('.sidebar-menu li.has-submenu').forEach(li => {
            if (li !== parentLi) { li.classList.remove('open'); }
        });
        if (parentLi) {
            parentLi.classList.add('open');
            const parentAnchor = parentLi.querySelector('a[data-page-parent]');
            if(parentAnchor) parentAnchor.classList.add('active');
        }
    }
}

function calculateRowsPerPage(tableId) {
    try {
        const mainContent = document.querySelector('.main-content');
        const header = mainContent.querySelector('header');
        const filterContainer = mainContent.querySelector('.filter-container');
        const paginationContainer = document.getElementById('pagination-container');
        const tableHeader = document.querySelector(`#${tableId} thead`);
        const tableBody = document.querySelector(`#${tableId} tbody`);

        if (!mainContent || !tableHeader || !tableBody) return 15;

        // Hitung semua ruang vertikal yang sudah terpakai
        let reservedHeight = 60; 
        if (header) reservedHeight += header.offsetHeight + 30; 
        if (filterContainer) reservedHeight += filterContainer.offsetHeight + 20; 
        if (paginationContainer) reservedHeight += paginationContainer.offsetHeight;
        if (tableHeader) reservedHeight += tableHeader.offsetHeight;

        const availableHeight = mainContent.clientHeight - reservedHeight;
        
        // Buat baris tiruan untuk mengukur tinggi pastinya
        const numCols = tableHeader.querySelector('tr')?.children.length || 1;
        const dummyRow = createDummyRow(tableBody, numCols);
        const actualRowHeight = dummyRow.offsetHeight || 48;
        tableBody.removeChild(dummyRow);

        if (actualRowHeight <= 0) return 15;

        const calculatedRows = Math.floor(availableHeight / actualRowHeight);
        return Math.max(5, calculatedRows);
    } catch (e) {
        console.error("Error calculating rows per page:", e);
        return 15;
    }
}

function createDummyRow(tableBody, numCols) {
    const dummyRow = tableBody.insertRow();
    dummyRow.style.visibility = 'hidden';
    dummyRow.style.position = 'absolute';
    for (let i = 0; i < numCols; i++) {
        let cell = dummyRow.insertCell();
        cell.innerHTML = '&nbsp;';
    }
    if (tableBody.parentElement && (tableBody.parentElement.id === 'kelolaTable' || tableBody.parentElement.id === 'lapbulKelolaTable')) {
      let cell = dummyRow.insertCell();
      cell.innerHTML = '<button class="action-btn">A</button>';
    }
    return dummyRow;
}


const debounce = (func, timeout = 150) => {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => { func.apply(this, args); }, timeout);
    };
};

/**
 * ===================================================================
 * =================== 2. FUNGSI INISIALISASI HALAMAN ================
 * ===================================================================
 */

function initHomePage() {
    document.querySelectorAll('#main-content .menu-button').forEach((button, index) => {
        button.style.animationDelay = `${index * 0.07}s`;
    });
}

function initSubMenuPage() {
    document.querySelectorAll('#main-content .menu-button').forEach((button, index) => {
        button.style.animationDelay = `${index * 0.07}s`;
    });
}

// --- Modul SK Pembagian Tugas ---

function initSkUnggahPage() {
    const form = document.getElementById('manualUploadForm');
    if (!form) return;

    function populateSingleDropdown(elementId, optionsArray, defaultText) {
        const dropdown = document.getElementById(elementId);
        if (!dropdown) return;
        dropdown.innerHTML = `<option value="" disabled selected>${defaultText}</option>`;
        if (optionsArray && optionsArray.length > 0) {
            optionsArray.forEach(item => {
                let option = document.createElement("option");
                option.value = item;
                option.textContent = item;
                dropdown.appendChild(option);
            });
        }
    }

    google.script.run
        .withSuccessHandler(optionsObject => {
            populateSingleDropdown("namaSD", optionsObject["Nama SD"], "Pilih Sekolah");
            populateSingleDropdown("tahunAjaran", optionsObject["Tahun Ajaran"], "Pilih Tahun Ajaran");
            populateSingleDropdown("semester", optionsObject["Semester"], "Pilih Semester");
            populateSingleDropdown("kriteriaSK", optionsObject["Kriteria SK"], "Pilih Kriteria SK");
        })
        .withFailureHandler(error => console.error('Gagal memuat opsi form SK:', error))
        .getMasterSkOptions();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = document.getElementById('submitBtn');
        submitButton.disabled = true;
        showAppModal('loading', 'Sedang memproses dan mengunggah file...');
        const file = document.getElementById('fileUpload').files[0];
        if (!file || file.size > 1024 * 1024) {
            showAppModal('error', 'File PDF maksimal 1 MB harus dipilih.');
            submitButton.disabled = false;
            return;
        }
        const reader = new FileReader();
        reader.onload = event => {
            const fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
            const formData = {
                namaSD: form.namaSD.value,
                tahunAjaran: form.tahunAjaran.value,
                semester: form.semester.value,
                kriteriaSK: form.kriteriaSK.value,
                nomorSK: form.nomorSK.value,
                tanggalSK: form.tanggalSK.value,
                fileData: fileData
            };
            google.script.run
                .withSuccessHandler(response => showAppModal('success', response, 'sk_riwayat'))
                .withFailureHandler(error => {
                    showAppModal('error', `Gagal menyimpan: ${error.message}`);
                    submitButton.disabled = false;
                })
                .processManualForm(formData);
        };
        reader.readAsDataURL(file);
    });
}

function initSkRiwayatPage() {
    let allDataRows = [], headerCols = [], filterIndices = {}, currentPage = 1, rowsPerPage = 15, currentFilteredRows = [];
    
    function buildTable() {
        const tableBody = document.getElementById('riwayatTable').querySelector('tbody');
        if (!tableBody) return;
        tableBody.innerHTML = '';
        const pageCount = Math.max(1, Math.ceil(currentFilteredRows.length / rowsPerPage));
        if (currentPage > pageCount) currentPage = pageCount;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = currentFilteredRows.slice(start, end);
        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${headerCols.length + 1}">Tidak ada data yang cocok.</td></tr>`;
        } else {
            paginatedRows.forEach((cols, index) => {
                const tr = document.createElement('tr');
                let rowHTML = `<td>${start + index + 1}</td>`;
                cols.forEach((cellData, i) => {
                    cellData = cellData || '-';
                    if (headerCols[i] === 'Dokumen' && typeof cellData === 'string' && cellData.startsWith('http')) {
                        rowHTML += `<td class="view-btn-container"><a href="${cellData}" target="_blank" class="action-btn view-btn"><i class="fas fa-eye"></i> Lihat</a></td>`;
                    } else {
                        rowHTML += `<td>${cellData}</td>`;
                    }
                });
                tr.innerHTML = rowHTML;
                tableBody.appendChild(tr);
            });
        }
        setupPagination();
    }

    function setupPagination() {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        if (pageCount <= 1) { paginationContainer.style.display = 'none'; return; }
        paginationContainer.style.display = 'flex';
        const pageInfo = document.createElement('span');
        pageInfo.className = 'page-info';
        pageInfo.textContent = `Halaman ${currentPage} dari ${pageCount}`;
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '«';
        prevBtn.className = 'page-btn';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; buildTable(); } };
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '»';
        nextBtn.className = 'page-btn';
        nextBtn.disabled = currentPage === pageCount;
        nextBtn.onclick = () => { if (currentPage < pageCount) { currentPage++; buildTable(); } };
        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
    }

    function applyFilters() {
        const filterTahun = document.getElementById('filterTahun').value;
        const filterSemester = document.getElementById('filterSemester').value;
        const filterNama = document.getElementById('filterNamaSekolah').value;
        currentFilteredRows = allDataRows.filter(cols => {
            const tahunMatch = (filterTahun === "") || (String(cols[filterIndices.tahun]) === filterTahun);
            const semesterMatch = (filterSemester === "") || (String(cols[filterIndices.semester]) === filterSemester);
            const namaMatch = (filterNama === "") || (String(cols[filterIndices.nama]) === filterNama);
            return tahunMatch && semesterMatch && namaMatch;
        });
        currentPage = 1;
        buildTable();
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('riwayatTable').querySelector('thead');
        const tableBody = document.getElementById('riwayatTable').querySelector('tbody');
        if (!dataArray || dataArray.length < 2) {
            loadingStatus.innerHTML = "<p>Tidak ada data riwayat untuk ditampilkan.</p>"; return;
        }
        headerCols = dataArray[0].map(h => String(h).trim());
        allDataRows = dataArray.slice(1);
        
        const updateIndex = headerCols.indexOf('Update');
        if (updateIndex > -1) {
          headerCols.splice(updateIndex, 1);
          allDataRows.forEach(row => row.splice(updateIndex, 1));
        }

        const headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th>No.</th>';
        headerCols.forEach(header => { headerRow.innerHTML += `<th>${header}</th>`; });
        tableHead.innerHTML = '';
        tableHead.appendChild(headerRow);
        
        rowsPerPage = calculateRowsPerPage('riwayatTable');
        tableBody.innerHTML = '';
        
        filterIndices = { tahun: headerCols.indexOf('Tahun Ajaran'), semester: headerCols.indexOf('Semester'), nama: headerCols.indexOf('Nama SD') };
        
        Object.keys(filterIndices).forEach(key => {
            const selectId = 'filter' + key.charAt(0).toUpperCase() + key.slice(1);
            const realSelect = document.getElementById(key === 'nama' ? 'filterNamaSekolah' : selectId);
            if (!realSelect) return;
            const uniqueValues = [...new Set(allDataRows.map(row => String(row[filterIndices[key]])))];
            realSelect.innerHTML = `<option value="">Semua</option>`;
            const sortOrder = (key === 'tahun') ? uniqueValues.sort().reverse() : uniqueValues.sort();
            sortOrder.forEach(val => { if(val && val.trim() !== '') realSelect.add(new Option(val, val)); });
            realSelect.addEventListener('change', applyFilters);
        });
        
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'block';
        applyFilters();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getRiwayatPengirimanSKData();

    window.addEventListener('resize', debounce(() => {
        if (document.getElementById('riwayatTable')) {
            rowsPerPage = calculateRowsPerPage('riwayatTable');
            buildTable();
        }
    }));
}

function initSkStatusPage() {
    let allDataRows = [], headerCols = [], currentPage = 1, rowsPerPage = 15;
    
    function buildTable() {
        const tableBody = document.getElementById('statusTable').querySelector('tbody');
        if (!tableBody) return;
        tableBody.innerHTML = '';
        const pageCount = Math.max(1, Math.ceil(allDataRows.length / rowsPerPage));
        if (currentPage > pageCount) currentPage = pageCount;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = allDataRows.slice(start, end);
        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${headerCols.length + 1}">Tidak ada data.</td></tr>`;
        } else {
            paginatedRows.forEach((cols, index) => {
                const tr = document.createElement('tr');
                let rowHTML = `<td>${start + index + 1}</td>`;
                cols.forEach((cellData, i) => {
                    rowHTML += `<td>${cellData || '-'}</td>`;
                });
                tr.innerHTML = rowHTML;
                tableBody.appendChild(tr);
            });
        }
        setupPagination();
    }

    function setupPagination() {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        const pageCount = Math.ceil(allDataRows.length / rowsPerPage);
        if (pageCount <= 1) { paginationContainer.style.display = 'none'; return; }
        paginationContainer.style.display = 'flex';
        const pageInfo = document.createElement('span');
        pageInfo.className = 'page-info';
        pageInfo.textContent = `Halaman ${currentPage} dari ${pageCount}`;
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '«';
        prevBtn.className = 'page-btn';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; buildTable(); } };
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '»';
        nextBtn.className = 'page-btn';
        nextBtn.disabled = currentPage === pageCount;
        nextBtn.onclick = () => { if (currentPage < pageCount) { currentPage++; buildTable(); } };
        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('statusTable').querySelector('thead');
        const tableBody = document.getElementById('statusTable').querySelector('tbody');
        if (!dataArray || dataArray.length < 2) {
            loadingStatus.innerHTML = "<p>Tidak ada data status untuk ditampilkan.</p>";
            return;
        }
        headerCols = dataArray[0].map(h => String(h).trim());
        allDataRows = dataArray.slice(1);
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th>No.</th>';
        headerCols.forEach(header => { headerRow.innerHTML += `<th>${header}</th>`; });
        tableHead.innerHTML = '';
        tableHead.appendChild(headerRow);
        
        rowsPerPage = calculateRowsPerPage('statusTable');
        tableBody.innerHTML = '';
        
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'block';
        buildTable();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getStatusPengirimanSKData();

    window.addEventListener('resize', debounce(() => {
        if (document.getElementById('statusTable')) {
            rowsPerPage = calculateRowsPerPage('statusTable');
            buildTable();
        }
    }));
}

function initSkKelolaPage() {
    let allDataRows = [], allHeaders = [], currentFilteredRows = [], currentPage = 1, rowsPerPage = 15;
 
    function buildTable() {
        const tableBody = document.getElementById('kelolaTable').querySelector('tbody');
        if (!tableBody) return;
        tableBody.innerHTML = '';
        const pageCount = Math.max(1, Math.ceil(currentFilteredRows.length / rowsPerPage));
        if (currentPage > pageCount) currentPage = pageCount;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = currentFilteredRows.slice(start, end);
        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders.length + 2}">Tidak ada data yang cocok.</td></tr>`;
        } else {
            paginatedRows.forEach((row, index) => {
                const tr = document.createElement('tr');
                let rowHTML = `<td>${start + index + 1}</td>`;
                allHeaders.forEach(header => {
                    let cellData = row.data[header] || '-';
                    if (header === 'Dokumen' && typeof cellData === 'string' && cellData.startsWith('http')) {
                        rowHTML += `<td class="view-btn-container"><a href="${cellData}" target="_blank" class="action-btn view-btn"><i class="fas fa-eye"></i> Lihat</a></td>`;
                    } else {
                        rowHTML += `<td>${cellData}</td>`;
                    }
                });
                tr.innerHTML = rowHTML;
                const actionCell = document.createElement('td');
                actionCell.className = 'action-buttons';
                const editBtn = document.createElement('button');
                editBtn.className = 'action-btn edit-btn';
                editBtn.innerHTML = `<i class="fas fa-pencil-alt"></i> Edit`;
                editBtn.onclick = (e) => loadPage(e, 'sk_edit', { rowIndex: row.rowIndex });
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'action-btn delete-btn';
                deleteBtn.innerHTML = `<i class="fas fa-trash"></i> Hapus`;
                deleteBtn.onclick = () => showDeleteConfirmation(row);
                actionCell.appendChild(editBtn);
                actionCell.appendChild(deleteBtn);
                tr.appendChild(actionCell);
                tableBody.appendChild(tr);
            });
        }
        setupPagination();
    }
 
    function setupPagination() {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        if (pageCount <= 1) { paginationContainer.style.display = 'none'; return; }
        paginationContainer.style.display = 'flex';
        const pageInfo = document.createElement('span');
        pageInfo.className = 'page-info';
        pageInfo.textContent = `Halaman ${currentPage} dari ${pageCount}`;
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '«';
        prevBtn.className = 'page-btn';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; buildTable(); } };
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '»';
        nextBtn.className = 'page-btn';
        nextBtn.disabled = currentPage === pageCount;
        nextBtn.onclick = () => { if (currentPage < pageCount) { currentPage++; buildTable(); } };
        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
    }
 
    function applyFilters() {
        const filterTahun = document.getElementById('filterTahun').value;
        const filterSemester = document.getElementById('filterSemester').value;
        const filterNama = document.getElementById('filterNamaSekolah').value;
        currentFilteredRows = allDataRows.filter(row => {
            const tahunMatch = (filterTahun === "") || (row.data['Tahun Ajaran'] === filterTahun);
            const semesterMatch = (filterSemester === "") || (row.data['Semester'] === filterSemester);
            const namaMatch = (filterNama === "") || (row.data['Nama SD'] === filterNama);
            return tahunMatch && semesterMatch && namaMatch;
        });
        currentPage = 1;
        buildTable();
    }
 
    function showDeleteConfirmation(rowInfo) {
        const modal = document.getElementById('deleteModal');
        if (!modal) return;
        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');
        const cancelBtn = modal.querySelector('#cancelDeleteBtn');
        modalTitle.textContent = 'Konfirmasi Hapus';
        modalBody.innerHTML = `<p>Apakah Anda yakin ingin menghapus data SK ini?</p><div style="font-weight: bold; margin: 15px 0; background:rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; line-height: 1.5; text-align: left;">Sekolah: ${rowInfo.data['Nama SD']}<br>Tahun Ajaran: ${rowInfo.data['Tahun Ajaran']}</div>`;
        confirmBtn.style.display = 'inline-flex';
        confirmBtn.textContent = 'Ya, Hapus';
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.onclick = () => showDeletePrompt(rowInfo);
        cancelBtn.onclick = () => modal.classList.remove('show');
        modal.classList.add('show');
    }
 
    function showDeletePrompt(rowInfo) {
        const modal = document.getElementById('deleteModal');
        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');
        modalTitle.textContent = 'Masukkan Kode Hapus';
        modalBody.innerHTML = `<p>Kode hapus dapat ditanyakan ke admin Korwil.</p><input type="password" id="kodeHapusInput" class="custom-modal-input" autocomplete="off" placeholder="Masukkan Kode Hapus">`;
        confirmBtn.textContent = 'Konfirmasi & Hapus';
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.onclick = () => processDeletion(rowInfo);
        setTimeout(() => document.getElementById('kodeHapusInput').focus(), 100);
    }
 
    function processDeletion(rowInfo) {
        const deleteCode = document.getElementById('kodeHapusInput').value;
        if (!deleteCode) { 
            showAppModal('error', 'Kode hapus tidak boleh kosong.');
            return; 
        }
        showAppModal('loading', 'Menghapus data dan file terkait...');
        google.script.run
            .withSuccessHandler(response => {
                document.getElementById('deleteModal').classList.remove('show');
                showAppModal('success', response, 'sk_kelola');
            })
            .withFailureHandler(error => showAppModal('error', error.message))
            .deleteSKData(rowInfo.rowIndex, deleteCode);
    }
 
    function initializePage(data) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('kelolaTable').querySelector('thead');
        const tableBody = document.getElementById('kelolaTable').querySelector('tbody');
        if (data.error || !data.rows || data.rows.length === 0) {
            loadingStatus.innerHTML = `<p>Tidak ada data untuk dikelola.</p>`; return;
        }
        allHeaders = data.headers;
        allDataRows = data.rows;
        
        const updateIndexClient = allHeaders.indexOf('Update');
        if (updateIndexClient > -1) {
          const [updateHeader] = allHeaders.splice(updateIndexClient, 1);
          allHeaders.push(updateHeader);
        }

        let headerHTML = '<tr><th>No.</th>';
        allHeaders.forEach(h => headerHTML += `<th>${h}</th>`);
        headerHTML += '<th>Aksi</th></tr>';
        tableHead.innerHTML = headerHTML;
        
        rowsPerPage = calculateRowsPerPage('kelolaTable');
        tableBody.innerHTML = '';
        const uniqueValues = { tahun: [], semester: [], nama: [] };
        allDataRows.forEach(row => {
            uniqueValues.tahun.push(row.data['Tahun Ajaran']);
            uniqueValues.semester.push(row.data['Semester']);
            uniqueValues.nama.push(row.data['Nama SD']);
        });
        const populateSelect = (id, values, sortReverse = false) => {
            const select = document.getElementById(id);
            if (!select) return;
            select.innerHTML = '<option value="">Semua</option>';
            let sortedValues = [...new Set(values)].filter(Boolean).sort();
            if(sortReverse) sortedValues.reverse();
            sortedValues.forEach(val => select.add(new Option(val, val)));
            select.addEventListener('change', applyFilters);
        };
        populateSelect('filterTahun', uniqueValues.tahun, true);
        populateSelect('filterSemester', uniqueValues.semester);
        populateSelect('filterNamaSekolah', uniqueValues.nama);
        loadingStatus.style.display = 'none';
        
        document.querySelector('.filter-container').style.display = 'flex';
        tableWrapper.style.display = 'block'; 
        document.getElementById('pagination-container').style.display = 'flex';
        
        applyFilters();
    }
 
    google.script.run.withSuccessHandler(initializePage).withFailureHandler(err => {
        document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal: ${err.message}</p>`
    }).getSKDataForManagement();
 
    window.addEventListener('resize', debounce(() => {
        if (document.getElementById('kelolaTable')) {
            rowsPerPage = calculateRowsPerPage('kelolaTable');
            buildTable();
        }
    }));
}

function initSkEditPage(params) {
    const rowIndex = params ? params.rowIndex : null;
    if (!rowIndex) {
        document.getElementById('main-content').innerHTML = `<p style="color:red;">Error: ID baris tidak ditemukan.</p>`;
        return;
    }
    const form = document.getElementById('skEditForm');
    const loadingDiv = document.getElementById('loading-data');
    form.querySelector('#rowIndex').value = rowIndex;
    google.script.run.withSuccessHandler(options => {
        google.script.run.withSuccessHandler(rowData => {
            const fieldMapping = {
                'Nama SD': 'namaSD', 'Tahun Ajaran': 'tahunAjaran', 'Semester': 'semester',
                'Kriteria SK': 'kriteriaSK', 'Nomor SK': 'nomorSK', 'Tanggal SK': 'tanggalSK'
            };
            for (const key in options) {
                const elementId = fieldMapping[key];
                if (elementId) {
                    const select = document.getElementById(elementId);
                    if (select && Array.isArray(options[key])) {
                        select.innerHTML = options[key].map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    }
                }
            }
            for (const key in rowData) {
                const elementId = fieldMapping[key];
                if (elementId) {
                    const field = document.getElementById(elementId);
                    if (field) {
                        const savedValue = rowData[key];
                        if (field.tagName === 'SELECT') {
                            field.value = savedValue;
                            let optionExists = Array.from(field.options).some(opt => opt.value === savedValue);
                            if (!optionExists && savedValue) {
                                const newOption = new Option(savedValue, savedValue);
                                field.add(newOption);
                                field.value = savedValue;
                            }
                        }
                        else if (key === 'Tanggal SK' && savedValue) {
                            const parts = savedValue.split('/');
                            if (parts.length === 3) {
                                field.value = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            } else {
                                field.value = savedValue;
                            }
                        } else {
                            field.value = savedValue;
                        }
                    }
                }
            }
            const fileLink = rowData['Dokumen'];
            document.getElementById('existingFileLink').innerHTML = fileLink ? `<a href="${fileLink}" target="_blank">Lihat File Saat Ini</a>` : 'Tidak ada file.';
            
            loadingDiv.style.display = 'none';
            form.style.display = 'block';
        }).withFailureHandler(err => alert(`Gagal memuat data baris: ${err.message}`)).getSKDataByRow(rowIndex);
    }).withFailureHandler(err => alert(`Gagal memuat opsi dropdown: ${err.message}`)).getMasterSkOptions();
 
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        const submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        showAppModal('loading', 'Menyimpan perubahan...');
        const formDataObj = {
            rowIndex: form.rowIndex.value, 'Semester': document.getElementById('semester').value,
            'Kriteria SK': document.getElementById('kriteriaSK').value, 'Nomor SK': document.getElementById('nomorSK').value,
            'Tanggal SK': document.getElementById('tanggalSK').value,
        };
        const fileInput = document.getElementById('fileSK');
        const file = fileInput.files[0];
        const sendData = (data) => {
            google.script.run
                .withSuccessHandler(res => showAppModal('success', res, 'sk_kelola'))
                .withFailureHandler(err => {
                    showAppModal('error', err.message);
                    submitButton.disabled = false;
                })
                .updateSKData(data);
        };
        if (file) {
            if (file.size > 1024 * 1024) {
                showAppModal('error', 'Ukuran file baru tidak boleh lebih dari 1 MB.');
                submitButton.disabled = false; return;
            }
            const reader = new FileReader();
            reader.onload = function (event) {
                formDataObj.fileData = {
                    fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1]
                };
                sendData(formDataObj);
            };
            reader.readAsDataURL(file);
        } else {
            sendData(formDataObj);
        }
    });
}

function initSkArsipPage() {
    const MAIN_FOLDER_ID = "1GwIow8B4O1OWoq3nhpzDbMO53LXJJUKs";
    let breadcrumbTrail = [];
    const viewContainer = document.getElementById('view-container');
    const breadcrumbDiv = document.getElementById('breadcrumb');

    function updateBreadcrumb() {
        const fragment = document.createDocumentFragment();
        breadcrumbTrail.forEach((item, index) => {
            if (index > 0) { 
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                separator.style.margin = '0 5px';
                fragment.appendChild(separator);
            }
            const span = document.createElement('span');
            span.textContent = item.name;
            if (index < breadcrumbTrail.length - 1) {
                span.onclick = () => {
                    breadcrumbTrail.length = index; // TRUNCATE the array
                    if (item.type === 'root') {
                        renderTahunAjaranView();
                    } else if (item.type === 'tahun') {
                        renderSemesterView(item.id, item.name);
                    }
                };
            } else {
                span.classList.add('inactive');
            }
            fragment.appendChild(span);
        });
        breadcrumbDiv.innerHTML = '';
        breadcrumbDiv.appendChild(fragment);
    }

    function showLoading() {
        viewContainer.innerHTML = '<div class="loading-container"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div><p>Memuat...</p></div>';
    }

    function renderTahunAjaranView() {
        breadcrumbTrail = [{ name: 'Tahun Ajaran', type: 'root', id: MAIN_FOLDER_ID }];
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(folders => {
            if (!folders || folders.length === 0) { 
                viewContainer.innerHTML = '<p>Tidak ada folder tahun ajaran ditemukan.</p>'; 
            } else {
                viewContainer.innerHTML = '<div class="card-grid"></div>';
                const cardGrid = viewContainer.querySelector('.card-grid');
                folders.forEach((folder, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.innerHTML = `<i class="fas fa-calendar-alt"></i><span>${folder.name}</span>`;
                    card.onclick = () => renderSemesterView(folder.id, folder.name);
                    cardGrid.appendChild(card);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat folder: ${err.message}</p>`;
        }).getFolders(MAIN_FOLDER_ID);
    }

    function renderSemesterView(tahunId, tahunName) {
        breadcrumbTrail.push({ name: tahunName, type: 'tahun', id: tahunId });
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(folders => {
            if (!folders || folders.length === 0) { 
                viewContainer.innerHTML = '<p>Tidak ada folder semester ditemukan.</p>'; 
            } else {
                viewContainer.innerHTML = '<div class="card-grid"></div>';
                const cardGrid = viewContainer.querySelector('.card-grid');
                folders.sort((a, b) => a.name.localeCompare(b.name)).forEach((folder, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.innerHTML = `<i class="fas fa-folder-open"></i><span>${folder.name}</span>`;
                    card.onclick = () => renderFileView(folder.id, folder.name);
                    cardGrid.appendChild(card);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat folder: ${err.message}</p>`;
        }).getFolders(tahunId);
    }

    function renderFileView(semesterId, semesterName) {
        breadcrumbTrail.push({ name: semesterName, type: 'semester', id: semesterId });
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(files => {
            if (!files || files.length === 0) {
                viewContainer.innerHTML = '<p>Tidak ada file ditemukan di folder ini.</p>';
            } else {
                viewContainer.innerHTML = '<div class="file-list-container"></div>';
                const fileList = viewContainer.querySelector('.file-list-container');
                files.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.style.animationDelay = `${index * 0.03}s`;
                    fileItem.innerHTML = `<i class="fas fa-file-pdf"></i><a href="${file.url}" target="_blank">${file.name}</a>`;
                    fileList.appendChild(fileItem);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat file: ${err.message}</p>`;
        }).getFiles(semesterId);
    }
    
    renderTahunAjaranView();
}

// --- Modul Laporan Bulan ---
function initLapbulUnggahPage() {
    initSubMenuPage(); // Menjalankan animasi tombol menu
    
    const infoBtn = document.getElementById('showInfoBtn');
    if (infoBtn) {
        infoBtn.onclick = function() {
            // 1. Tampilkan modal loading terlebih dahulu
            showAppModal('loading', 'Memuat informasi...');
            
            // 2. Panggil fungsi di server untuk mengambil data
            google.script.run
                .withSuccessHandler(infoItems => {
                    // 3. Jika berhasil, format data menjadi daftar HTML
                    if (infoItems && infoItems.length > 0) {
                        const infoContent = `
                            <ul style="text-align: left; padding-left: 20px; line-height: 1.6;">
                                ${infoItems.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        `;
                        // 4. Tampilkan informasi di modal
                        showAppModal('info', infoContent);
                    } else {
                        showAppModal('error', 'Informasi tidak ditemukan di spreadsheet.');
                    }
                })
                .withFailureHandler(err => {
                    // Jika gagal, tampilkan pesan error
                    showAppModal('error', `Gagal memuat informasi: ${err.message}`);
                })
                .getLapbulInfo();
        };
    }
}

function initLapbulFormPaudPage(params) {
    const form = document.getElementById('lapbulFormPaud');
    if (!form) return;

    const bulanSelect = form.querySelector('[name="laporanBulan"]');
    const tahunSelect = form.querySelector('[name="tahun"]');
    const jenjangSelect = document.getElementById('jenjang');
    const namaSekolahSelect = document.getElementById('namaSekolah');
    const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const d = new Date();
    const currentYear = d.getFullYear();
    const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
    bulanSelect.innerHTML = bulanOptions.map((m, i) => `<option value="${m}" ${i === prevMonthIndex ? 'selected' : ''}>${m}</option>`).join('');
    tahunSelect.innerHTML = [currentYear, currentYear - 1].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');

    showAppModal('loading', 'Memuat daftar sekolah...');
    google.script.run
        .withSuccessHandler(schoolLists => {
            const handleJenjangChange = () => {
                const selectedJenjang = jenjangSelect.value;
                const schoolList = schoolLists[selectedJenjang] || [];
                namaSekolahSelect.innerHTML = '<option value="" disabled selected>-- Pilih Sekolah --</option>';
                schoolList.forEach(school => {
                    namaSekolahSelect.add(new Option(school, school));
                });
                namaSekolahSelect.disabled = false;
            };
            jenjangSelect.addEventListener('change', handleJenjangChange);
            document.getElementById('appModal').classList.remove('show');
        })
        .withFailureHandler(err => showAppModal('error', `Gagal memuat daftar sekolah: ${err.message}`))
        .getPaudSchoolLists();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showAppModal('loading', 'Mengirim data dan mengunggah file...');
        const file = document.getElementById('fileLapbul').files[0];
        if (!file || file.size > 300 * 1024) { // 300 KB Limit
            showAppModal('error', 'File PDF dengan ukuran maksimal 300 KB harus dipilih.');
            submitButton.disabled = false;
            return;
        }
        const reader = new FileReader();
        reader.onload = event => {
            const fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
            const formData = Object.fromEntries(new FormData(form));
            formData.fileData = fileData;
            google.script.run
                .withSuccessHandler(response => showAppModal('success', response, 'lapbul_riwayat'))
                .withFailureHandler(error => {
                    showAppModal('error', `Gagal: ${error.message}`);
                    submitButton.disabled = false;
                })
                .processLapbulFormPaud(formData);
        };
        reader.readAsDataURL(file);
    });
}

function initLapbulFormSdPage() {
    const form = document.getElementById('lapbulFormSd');
    if (!form) return;

    function generateKelasHTML(kelas) {
    const rombels = ['A', 'B', 'C'];
    const agama = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];

    let rombelInputsHTML = '';
    for (const rombel of rombels) {
        rombelInputsHTML += `
            <div class="rombel-input-group" id="rombel-${kelas}-${rombel}" style="display: none;">
                <label class="rombel-group-label">Kelas ${kelas}${rombel}</label>
                <div class="murid-input-pair">
                    <div class="form-group"><label>Laki-laki</label><input type="number" name="k${kelas}_rombel_${rombel.toLowerCase()}_L" value="0" min="0" required></div>
                    <div class="form-group"><label>Perempuan</label><input type="number" name="k${kelas}_rombel_${rombel.toLowerCase()}_P" value="0" min="0" required></div>
                </div>
            </div>
        `;
    }
    rombelInputsHTML += `
        <div class="rombel-input-group" id="rombel-${kelas}-Tunggal" style="display: none;">
            <label class="rombel-group-label">Kelas ${kelas}</label>
            <div class="murid-input-pair">
                <div class="form-group"><label>Laki-laki</label><input type="number" name="k${kelas}_rombel_tunggal_L" value="0" min="0" required></div>
                <div class="form-group"><label>Perempuan</label><input type="number" name="k${kelas}_rombel_tunggal_P" value="0" min="0" required></div>
            </div>
        </div>`;

    let agamaInputsHTML = '';
    for (const ag of agama) {
        const agId = ag.toLowerCase();
        const isIslam = ag === 'Islam';
        agamaInputsHTML += `
            <div class="form-grid agama-row">
                <div class="form-group">
                    <label>${ag}</label>
                    <select class="agama-toggle" data-kelas="${kelas}" data-agama="${agId}">
                        <option value="Ada" ${isIslam ? 'selected' : ''}>Ada</option>
                        <option value="Tidak Ada" ${!isIslam ? 'selected' : ''}>Tidak Ada</option>
                    </select>
                </div>
                <div class="agama-input-pair" id="agama-input-${kelas}-${agId}" style="display: ${isIslam ? 'grid' : 'none'};">
                    <div class="form-group"><label>Laki-laki</label><input type="number" name="k${kelas}_agama_${agId}_L" value="0" min="0" required></div>
                    <div class="form-group"><label>Perempuan</label><input type="number" name="k${kelas}_agama_${agId}_P" value="0" min="0" required></div>
                </div>
            </div>
        `;
    }
    
    return `
        <div class="form-grid">
            <div class="form-group">
                <label>Jumlah Rombel Kelas ${kelas}</label>
                <select class="rombel-toggle" name="k${kelas}_jumlah_rombel" data-kelas="${kelas}">
                    <option value="0">0</option>
                    <option value="1" selected>1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                </select>
            </div>
        </div>
        <h4 class="sub-section-title">Jumlah Murid per Rombel</h4>
        <div class="rombel-container" id="rombel-container-${kelas}">${rombelInputsHTML}</div>
        <h4 class="sub-section-title">Jumlah Murid per Agama</h4>
        <div class="agama-container">${agamaInputsHTML}</div>
    `;
    }
    function generatePtkNegeriHTML() {
    return `
    <fieldset class="ptk-fieldset">
      <legend>Data Jumlah PTK (Negeri)</legend>
      
      <fieldset class="ptk-sub-fieldset">
        <legend>Kepala Sekolah</legend>
        <div class="ptk-row ptk-grid-2">
            <div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_ks_pns" value="0" min="0" max="1"></div>
            <div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_ks_pppk" value="0" min="0" max="1"></div>
        </div>
      </fieldset>

      <fieldset class="ptk-sub-fieldset">
        <legend>Guru</legend>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Kelas</label><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_kelas_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_kelas_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_kelas_pppkpw" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_kelas_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PAI</label><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_pai_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_pai_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_pai_pppkpw" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_pai_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PJOK</label><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_pjok_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_pjok_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_pjok_pppkpw" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_pjok_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PA Kristen</label><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_kristen_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_kristen_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_kristen_pppkpw" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_kristen_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Bhs. Inggris</label><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_inggris_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Mapel Lainnya</label><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_lainnya_gtt" value="0" min="0"></div></div>
      </fieldset>

      <fieldset class="ptk-sub-fieldset">
        <legend>Tenaga Kependidikan</legend>
        <div class="ptk-row has-label ptk-grid-4"><label>Operator</label><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_tendik_operator_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_tendik_operator_pppkpw" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_operator_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Pengelola Umum</label><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_tendik_pengelola_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_tendik_pengelola_pppkpw" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_pengelola_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Penjaga Sekolah</label><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_penjaga_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Tenaga Administrasi</label><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_tas_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Pustakawan</label><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_pustakawan_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Tendik Lainnya</label><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_lainnya_ptt" value="0" min="0"></div></div>
      </fieldset>
    </fieldset>
    `;
    }

    function generatePtkSwastaHTML() {
    return `
    <fieldset class="ptk-fieldset">
      <legend>Data Jumlah PTK (Swasta)</legend>
      <fieldset class="ptk-sub-fieldset">
        <legend>Kepala Sekolah</legend>
        <div class="ptk-row ptk-grid-2">
            <div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_ks_gty" value="0" min="0" max="1"></div>
            <div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_ks_gtt" value="0" min="0" max="1"></div>
        </div>
      </fieldset>
      <fieldset class="ptk-sub-fieldset">
        <legend>Guru</legend>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Kelas</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_kelas_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_kelas_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PAI</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_pai_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_pai_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PJOK</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_pjok_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_pjok_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PA Kristen</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_kristen_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_kristen_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Bhs. Inggris</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_inggris_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_inggris_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Mapel Lainnya</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_lainnya_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_lainnya_gtt" value="0" min="0"></div></div>
      </fieldset>
      <fieldset class="ptk-sub-fieldset">
        <legend>Tenaga Kependidikan</legend>
        <div class="ptk-row has-label ptk-grid-4"><label>Operator</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_operator_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_operator_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Pengelola Umum</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_pengelola_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_pengelola_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Penjaga Sekolah</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_penjaga_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_penjaga_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Tenaga Administrasi</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_tas_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_tas_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Pustakawan</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_pustakawan_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_pustakawan_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Tendik Lainnya</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_lainnya_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_lainnya_ptt" value="0" min="0"></div></div>
      </fieldset>
    </fieldset>
    `;
    }
    
    (function setupInitialDropdowns() {
        const bulanSelect = form.querySelector('[name="laporanBulan"]');
        const tahunSelect = form.querySelector('[name="tahun"]');
        const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const d = new Date();
        const currentYear = d.getFullYear();
        const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
        bulanSelect.innerHTML = bulanOptions.map((m, i) => `<option value="${m}" ${i === prevMonthIndex ? 'selected' : ''}>${m}</option>`).join('');
        tahunSelect.innerHTML = [currentYear, currentYear - 1].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
    })();

    function setupDataSekolah(schoolLists) {
        const statusSekolah = document.getElementById('statusSekolah');
        const namaSekolah = document.getElementById('namaSekolah');
        const ptkContainer = document.getElementById('ptk-section-container');
        ptkContainer.innerHTML = `<div id="ptk-negeri">${generatePtkNegeriHTML()}</div> <div id="ptk-swasta">${generatePtkSwastaHTML()}</div>`;
        const ptkNegeri = document.getElementById('ptk-negeri');
        const ptkSwasta = document.getElementById('ptk-swasta');
        ptkNegeri.style.display = 'none';
        ptkSwasta.style.display = 'none';
        statusSekolah.addEventListener('change', function() {
            const status = this.value;
            const schoolList = status === 'Negeri' ? schoolLists.SDN : schoolLists.SDS;
            namaSekolah.innerHTML = '<option value="" disabled selected>-- Pilih Sekolah --</option>';
            schoolList.forEach(school => namaSekolah.add(new Option(school, school)));
            namaSekolah.disabled = false;
            if (status === 'Negeri') {
                ptkNegeri.style.display = 'block';
                ptkSwasta.style.display = 'none';
            } else if (status === 'Swasta') {
                ptkNegeri.style.display = 'none';
                ptkSwasta.style.display = 'block';
            }
        });
    }

    function setupDataMurid() {
        const tabsContainer = document.getElementById('kelas-tabs');
        const contentContainer = document.getElementById('kelas-content-container');
        for (let i = 1; i <= 6; i++) {
            tabsContainer.innerHTML += `<button type="button" class="tab-link ${i === 1 ? 'active' : ''}" data-kelas="${i}">Kelas ${i}</button>`;
            const content = document.createElement('div');
            content.id = `kelas-content-${i}`;
            content.className = 'tab-content';
            content.style.display = i === 1 ? 'block' : 'none';
            content.innerHTML = generateKelasHTML(i);
            contentContainer.appendChild(content);
            document.getElementById(`rombel-${i}-Tunggal`).style.display = 'block';
        }
        tabsContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('tab-link')) {
                document.querySelectorAll('.tab-link').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
                e.target.classList.add('active');
                document.getElementById(`kelas-content-${e.target.dataset.kelas}`).style.display = 'block';
            }
        });
        contentContainer.addEventListener('change', function(e) {
            const target = e.target;
            if (target.classList.contains('rombel-toggle')) {
                const kelas = target.dataset.kelas;
                const count = parseInt(target.value, 10);
                document.querySelectorAll(`#rombel-container-${kelas} .rombel-input-group`).forEach(el => el.style.display = 'none');
                if (count === 1) {
                    document.getElementById(`rombel-${kelas}-Tunggal`).style.display = 'block';
                } else if (count === 2) {
                    document.getElementById(`rombel-${kelas}-A`).style.display = 'block';
                    document.getElementById(`rombel-${kelas}-B`).style.display = 'block';
                } else if (count === 3) {
                    document.getElementById(`rombel-${kelas}-A`).style.display = 'block';
                    document.getElementById(`rombel-${kelas}-B`).style.display = 'block';
                    document.getElementById(`rombel-${kelas}-C`).style.display = 'block';
                }
            }
            if (target.classList.contains('agama-toggle')) {
                const kelas = target.dataset.kelas;
                const agama = target.dataset.agama;
                const show = target.value === 'Ada';
                document.getElementById(`agama-input-${kelas}-${agama}`).style.display = show ? 'grid' : 'none';
            }
        });
    }

    showAppModal('loading', 'Memuat data sekolah...');
    google.script.run
        .withSuccessHandler(schoolLists => {
            setupDataSekolah(schoolLists);
            setupDataMurid();
            document.getElementById('appModal').classList.remove('show');
        })
        .withFailureHandler(err => showAppModal('error', `Gagal memuat data sekolah: ${err.message}`))
        .getSdSchoolLists();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showAppModal('loading', 'Mengirim data dan mengunggah file...');
        const file = document.getElementById('fileLapbul').files[0];
        if (!file || file.size > 300 * 1024) {
            showAppModal('error', 'File PDF dengan ukuran maksimal 300 KB harus dipilih.');
            submitButton.disabled = false;
            return;
        }
        const reader = new FileReader();
        reader.onload = event => {
            const fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
            const formData = Object.fromEntries(new FormData(form));
            formData.fileData = fileData;
            google.script.run
                .withSuccessHandler(response => showAppModal('success', response, 'lapbul_riwayat'))
                .withFailureHandler(error => {
                    showAppModal('error', `Gagal: ${error.message}`);
                    submitButton.disabled = false;
                })
                .processLapbulFormSd(formData);
        };
        reader.readAsDataURL(file);
    });
}

function initLapbulRiwayatPage() {
    let allDataRows = [], headerCols = [], currentPage = 1, rowsPerPage = 15, currentFilteredRows = [];

    function buildTable() {
        const tableBody = document.getElementById('lapbulRiwayatTable').querySelector('tbody');
        if (!tableBody) return;
        tableBody.innerHTML = '';
        const pageCount = Math.max(1, Math.ceil(currentFilteredRows.length / rowsPerPage));
        if (currentPage > pageCount) currentPage = pageCount;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = currentFilteredRows.slice(start, end);

        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${headerCols.length + 1}">Tidak ada data riwayat.</td></tr>`;
        } else {
            paginatedRows.forEach((cols, index) => {
                const tr = document.createElement('tr');
                let rowHTML = `<td>${start + index + 1}</td>`;
                cols.forEach((cellData, i) => {
                    cellData = cellData || '-';
                    // Kolom H adalah kolom ke-8 (indeks 7)
                    if (i === 7 && typeof cellData === 'string' && cellData.startsWith('http')) {
                        rowHTML += `<td class="view-btn-container"><a href="${cellData}" target="_blank" class="action-btn view-btn"><i class="fas fa-eye"></i> Lihat</a></td>`;
                    } else {
                        rowHTML += `<td>${cellData}</td>`;
                    }
                });
                tr.innerHTML = rowHTML;
                tableBody.appendChild(tr);
            });
        }
        setupPagination();
    }

    function setupPagination() {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        if (pageCount <= 1) { paginationContainer.style.display = 'none'; return; }
        paginationContainer.style.display = 'flex';
        const pageInfo = document.createElement('span');
        pageInfo.className = 'page-info';
        pageInfo.textContent = `Halaman ${currentPage} dari ${pageCount}`;
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '«';
        prevBtn.className = 'page-btn';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; buildTable(); } };
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '»';
        nextBtn.className = 'page-btn';
        nextBtn.disabled = currentPage === pageCount;
        nextBtn.onclick = () => { if (currentPage < pageCount) { currentPage++; buildTable(); } };
        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('lapbulRiwayatTable').querySelector('thead');
        const tableBody = document.getElementById('lapbulRiwayatTable').querySelector('tbody');
        
        if (!dataArray || dataArray.length < 2) {
            loadingStatus.innerHTML = "<p>Tidak ada data riwayat untuk ditampilkan.</p>"; return;
        }
        headerCols = dataArray[0].map(h => String(h).trim());
        allDataRows = dataArray.slice(1);
        currentFilteredRows = allDataRows; // Tidak ada filter, jadi semua data ditampilkan
        
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th>No.</th>';
        headerCols.forEach(header => { headerRow.innerHTML += `<th>${header}</th>`; });
        tableHead.innerHTML = '';
        tableHead.appendChild(headerRow);
        
        const dummyRow = createDummyRow(tableBody, headerCols.length + 1);
        rowsPerPage = calculateRowsPerPage('lapbulRiwayatTable');
        tableBody.innerHTML = '';

        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'block';
        buildTable();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getLapbulRiwayatData();

    window.addEventListener('resize', debounce(() => {
        if (document.getElementById('lapbulRiwayatTable')) {
            rowsPerPage = calculateRowsPerPage('lapbulRiwayatTable');
            buildTable();
        }
    }));
}

/**
 * ===================================================================
 * =================== 3. OBJEK INISIALISASI & TRIGGER ===============
 * ===================================================================
 */

const pageInitializers = {
    'home': initHomePage,
    'sk_menu': initSubMenuPage,
    'sk_unggah': initSkUnggahPage,
    'sk_riwayat': initSkRiwayatPage,
    'sk_status': initSkStatusPage,
    'sk_kelola': initSkKelolaPage,
    'sk_edit': initSkEditPage,
    'sk_arsip': initSkArsipPage,
    'lapbul_menu': initSubMenuPage,
    'lapbul_unggah': initLapbulUnggahPage,
    'lapbul_form_paud': initLapbulFormPaudPage,
    'lapbul_form_sd': initLapbulFormSdPage,
    'lapbul_riwayat': initLapbulRiwayatPage, // <-- TAMBAHKAN INI
    'lapbul_status': initSubMenuPage,
    'ptk_menu': initSubMenuPage,
    'murid_menu': initSubMenuPage,
    'siaba_menu': initSubMenuPage,
    'pns_menu': initSubMenuPage,
    'rapor_pendidikan_menu': initSubMenuPage,
    'tata_naskah_menu': initSubMenuPage,
    'mutasi_murid_menu': initSubMenuPage,
    'tapera_sitara_menu': initSubMenuPage,
    'administrasi_sekolah_menu': initSubMenuPage,
    'data_sekolah_menu': initSubMenuPage,
    'komunitas_belajar_menu': initSubMenuPage,
    'gelar_karya_menu': initSubMenuPage
};

document.addEventListener('DOMContentLoaded', () => {
    loadPage(null, 'home');

    document.body.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        if (!link) return;

        const pageName = link.dataset.page;
        const isSubmenuToggle = link.hasAttribute('data-page-parent');

        if (isSubmenuToggle) {
            e.preventDefault();
            link.parentElement.classList.toggle('open');
        }

        if (pageName) {
            e.preventDefault();
            loadPage(null, pageName);
        }
    });
});
</script>


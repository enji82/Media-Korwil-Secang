<div id="appModal" class="modal-overlay">
    <div class="modal-content">
        <div id="modalSpinner" style="display: none;"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div></div>
        <h3 id="modalTitle"></h3>
        <p id="modalMessage"></p>
        <div class="modal-actions">
            <button id="modalOkBtn" class="submit-btn" style="background-color: #3498db;">OK</button>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="deleteModalTitle">Konfirmasi Hapus</h3>
        <div id="deleteModalBody"></div>
        <div class="modal-actions">
            <button id="cancelDeleteBtn" class="cancel-btn">Batal</button>
            <button id="confirmDeleteBtn" class="delete-btn-confirm">Ya, Hapus</button>
        </div>
    </div>
</div>

<script>
/**
 * ===================================================================
 * ======================= 1. FUNGSI INTI & UTILITAS =================
 * ===================================================================
 */
 
// DEKLARASI NAMESPACE UTAMA
const App = {};

App.showAppModal = (state, message, redirectPage = null) => {
    const modal = document.getElementById('appModal');
    const spinner = document.getElementById('modalSpinner');
    const title = document.getElementById('modalTitle');
    const msg = document.getElementById('modalMessage');
    const okBtn = document.getElementById('modalOkBtn');
    spinner.style.display = 'none';
    okBtn.style.display = 'block';
    msg.innerHTML = message;
    if (state === 'loading') {
        title.textContent = "Memproses...";
        spinner.style.display = 'block';
        okBtn.style.display = 'none';
    } else if (state === 'success') {
        title.textContent = 'Sukses!';
        title.style.color = '#27ae60';
        okBtn.textContent = 'OK';
        okBtn.onclick = () => {
            modal.classList.remove('show');
            if (redirectPage) App.loadPage(null, redirectPage);
        };
    } else if (state === 'info') {
        title.textContent = 'Informasi Penting';
        title.style.color = '#00c3ff';
        okBtn.textContent = 'Mengerti';
        okBtn.onclick = () => modal.classList.remove('show');
    } else { // 'error'
        title.textContent = 'Error!';
        title.style.color = '#e74c3c';
        okBtn.textContent = 'OK';
        okBtn.onclick = () => modal.classList.remove('show');
    }
    modal.classList.add('show');
};

App.loadPage = (event, pageName, params = {}) => {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    const contentArea = document.getElementById('main-content');
    contentArea.innerHTML = '<div class="loading-container"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div><p>Memuat halaman...</p></div>';
    
    google.script.run
        .withSuccessHandler(html => {
            try {
                contentArea.innerHTML = html;
                if (typeof App.pageInitializers !== 'undefined' && typeof App.pageInitializers[pageName] === 'function') {
                    App.pageInitializers[pageName](params);
                }
                App.updateActiveMenu(pageName);
            } catch (e) {
                console.error("Client-side error after loading page:", e);
                contentArea.innerHTML = `<div class="error-box" style="padding: 20px; background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c; border-radius: 8px; color: white;"><h3>Error JavaScript di Browser!</h3><p><strong>Pesan:</strong> ${e.message}</p><p><strong>Stack:</strong> ${e.stack}</p></div>`;
            }
        })
        .withFailureHandler(err => {
            console.error("Server-side error during include:", err);
            contentArea.innerHTML = `<div class="error-box" style="padding: 20px; background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c; border-radius: 8px; color: white;"><h3>Gagal Memuat Konten!</h3><p>Pastikan file HTML 'page_${pageName}.html' ada dan namanya sudah benar.</p><p><strong>Pesan Server:</strong> ${err.message}</p></div>`;
        })
        .include('page_' + pageName);
};

App.updateActiveMenu = (pageName) => {
    document.querySelectorAll('.sidebar-menu a').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.sidebar-menu .has-submenu').forEach(el => el.classList.remove('open'));

    let activeLink = document.querySelector(`.sidebar-menu a[data-page="${pageName}"]`);
    let startElement = null;

    if (activeLink) {
        activeLink.classList.add('active');
        startElement = activeLink;
    } else {
        const parentPageName = pageName.split('_').slice(0, -1).join('_');
        const parentLink = document.querySelector(`.sidebar-menu a[data-page-parent="${parentPageName}"]`);
        
        if (parentLink) {
            parentLink.classList.add('active');
            parentLink.parentElement.classList.add('open');
            startElement = parentLink;
        }
    }

    if (!startElement) return;

    let parent = startElement.closest('.has-submenu');
    while (parent) {
        parent.classList.add('open');
        const parentAnchor = parent.querySelector('a[data-page-parent]');
        if (parentAnchor) {
            parentAnchor.classList.add('active');
        }
        parent = parent.parentElement.closest('.has-submenu');
    }
};

App.debounce = (func, timeout = 150) => {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => { func.apply(this, args); }, timeout);
    };
};

const parseCustomDateTime = (dateStr) => {
    // Pastikan input adalah string, bersihkan spasi ekstra, dan periksa null/kosong
    const cleanedStr = String(dateStr).trim();
    if (!cleanedStr || cleanedStr === '-') return 0;
    
    // RegEx yang disederhanakan untuk menangkap format dd/MM/yyyy HH:mm:ss
    const parts = cleanedStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s(\d{1,2}):(\d{1,2}):(\d{1,2})/);

    if (parts && parts.length === 7) {
        // parts[1]: Tanggal (d)
        // parts[2]: Bulan (M) - Kritis: Harus dikurangi 1 (0 = Januari)
        // parts[3]: Tahun (yyyy)
        // parts[4]: Jam (HH)
        // parts[5]: Menit (mm)
        // parts[6]: Detik (ss)
        
        // Buat objek Date. (Bulan: parts[2] - 1)
        return new Date(parts[3], parts[2] - 1, parts[1], parts[4], parts[5], parts[6]).getTime();
    }
    
    // Fallback: Coba konversi sebagai string yang hanya berisi tanggal (dd/MM/yyyy)
    const dateOnly = cleanedStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (dateOnly) {
        return new Date(dateOnly[3], dateOnly[2] - 1, dateOnly[1]).getTime();
    }
    
    return 0; // Jika tidak ada yang cocok, disortir ke posisi paling akhir
};

App.setupInfoDropdown = (buttonId, contentId, infoItems) => {
    const infoBtn = document.getElementById(buttonId);
    const contentDiv = document.getElementById(contentId);
    if (!infoBtn || !contentDiv) return;
    let isDataLoaded = false;
    if (infoItems && infoItems.length > 0) {
        const infoContent = `<ul style="text-align: left; padding: 10px 20px 10px 35px; line-height: 1.6; margin: 0;">${infoItems.map(item => `<li>${item}</li>`).join('')}</ul>`;
        contentDiv.innerHTML = infoContent;
        isDataLoaded = true;
    } else {
        contentDiv.innerHTML = '<p style="padding: 15px;">Informasi tidak ditemukan.</p>';
    }
    infoBtn.onclick = function() {
        const isOpen = this.classList.toggle('active');
        contentDiv.style.maxHeight = isOpen ? contentDiv.scrollHeight + "px" : "0px";
    };
};

const applySorting = (sortConfig) => {
    if (!sortConfig || currentFilteredRows.length === 0) return;

    currentFilteredRows.sort((a, b) => {
        for (let i = 0; i < sortConfig.length; i++) {
            const conf = sortConfig[i];
            
            // Tentukan parser, default adalah fungsi identitas jika tidak ada
            const parser = conf.parser || ((val) => val); 

            // Ambil nilai dan pastikan nilai yang tidak ada (null/undefined) menjadi 0 (untuk disortir terakhir)
            const valA = parser(a[conf.column]) || 0; 
            const valB = parser(b[conf.column]) || 0; 

            const comparison = (valA > valB) ? 1 : (valA < valB) ? -1 : 0;

            if (comparison !== 0) {
                return conf.order === 'DESC' ? -comparison : comparison;
            }
        }
        return 0;
    });

    // Setelah disortir, bangun ulang tabel
    buildTable(); 
};

// ===============================================================
// === FUNGSI GENERIK TABEL DITEMPATKAN DI SINI (SEBELUM INIT) ===
// ===============================================================

App.initializeGenericTablePage = (config) => {
    // VARIABEL LOKAL: Dideklarasikan di awal untuk diakses oleh semua fungsi di bawah
    let allDataRows = [], headerCols = [], currentFilteredRows = [], currentPage = 1, rowsPerPage = 15;
    let isDoubleHeader = false; // Dihapus karena tidak digunakan dalam lapbul
    let headerRow1 = [], headerRow2 = []; // Dihapus karena tidak digunakan dalam lapbul
    let filterData = null;
    
    config.filters = config.filters || [];
    
    // --- FUNGSI HELPER LOKAL (Dipindahkan ke dalam scope untuk stabilitas) ---
    const getRowValue = (row, key) => {
        const isDataNested = config.tableId === 'kelolaTable' || config.tableId === 'lapbulKelolaTable' || config.tableId === 'kelolaPtkPaudTable' || config.tableId === 'kelolaPtkSdTable';
        return isDataNested ? (row.data ? row.data[key] : row[key]) : row[key];
    };
    
    // FUNGSI PARSER UNTUK SORTING TANGGAL (Mengatasi masalah pengurutan)
    const parseCustomDateTime = (dateStr) => {
        const cleanedStr = String(dateStr).trim();
        if (!cleanedStr || cleanedStr === '-') return 0;
        // Format: dd/MM/yyyy HH:mm:ss
        const parts = cleanedStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s(\d{1,2}):(\d{1,2}):(\d{1,2})/);
        if (parts && parts.length === 7) {
            // new Date(tahun, bulan(0-11), tanggal, jam, menit, detik)
            return new Date(parts[3], parts[2] - 1, parts[1], parts[4], parts[5], parts[6]).getTime();
        }
        const dateOnly = cleanedStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
        if (dateOnly) {
            return new Date(dateOnly[3], dateOnly[2] - 1, dateOnly[1]).getTime();
        }
        return 0;
    };
    
    // FUNGSI SORTING
    const applySorting = (dataArray, sortConfig) => {
        if (!sortConfig || dataArray.length === 0) return dataArray;

        dataArray.sort((a, b) => {
            for (let i = 0; i < sortConfig.length; i++) {
                const conf = sortConfig[i];
                const parser = conf.parser || ((val) => val); 
                
                const valA = parser(a[conf.column]) || 0; 
                const valB = parser(b[conf.column]) || 0; 

                const comparison = (valA > valB) ? 1 : (valA < valB) ? -1 : 0;

                if (comparison !== 0) {
                    return conf.order === 'DESC' ? -comparison : comparison;
                }
            }
            return 0;
        });
        return dataArray; 
    };
    
    // FUNGSI UTAMA RENDERING (buildTable)
    const calculateRowsPerPage = () => {
        const tableContainer = document.getElementById(config.tableId)?.closest('.table-container');
        if (!tableContainer) return 15;
        const paginationContainer = document.getElementById('pagination-container');
        const bottomOffset = paginationContainer ? 180 : 100;
        const rowHeight = 38;
        const availableHeight = window.innerHeight - tableContainer.getBoundingClientRect().top - bottomOffset;
        return Math.max(5, Math.floor(availableHeight / rowHeight));
    };

    const setupPagination = () => {
        const paginationContainer = document.getElementById('pagination-container');
        if (!paginationContainer) return;

        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        
        if (pageCount <= 1) {
            paginationContainer.style.display = 'none';
            return;
        }
        
        paginationContainer.style.display = 'flex';
        const pageInfo = `<span class="page-info">Halaman ${currentPage} dari ${pageCount}</span>`;
        const prevBtn = `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="App.changePage(-1)">«</button>`;
        const nextBtn = `<button class="page-btn" ${currentPage === pageCount ? 'disabled' : ''} onclick="App.changePage(1)">»</button>`;
        
        paginationContainer.innerHTML = prevBtn + pageInfo + nextBtn;
    };

    App.changePage = (direction) => {
        currentPage += direction;
        buildTable();
    };

    const buildTable = () => {
        const table = document.getElementById(config.tableId);
        if (!table) return;
        const tableBody = document.getElementById(config.tableId + 'Body') || table.querySelector('tbody');
        const tableFoot = table.querySelector('tfoot');
        if (!tableBody) return;
        
        tableBody.innerHTML = '';
        if (tableFoot) tableFoot.innerHTML = '';

        const usePagination = !!document.getElementById('pagination-container');
        let paginatedRows = currentFilteredRows;
        
        if (usePagination) {
            rowsPerPage = calculateRowsPerPage();
            const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage) || 1;
            currentPage = Math.min(currentPage, pageCount) || 1;
            const start = (currentPage - 1) * rowsPerPage;
            paginatedRows = currentFilteredRows.slice(start, start + rowsPerPage);
            setupPagination();
        }

        if (paginatedRows.length === 0) {
            const colspan = headerCols.length + 1;
            tableBody.innerHTML = `<tr><td colspan="${colspan}">Tidak ada data yang cocok dengan filter.</td></tr>`;
        } else {
            const AppLoadPage = typeof App.loadPage === 'function' ? App.loadPage : console.error;
            const AppShowDelete = typeof App.showDeleteConfirmation === 'function' ? App.showDeleteConfirmation : console.error;
            
            paginatedRows.forEach((row, index) => {
                const tr = document.createElement('tr');
                const rowNumber = usePagination ? (currentPage - 1) * rowsPerPage + index + 1 : index + 1;
                let rowCells = [`<td>${rowNumber}</td>`];
                
                headerCols.forEach(header => {
                    const cellData = row[header] ?? '';
                    
                    if (header === 'Dokumen' && String(cellData).startsWith('http')) {
                        rowCells.push(`<td class="view-btn-container"><a href="${cellData}" target="_blank" class="action-btn view-btn"><i class="fas fa-eye"></i> Lihat</a></td>`);
                    } else if (header === 'Aksi') {
                        const rowIndex = row._rowIndex;
                        const source = row._source;
                        const rowInfoString = JSON.stringify(row).replace(/'/g, "\\'");
                        
                        let dynamicEditPage = config.editPage || 'lapbul_edit_sd'; 
                        if (config.tableId === 'lapbulKelolaTable') {
                            dynamicEditPage = (source === 'PAUD') ? 'lapbul_edit_paud' : 'lapbul_edit_sd';
                        }

                        if (rowIndex !== undefined && typeof AppLoadPage === 'function' && typeof AppShowDelete === 'function') {
                            rowCells.push(
                                `<td class="action-buttons">` +
                                `<button class="action-btn edit-btn" onclick="App.loadPage(event, '${dynamicEditPage}', { rowIndex: ${rowIndex}, source: '${source}' })"><i class="fas fa-pencil-alt"></i> Edit</button>` +
                                `<button class="action-btn delete-btn" onclick='App.showDeleteConfirmation(this)' data-row-info='${rowInfoString}'><i class="fas fa-trash"></i> Hapus</button>` +
                                `</td>`
                            );
                        } else {
                            rowCells.push('<td>-</td>');
                        }
                    } else {
                        let displayCell = (cellData === '' || cellData === null || cellData == 0) ? '-' : cellData;
                        rowCells.push(`<td>${displayCell}</td>`);
                    }
                });
                tr.innerHTML = rowCells.join('');
                tableBody.appendChild(tr);
            });
        }
    }; // END buildTable

    // ... (Logika filter dan setup listeners) ...
    const handleFilterChange = () => {
        applyFilters();
    };

    const debouncedFilterChange = App.debounce(handleFilterChange, 300);

    const setupEventListeners = () => {
        const searchInput = document.getElementById('searchFilter');
        if (searchInput) {
            searchInput.removeEventListener('input', debouncedFilterChange);
            searchInput.addEventListener('input', debouncedFilterChange);
        }
        
        config.filters.forEach(filterConf => {
            const dropdown = document.getElementById(filterConf.id);
            if (dropdown) {
                dropdown.removeEventListener('change', handleFilterChange);
                dropdown.addEventListener('change', handleFilterChange);
            }
        });
    };
    
    const applyFilters = () => {
        let filtered = allDataRows;
        
        // 1. Amankan Sorting Awal
        if (config.initialSort && filtered.length > 0) {
            filtered = applySorting(filtered, config.initialSort); 
        }

        // 2. Filter Search Input
        const searchInput = document.getElementById('searchFilter');
        const searchTerm = searchInput ? String(searchInput.value).toLowerCase() : '';

        if (searchTerm) {
            filtered = filtered.filter(row => {
                const targetRow = isDataNested ? row.data : row;

                return Object.keys(targetRow).some(key => {
                    const cellValue = String(targetRow[key] ?? '').toLowerCase();
                    return cellValue.includes(searchTerm);
                });
            });
        }
        
        // 3. Filter Dropdown Inputs
        config.filters.forEach(filterConf => {
            const dropdown = document.getElementById(filterConf.id);
            if (dropdown && dropdown.value) {
                const filterValue = dropdown.value;
                const filterKey = filterConf.dataColumn;
                
                filtered = filtered.filter(row => {
                    const rowValue = getRowValue(row, filterKey);
                    return String(rowValue).trim() === filterValue;
                });
            }
        });

        currentFilteredRows = filtered;
        currentPage = 1;
        buildTable();
    };

    const populateCascadingFilters = (data) => {
        filterData = data;
        
        // Populate non-cascading
        config.filters.forEach(filterConf => {
            if (filterConf.type !== 'cascading-local') {
                const dropdown = document.getElementById(filterConf.id);
                const filterKey = filterConf.dataColumn || filterConf.key;
                
                if (dropdown && dropdown.tagName === 'SELECT' && filterKey) {
                    const uniqueValues = [...new Set(allDataRows.map(row => String(getRowValue(row, filterKey))))].filter(Boolean).sort();
                    
                    const defaultText = filterConf.defaultText || 'Semua';
                    dropdown.innerHTML = `<option value="">${defaultText}</option>`;
                    uniqueValues.forEach(value => {
                        dropdown.innerHTML += `<option value="${value}">${value}</option>`;
                    });
                }
            }
        });

        // Logika Casading (Local Filtering)
        config.filters.forEach(filterConf => {
            if (filterConf.type === 'cascading-local') {
                const dropdown = document.getElementById(filterConf.id);
                const parentDropdown = document.getElementById(filterConf.parent);
                
                if (dropdown && parentDropdown) {
                    const updateDropdown = () => {
                        const selectedParentValue = parentDropdown.value;
                        const keyChild = filterConf.dataColumn || filterConf.key;
                        const keyParent = filterConf.parentKey;
                        
                        dropdown.innerHTML = '<option value="">Semua Sekolah</option>';
                        
                        if (selectedParentValue) {
                            const uniqueChildValues = [...new Set(allDataRows
                                .filter(row => String(getRowValue(row, keyParent)).trim() === selectedParentValue)
                                .map(row => String(getRowValue(row, keyChild))))].filter(Boolean).sort();

                            uniqueChildValues.forEach(value => {
                                dropdown.innerHTML += `<option value="${value}">${value}</option>`;
                            });
                        }
                        
                        handleFilterChange();
                    };

                    parentDropdown.removeEventListener('change', updateDropdown);
                    parentDropdown.addEventListener('change', updateDropdown);
                    
                    dropdown.removeEventListener('change', handleFilterChange);
                    dropdown.addEventListener('change', handleFilterChange);
                    
                    updateDropdown();
                }
            }
        });
    };

    // KUNCI PERBAIKAN STUCK SPINNER: Mengamankan akses elemen
    const finalizeSetup = (hasError = false) => {
        const loadingEl = document.getElementById('loadingStatus');
        if (loadingEl) {
            loadingEl.style.display = 'none';
        }
        
        if (!hasError) {
            const wrapperEl = document.getElementById('tableWrapper');
            if (wrapperEl) {
                wrapperEl.style.display = 'block';
            }
            
            setupEventListeners();
            
            // Panggil applyFilters yang sudah termasuk initialSort
            applyFilters();
        }
    };

    const serverFunction = config.serverFunction;
    const filterFunction = config.filterFunction;
    
    // Server Call
    google.script.run
        .withSuccessHandler(data => {
            
            if (data.error) { 
                document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Error dari Server: ${data.error}</p>`;
                finalizeSetup(true);
                return;
            }

            allDataRows = data.rows || data; 
            headerCols = data.headers;

            // Membangun header tabel awal
            const tableHead = document.querySelector(`#${config.tableId} thead`);
            if (tableHead) {
                tableHead.innerHTML = `<tr><th>No.</th>${headerCols.map(h => `<th>${h}</th>`).join('')}</tr>`;
            }
            
            // --- LOGIKA FILTERING ---
            if (filterFunction) {
                google.script.run
                    .withSuccessHandler(filterResult => {
                        if (filterResult.error) {
                            document.getElementById('loadingStatus').innerHTML = `<p style="color:orange;">Gagal memuat filter: ${filterResult.error}. Tabel ditampilkan tanpa filter.</p>`;
                            filterData = {};
                        } else {
                            populateCascadingFilters(filterResult); 
                        }
                        finalizeSetup();
                    })
                    .withFailureHandler(error => {
                        document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat filter data: ${error.message}</p>`;
                        finalizeSetup(true);
                    })
                    [filterFunction](); 
            } else {
                populateCascadingFilters(null); 
                finalizeSetup(); 
            }
        })
        .withFailureHandler(error => { 
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
            finalizeSetup(true);
        })
        [serverFunction]();
};

// ===============================================================
// === "MESIN" UTAMA UNTUK FORMULIR BERTINGKAT (VERSI FINAL) ===
// ===============================================================
App.setupTabForm = (formId) => {
    const form = document.getElementById(formId);
    if (!form) return;

    const navButtons = form.querySelectorAll('.tab-link');
    const contentDivs = form.querySelectorAll('.tab-content-form');
    let currentTabIndex = 0;
    let maxUnlockedTabIndex = 0;
    const customValidations = {};

    function updateTabStates() {
        navButtons.forEach((btn, index) => {
            btn.disabled = index > maxUnlockedTabIndex;
            btn.classList.toggle('active', index === currentTabIndex);
        });
        contentDivs.forEach((div, index) => div.classList.toggle('active', index === currentTabIndex));
        if (document.getElementById('tab-content-wrapper')) {
            document.getElementById('tab-content-wrapper').scrollTop = 0;
        }
    }

    function showTab(tabIndex) {
        if (tabIndex > maxUnlockedTabIndex && tabIndex > 0) return;
        currentTabIndex = tabIndex;
        updateTabStates();
    }

    function validateTab(tabIndex) {
        const tabContent = contentDivs[tabIndex];
        const fields = tabContent.querySelectorAll('[required]');
        let isValid = true;
        tabContent.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
        fields.forEach(field => {
            let fieldIsValid = true;
            if (field.type === 'file') {
                if (field.files.length === 0) fieldIsValid = false;
            } else if (!field.value) {
                fieldIsValid = false;
            } else if (field.name === 'jumlahRombel' && field.value === '0') {
                fieldIsValid = false;
            }
            if (!fieldIsValid) {
                isValid = false;
                field.classList.add('input-error');
            }
        });
        return isValid;
    }
    
    updateTabStates(); 

    form.addEventListener('click', (e) => {
        const target = e.target;
        if (target.matches('.tab-link:not(:disabled)')) { showTab(Array.from(navButtons).indexOf(target)); }
        if (target.matches('.prev-tab-btn')) { showTab(currentTabIndex - 1); }
        if (target.matches('.next-tab-btn')) {
            let validationFunction = customValidations[currentTabIndex] || (() => validateTab(currentTabIndex));
            if (validationFunction()) {
                maxUnlockedTabIndex = currentTabIndex + 1;
                showTab(currentTabIndex + 1);
            }
        }
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        // Logika submit tetap sama
    });
    
    if (!document.getElementById('form-error-style')) {
        const style = document.createElement('style');
        style.id = 'form-error-style';
        style.textContent = '.input-error { border: 2px solid var(--color-red) !important; animation: shake 0.5s; } @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }';
        document.head.appendChild(style);
    }
    
    return {
        setTabValidation: function(tabIndex, validationFunction) {
            customValidations[tabIndex] = validationFunction;
        },
        unlockAndShowTab: function(tabIndex) {
            if (tabIndex > maxUnlockedTabIndex) {
                maxUnlockedTabIndex = tabIndex;
            }
            showTab(tabIndex);
        }
    };
};

/**
 * ===================================================================
 * ======================= 2. SEMUA FUNGSI INISIALISASI HALAMAN ======
 * ===================================================================
 */

function initMenuPage() {
    // Fungsi ini berlaku untuk semua halaman menu yang menggunakan .menu-button
    document.querySelectorAll('#main-content .menu-button').forEach((button, index) => {
        button.style.animationDelay = `${index * 0.07}s`;
    });
}

function initSkUnggahPage() {
    const form = document.getElementById('manualUploadForm');
    if (!form) return;

    function populateSingleDropdown(elementId, optionsArray, defaultText) {
        const dropdown = document.getElementById(elementId);
        if (!dropdown) return;
        dropdown.innerHTML = `<option value="" disabled selected>${defaultText}</option>`;
        if (optionsArray && optionsArray.length > 0) {
            optionsArray.forEach(item => {
                let option = document.createElement("option");
                option.value = item;
                option.textContent = item;
                dropdown.appendChild(option);
            });
        }
    }

    google.script.run
        .withSuccessHandler(optionsObject => {
            populateSingleDropdown("namaSD", optionsObject["Nama SD"], "Pilih Sekolah");
            populateSingleDropdown("tahunAjaran", optionsObject["Tahun Ajaran"], "Pilih Tahun Ajaran");
            populateSingleDropdown("semester", optionsObject["Semester"], "Pilih Semester");
            populateSingleDropdown("kriteriaSK", optionsObject["Kriteria SK"], "Pilih Kriteria SK");
        })
        .withFailureHandler(error => console.error('Gagal memuat opsi form SK:', error))
        .getMasterSkOptions();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = document.getElementById('submitBtn');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Sedang memproses dan mengunggah file...');
        const file = document.getElementById('fileUpload').files[0];
        if (!file || file.size > 1024 * 1024) {
            App.showAppModal('error', 'Unggah scan file format PDF ukuran maksimal 1 MB.');
            submitButton.disabled = false;
            return;
        }
        const reader = new FileReader();
        reader.onload = event => {
            const fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
            const formData = {
                namaSD: form.namaSD.value,
                tahunAjaran: form.tahunAjaran.value,
                semester: form.semester.value,
                kriteriaSK: form.kriteriaSK.value,
                nomorSK: form.nomorSK.value,
                tanggalSK: form.tanggalSK.value,
                fileData: fileData
            };
            google.script.run
                .withSuccessHandler(response => App.showAppModal('success', response, 'sk_riwayat'))
                .withFailureHandler(error => {
                    App.showAppModal('error', `Gagal menyimpan: ${error.message}`);
                    submitButton.disabled = false;
                })
                .processManualForm(formData);
        };
        reader.readAsDataURL(file);
    });
}

function initSkRiwayatPage() {
    App.initializeGenericTablePage({
        tableId: 'riwayatTable', 
        serverFunction: 'getSKRiwayatData', 
        // Menggunakan filter mandiri (Non-Cascading)
        filters: [ 
            // Tahun Ajaran
            { id: 'filterTahun', dataColumn: 'Tahun Ajaran', type: 'dropdown', sortReverse: true, defaultText: 'Semua Tahun' },
            
            // Semester
            { id: 'filterSemester', dataColumn: 'Semester', type: 'dropdown', defaultText: 'Semua Semester' },
            
            // Nama Sekolah
            { id: 'filterNamaSekolah', dataColumn: 'Nama SD', type: 'dropdown', defaultText: 'Semua Sekolah' }
        ]
    });
}

function initSkStatusPage() {
    // Panggil fungsi generik dengan konfigurasi yang tepat
    App.initializeGenericTablePage({
        tableId: 'statusTable',
        serverFunction: 'getSKStatusData', // Memanggil fungsi baru yang sudah kita perbaiki
        filterConfig: [] // Halaman ini tidak memiliki filter, jadi array-nya kosong
    });
}

function initSkKelolaPage() {
    App.initializeGenericTablePage({
        tableId: 'kelolaTable', // ID tabel di page_sk_kelola.html
        serverFunction: 'getSKKelolaData', // Fungsi server untuk Kelola Data SK
        editPage: 'sk_edit', // KUNCI PERBAIKAN: Menambahkan halaman tujuan edit
        filters: [
            // Filter Tahun Ajaran
            { 
                id: 'filterTahun', 
                dataColumn: 'Tahun Ajaran', 
                type: 'dropdown', 
                sortReverse: true, 
                defaultText: 'Semua Tahun' 
            },
            
            // Filter Semester
            { 
                id: 'filterSemester', 
                dataColumn: 'Semester', 
                type: 'dropdown', 
                defaultText: 'Semua Semester' 
            },
            
            // Filter Nama Sekolah
            { 
                id: 'filterNamaSekolah', 
                dataColumn: 'Nama SD', 
                type: 'dropdown', 
                defaultText: 'Semua Sekolah' 
            }
        ]
    });

    // **AWAL BLOK KODE PERBAIKAN UNTUK FUNGSI HAPUS**

    // Fungsi untuk menampilkan konfirmasi hapus (langkah 1)
    App.showDeleteConfirmation = (button) => {
        const rowInfo = JSON.parse(button.dataset.rowInfo);
        const modal = document.getElementById('deleteModal');
        if (!modal) return;

        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');
        const cancelBtn = modal.querySelector('#cancelDeleteBtn');
        
        // Tentukan jenis data untuk pesan
        const isSk = rowInfo._source === 'SK';
        const isPaud = rowInfo._source === 'PAUD';
        const isSd = rowInfo._source === 'SDN' || rowInfo._source === 'SDS';
        const isLapbul = rowInfo._source === 'PAUD_LAPBUL' || rowInfo._source === 'SD_LAPBUL' || (!isSk && !isPaud && !isSd);

        let infoHtml = '';
        let deleteFunction;
        let reloadPage;
        
        // Asumsi Lapbul menggunakan _source yang berbeda, jika tidak ada _source, anggap Lapbul juga
        if (rowInfo._source === 'SK') {
            infoHtml = `<p>Apakah Anda yakin ingin menghapus data SK ini?</p>
                        <div style="font-weight: bold; margin: 15px 0; background:rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; line-height: 1.5; text-align: left;">
                           Sekolah: ${rowInfo['Nama SD']}<br>
                           Tahun Ajaran: ${rowInfo['Tahun Ajaran']}
                        </div>`;
            deleteFunction = App.processDeletionSK;
            reloadPage = 'sk_kelola';
        } else if (isPaud) { // PTK PAUD
            infoHtml = `<p>Apakah Anda yakin ingin menghapus data PTK ini?</p>
                        <div style="font-weight: bold; margin: 15px 0; background:rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; line-height: 1.5; text-align: left;">
                           Nama: ${rowInfo['Nama']}<br>
                           Lembaga: ${rowInfo['Nama Lembaga']}
                        </div>`;
            deleteFunction = App.processDeletionPtkPaud;
            reloadPage = 'ptk_kelola_paud';
        } else if (isSd) { // PTK SD
            infoHtml = `<p>Yakin ingin menghapus PTK ini?</p>
                        <div style="font-weight: bold; margin: 15px 0; background:rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; line-height: 1.5; text-align: left;">
                           Nama: ${rowInfo['Nama']}<br>
                           Unit Kerja: ${rowInfo['Unit Kerja']}
                        </div>`;
            deleteFunction = App.processDeletionPtkSd;
            reloadPage = 'ptk_kelola_sd';
        } else if (isLapbul) { // Laporan Bulan (PAUD/SD)
            infoHtml = `<p>Apakah Anda yakin ingin menghapus Laporan Bulan ini?</p>
                        <div style="font-weight: bold; margin: 15px 0; background:rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; line-height: 1.5; text-align: left;">
                           Sekolah: ${rowInfo['Nama Sekolah']}<br>
                           Bulan/Tahun: ${rowInfo['Bulan']} ${rowInfo['Tahun']}
                        </div>`;
            deleteFunction = App.processDeletionLapbul;
            reloadPage = 'lapbul_kelola';
        } else {
            // Fallback for any unknown object, prevent deletion
            App.showAppModal('error', 'Gagal: Jenis data untuk dihapus tidak teridentifikasi.');
            return;
        }

        modalTitle.textContent = 'Konfirmasi Hapus';
        modalBody.innerHTML = infoHtml;

        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.textContent = 'Ya, Hapus';
        newConfirmBtn.onclick = () => App.showDeletePrompt(rowInfo, deleteFunction, reloadPage);

        cancelBtn.onclick = () => modal.classList.remove('show');
        modal.classList.add('show');
    };

    App.showDeletePrompt = (rowInfo, deleteFunction, reloadPage) => {
        const modal = document.getElementById('deleteModal');
        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');

        modalTitle.textContent = 'Masukkan Kode Hapus';
        modalBody.innerHTML = `<p>Kode hapus dapat ditanyakan ke admin Korwil.</p>
                                 <input type="password" id="kodeHapusInput" class="custom-modal-input" autocomplete="off" placeholder="Masukkan Kode Hapus">`;
        
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.textContent = 'Konfirmasi & Hapus';
        newConfirmBtn.onclick = () => deleteFunction(rowInfo, reloadPage);

        modal.querySelector('#cancelDeleteBtn').onclick = () => modal.classList.remove('show');

        setTimeout(() => document.getElementById('kodeHapusInput').focus(), 100);
    };

    App.processDeletionSK = (rowInfo, reloadPage) => {
        const deleteCode = document.getElementById('kodeHapusInput').value;
        if (!deleteCode) { App.showAppModal('error', 'Kode hapus tidak boleh kosong.'); return; }
        App.showAppModal('loading', 'Menghapus data dan file terkait...');
        google.script.run
            .withSuccessHandler(response => {
                document.getElementById('deleteModal').classList.remove('show');
                App.showAppModal('success', response, reloadPage);
            })
            .withFailureHandler(error => App.showAppModal('error', error.message))
            .deleteSKData(rowInfo._rowIndex, deleteCode);
    };

    // Fungsi lain untuk delete PTK PAUD, PTK SD, dan LAPBUL (dibiarkan tetap ada)
    App.processDeletionPtkPaud = (rowInfo, reloadPage) => {
        const deleteCode = document.getElementById('kodeHapusInput').value;
        if (!deleteCode) { App.showAppModal('error', 'Kode hapus tidak boleh kosong.'); return; }
        App.showAppModal('loading', 'Menghapus data...');
        google.script.run
            .withSuccessHandler(response => {
                document.getElementById('deleteModal').classList.remove('show');
                App.showAppModal('success', response, reloadPage);
            })
            .withFailureHandler(error => App.showAppModal('error', error.message))
            .deletePtkPaudData(rowInfo._rowIndex, deleteCode);
    };

    App.processDeletionPtkSd = (rowInfo, reloadPage) => {
        const deleteCode = document.getElementById('kodeHapusInput').value;
        if (!deleteCode) { App.showAppModal('error', 'Kode hapus tidak boleh kosong.'); return; }
        App.showAppModal('loading', 'Menghapus data...');
        google.script.run
            .withSuccessHandler(response => {
                document.getElementById('deleteModal').classList.remove('show');
                App.showAppModal('success', response, reloadPage);
            })
            .withFailureHandler(error => App.showAppModal('error', error.message))
            .deletePtkSdData(rowInfo._rowIndex, rowInfo._source, deleteCode);
    };

    App.processDeletionLapbul = (rowInfo, reloadPage) => {
        const deleteCode = document.getElementById('kodeHapusInput').value;
        if (!deleteCode) { App.showAppModal('error', 'Kode hapus tidak boleh kosong.'); return; }
        App.showAppModal('loading', 'Menghapus data dan file terkait...');
        google.script.run
            .withSuccessHandler(response => {
                document.getElementById('deleteModal').classList.remove('show');
                App.showAppModal('success', response, reloadPage);
            })
            .withFailureHandler(error => App.showAppModal('error', error.message))
            .deleteLapbulData(rowInfo._rowIndex, rowInfo._source, deleteCode);
    };
    
    // **AKHIR BLOK KODE PERBAIKAN**
}

function initSkEditPage(params) {
    const rowIndex = params ? params.rowIndex : null;
    if (!rowIndex) {
        document.getElementById('main-content').innerHTML = `<p style="color:red;">Error: ID baris tidak ditemukan.</p>`;
        return;
    }
    const form = document.getElementById('skEditForm');
    const loadingDiv = document.getElementById('loading-data');
    form.querySelector('#rowIndex').value = rowIndex;
    google.script.run.withSuccessHandler(options => {
        google.script.run.withSuccessHandler(rowData => {
            const fieldMapping = {
                'Nama SD': 'namaSD', 'Tahun Ajaran': 'tahunAjaran', 'Semester': 'semester',
                'Kriteria SK': 'kriteriaSK', 'Nomor SK': 'nomorSK', 'Tanggal SK': 'tanggalSK'
            };
            for (const key in options) {
                const elementId = fieldMapping[key];
                if (elementId) {
                    const select = document.getElementById(elementId);
                    if (select && Array.isArray(options[key])) {
                        select.innerHTML = options[key].map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    }
                }
            }
            for (const key in rowData) {
                const elementId = fieldMapping[key];
                if (elementId) {
                    const field = document.getElementById(elementId);
                    if (field) {
                        const savedValue = rowData[key];
                        if (field.tagName === 'SELECT') {
                            field.value = savedValue;
                            let optionExists = Array.from(field.options).some(opt => opt.value === savedValue);
                            if (!optionExists && savedValue) {
                                const newOption = new Option(savedValue, savedValue);
                                field.add(newOption);
                                field.value = savedValue;
                            }
                        }
                        else if (key === 'Tanggal SK' && savedValue) {
                            const parts = savedValue.split('/');
                            if (parts.length === 3) {
                                field.value = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            } else {
                                field.value = savedValue;
                            }
                        } else {
                            field.value = savedValue;
                        }
                    }
                }
            }
            const fileLink = rowData['Dokumen'];
            document.getElementById('existingFileLink').innerHTML = fileLink ? `<a href="${fileLink}" target="_blank">Lihat File Saat Ini</a>` : 'Tidak ada file.';
            
            loadingDiv.style.display = 'none';
            form.style.display = 'block';
        }).withFailureHandler(err => App.showAppModal('error', `Gagal memuat data baris: ${err.message}`)).getSKDataByRow(rowIndex);
    }).withFailureHandler(err => App.showAppModal('error', `Gagal memuat opsi dropdown: ${err.message}`)).getMasterSkOptions();
 
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        const submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan perubahan...');
        const formDataObj = {
            rowIndex: form.rowIndex.value, 'Semester': document.getElementById('semester').value,
            'Kriteria SK': document.getElementById('kriteriaSK').value, 'Nomor SK': document.getElementById('nomorSK').value,
            'Tanggal SK': document.getElementById('tanggalSK').value,
        };
        const fileInput = document.getElementById('fileSK');
        const file = fileInput.files[0];
        const sendData = (data) => {
            google.script.run
                .withSuccessHandler(res => App.showAppModal('success', res, 'sk_kelola'))
                .withFailureHandler(err => {
                    App.showAppModal('error', err.message);
                    submitButton.disabled = false;
                })
                .updateSKData(data);
        };
        if (file) {
            if (file.size > 1024 * 1024) {
                App.showAppModal('error', 'Ukuran file baru tidak boleh lebih dari 1 MB.');
                submitButton.disabled = false; return;
            }
            const reader = new FileReader();
            reader.onload = function (event) {
                formDataObj.fileData = {
                    fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1]
                };
                sendData(formDataObj);
            };
            reader.readAsDataURL(file);
        } else {
            sendData(formDataObj);
        }
    });
}

function initSkArsipPage() {
    let FOLDER_IDS = {}; 
    let breadcrumbTrail = [];
    const viewContainer = document.getElementById('view-container');
    const breadcrumbDiv = document.getElementById('breadcrumb');

    function updateBreadcrumb() {
        const fragment = document.createDocumentFragment();
        breadcrumbTrail.forEach((item, index) => {
            if (index > 0) { 
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                separator.style.margin = '0 5px';
                fragment.appendChild(separator);
            }
            const span = document.createElement('span');
            span.textContent = item.name;
            if (index < breadcrumbTrail.length - 1) {
                span.onclick = () => {
                    breadcrumbTrail.length = index; 
                    if (item.type === 'root') {
                        renderTahunAjaranView();
                    } else {
                        renderFolderView(item.id, item.name);
                    }
                };
            } else {
                span.classList.add('inactive');
            }
            fragment.appendChild(span);
        });
        breadcrumbDiv.innerHTML = '';
        breadcrumbDiv.appendChild(fragment);
    }

    function showLoading() {
        viewContainer.innerHTML = '<div class="loading-container"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div><p>Memuat...</p></div>';
    }

    function renderTahunAjaranView() {
        viewContainer.classList.remove('view-container-scrollable');
        breadcrumbTrail = [{ name: 'Tahun Ajaran', type: 'root', id: FOLDER_IDS.MAIN_SK }]; 
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(folders => {
            if (!folders || folders.length === 0) { 
                viewContainer.innerHTML = '<p>Tidak ada folder tahun ajaran ditemukan.</p>'; 
            } else {
                viewContainer.innerHTML = '<div class="card-grid"></div>';
                const cardGrid = viewContainer.querySelector('.card-grid');
                folders.forEach((folder, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.innerHTML = `<i class="fas fa-calendar-alt"></i><span>${folder.name}</span>`;
                    card.onclick = () => renderFolderView(folder.id, folder.name);
                    cardGrid.appendChild(card);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat folder: ${err.message}</p>`;
        }).getFolders(FOLDER_IDS.MAIN_SK);
    }

    function renderFolderView(folderId, folderName) {
        viewContainer.classList.remove('view-container-scrollable');
        if (breadcrumbTrail[breadcrumbTrail.length - 1].id !== folderId) {
            breadcrumbTrail.push({ name: folderName, id: folderId, type: 'folder' });
        }
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(folders => {
            if (!folders || folders.length === 0) {
                renderFileView(folderId, folderName);
            } else {
                viewContainer.innerHTML = '<div class="card-grid"></div>';
                const cardGrid = viewContainer.querySelector('.card-grid');
                folders.sort((a, b) => a.name.localeCompare(b.name)).forEach((folder, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.innerHTML = `<i class="fas fa-folder-open"></i><span>${folder.name}</span>`;
                    card.onclick = () => renderFolderView(folder.id, folder.name);
                    cardGrid.appendChild(card);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat folder: ${err.message}</p>`;
        }).getFolders(folderId);
    }

    function renderFileView(folderId, folderName) {
        viewContainer.classList.add('view-container-scrollable');
        if (breadcrumbTrail[breadcrumbTrail.length - 1].id !== folderId) {
             breadcrumbTrail.push({ name: folderName, id: folderId, type: 'folder' });
        }
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(files => {
            if (!files || files.length === 0) {
                viewContainer.innerHTML = '<p>Tidak ada file ditemukan di folder ini.</p>';
            } else {
                viewContainer.innerHTML = '<div class="file-list-container"></div>';
                const fileList = viewContainer.querySelector('.file-list-container');
                files.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.style.animationDelay = `${index * 0.03}s`;
                    fileItem.innerHTML = `<i class="fas fa-file-pdf"></i><a href="${file.url}" target="_blank">${file.name}</a>`;
                    fileList.appendChild(fileItem);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat file: ${err.message}</p>`;
        }).getFiles(folderId);
    }
    
    showLoading();
    google.script.run
        .withSuccessHandler(ids => {
            FOLDER_IDS.MAIN_SK = ids.MAIN_SK;
            renderTahunAjaranView();
        })
        .withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat konfigurasi folder: ${err.message}</p>`;
        })
        .getSkArsipFolderIds();
}

function initLapbulUnggahPage() {
    initMenuPage(); 
    google.script.run
        .withSuccessHandler(infoItems => App.setupInfoDropdown('infoDropdownBtn', 'infoDropdownContent', infoItems))
        .withFailureHandler(err => App.setupInfoDropdown('infoDropdownBtn', 'infoDropdownContent', []))
        .getLapbulInfo();
}

App.calculateTotalMuridPaud = (form) => {
    let totalUsia = 0;
    let totalRombel = 0;
    
    // Hitung Total Usia
    form.querySelectorAll('#dataMurid [name^="murid_"]').forEach(input => {
        totalUsia += parseInt(input.value, 10) || 0;
    });

    // Hitung Total Rombel (Kelompok A dan B)
    totalRombel += parseInt(form.querySelector('[name="kelompok_A_L"]').value, 10) || 0;
    totalRombel += parseInt(form.querySelector('[name="kelompok_A_P"]').value, 10) || 0;
    totalRombel += parseInt(form.querySelector('[name="kelompok_B_L"]').value, 10) || 0;
    totalRombel += parseInt(form.querySelector('[name="kelompok_B_P"]').value, 10) || 0;

    // Perbarui tampilan validasi
    document.getElementById('totalUsia').textContent = totalUsia;
    document.getElementById('totalRombel').textContent = totalRombel;
    
    return { totalUsia, totalRombel };
};

function initLapbulFormPaudPage(params) {
    const form = document.getElementById('lapbulFormPaud');
    if (!form) return;

    const formLogic = App.setupTabForm('lapbulFormPaud');

    const bulanSelect = form.querySelector('[name="laporanBulan"]');
    const tahunSelect = form.querySelector('[name="tahun"]');
    const jenjangSelect = document.getElementById('jenjang');
    const namaSekolahSelect = document.getElementById('namaSekolah');
    const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const d = new Date();
    const currentYear = d.getFullYear();
    const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
    bulanSelect.innerHTML = bulanOptions.map((m, i) => `<option value="${m}" ${i === prevMonthIndex ? 'selected' : ''}>${m}</option>`).join('');
    tahunSelect.innerHTML = [currentYear, currentYear - 1].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');

    
    // --- 1. VALIDASI KUSTOM TAB 1 (DATA LEMBAGA) ---
    formLogic.setTabValidation(0, () => {
    let isValid = true;
    const tabContent = document.getElementById('dataSekolah');
    // Hapus semua indikator error sebelumnya
    tabContent.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
    
    // Hanya periksa elemen yang required
    const fields = tabContent.querySelectorAll('[required]');

    fields.forEach(field => {
        let fieldIsValid = true;
        const isRombel = field.name === 'jumlahRombel';

        // Check for emptiness or invalid select default value
        if (!field.value || field.value === "" || field.value === "-- Pilih Jenjang Dahulu --" || field.value === "-- Pilih Lembaga --") {
            
            // Khusus Rombel: Lolos jika nilainya adalah 0 (meskipun secara teknis dianggap "empty" oleh browser)
            if (isRombel && field.value === "0") {
                fieldIsValid = true;
            } else {
                fieldIsValid = false;
            }
        } 
        
        // Terapkan glow merah jika gagal, tetapi jangan tampilkan popup global
        if (!fieldIsValid) {
            isValid = false;
            field.classList.add('input-error');
        } else {
            field.classList.remove('input-error');
        }
    });

    if (!isValid) {
        // PERUBAHAN: Menghilangkan popup untuk Tab 1 (Hanya glow merah)
        return false;
    }

    return true;
});

    // --- 2. VALIDASI KUSTOM TAB 2 (DATA MURID) ---
    formLogic.setTabValidation(1, () => {
        const { totalUsia, totalRombel } = App.calculateTotalMuridPaud(form);
        const statusEl = document.getElementById('murid-validation-status');

        statusEl.classList.remove('status-ok', 'status-error');

        // Skenario 2a: Total Murid 0
        if (totalUsia === 0) {
            const confirmModal = document.getElementById('deleteModal'); // Menggunakan modal yang ada
            confirmModal.querySelector('#deleteModalTitle').textContent = 'Konfirmasi Data Siswa';
            confirmModal.querySelector('#deleteModalBody').innerHTML = '<p>Anda belum mengisikan data jumlah siswa (Total: 0). Tetap lanjut?</p>';
            
            const confirmBtn = confirmModal.querySelector('#confirmDeleteBtn');
            const cancelBtn = confirmModal.querySelector('#cancelDeleteBtn');

            confirmBtn.textContent = 'Lanjut';
            cancelBtn.textContent = 'Kembali';

            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.onclick = () => {
                 confirmModal.classList.remove('show');
                 formLogic.unlockAndShowTab(2); // Lanjut ke Tab PTK
            };
            cancelBtn.onclick = () => confirmModal.classList.remove('show');

            confirmModal.classList.add('show');
            return false; // Kembali ke tab murid dulu
        }

        // Skenario 2b: Jumlah Murid Tidak Sama
        if (totalUsia !== totalRombel) {
            statusEl.textContent = "Jumlah TIDAK SAMA!";
            statusEl.classList.add('status-error');
            App.showAppModal('error', 'Kesalahan Validasi: Total Murid Menurut Usia harus SAMA dengan Total Murid Menurut Rombel.');
            return false;
        }

        // Skenario 2c: Valid dan Sama
        statusEl.textContent = "Jumlah SAMA!";
        statusEl.classList.add('status-ok');
        return true;
    });

    // --- 3. VALIDASI KUSTOM TAB 3 (DATA PTK) ---
    formLogic.setTabValidation(2, () => {
        const dataPtkContainer = document.getElementById('dataPtk');
        
        // KUNCI PERBAIKAN POIN 2: Validasi Kepala Sekolah PAUD
        const kepsekASN = parseInt(dataPtkContainer.querySelector('[name="kepsek_ASN"]').value, 10) || 0;
        const kepsekNonASN = parseInt(dataPtkContainer.querySelector('[name="kepsek_Non_ASN"]').value, 10) || 0;
        const totalKepsek = kepsekASN + kepsekNonASN;
        
        if (totalKepsek > 1) {
            App.showAppModal('error', 'Jumlah Kepala Sekolah maksimal 1.');
            return false;
        }

        // Hitung Total Semua PTK (untuk Konfirmasi Lanjut)
        const ptkInputs = dataPtkContainer.querySelectorAll('input[type="number"]');
        const totalPtk = Array.from(ptkInputs).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);
        
        // Skenario: Total PTK 0 (Konfirmasi Lanjut)
        if (totalPtk === 0) {
            const confirmModal = document.getElementById('deleteModal');
            confirmModal.querySelector('#deleteModalTitle').textContent = 'Konfirmasi Data PTK';
            confirmModal.querySelector('#deleteModalBody').innerHTML = '<p>Anda belum mengisikan data jumlah PTK (Total: 0). Tetap lanjut?</p>';
            
            const confirmBtn = confirmModal.querySelector('#confirmDeleteBtn');
            const cancelBtn = confirmModal.querySelector('#cancelDeleteBtn');

            confirmBtn.textContent = 'Lanjut';
            cancelBtn.textContent = 'Kembali';

            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.onclick = () => {
                 confirmModal.classList.remove('show');
                 formLogic.unlockAndShowTab(3);
            };
            cancelBtn.onclick = () => confirmModal.classList.remove('show');

            confirmModal.classList.add('show');
            return false;
        }
        
        return true;
    });

    form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Asumsikan semua tab sebelumnya sudah divalidasi dan dilewati.
    
    const submitButton = form.querySelector('#finalSubmitBtn'); // Menggunakan ID yang lebih spesifik
    submitButton.disabled = true;
    App.showAppModal('loading', 'Mengirim Laporan Bulanan...');

    const fileInput = document.getElementById('fileLapbul');
    const file = fileInput.files[0];
    const MAX_SIZE = 300 * 1024; // 300 KB

    if (!file) {
         // Harusnya tidak terjadi karena input file memiliki attribute required, tapi sebagai fallback
         App.showAppModal('error', 'Unggah Dokumen: File Laporan Bulan wajib dilampirkan.');
         submitButton.disabled = false;
         return;
    }

    if (file.size > MAX_SIZE) {
        // PERBAIKAN POIN 2: Popup jika file melebihi batas
        App.showAppModal('error', 'Ukuran file melebihi batas maksimal 300 KB. Harap kompresi file PDF Anda.');
        submitButton.disabled = false;
        return;
    }
    
    const formData = new FormData(form);
    const payload = Object.fromEntries(formData.entries());
    
    // Ambil nilai dari field yang terkunci (atau yang namanya berbeda dari input)
    payload.laporanBulan = form.querySelector('[name="laporanBulan"]').value;
    payload.tahun = form.querySelector('[name="tahun"]').value;
    payload.jenjang = form.querySelector('[name="jenjang"]').value;
    payload.namaSekolah = form.querySelector('[name="namaSekolah"]').value;

    const sendData = (data) => {
        google.script.run
            .withSuccessHandler(res => {
                if (res && res.error) {
                     App.showAppModal('error', res.error);
                     submitButton.disabled = false;
                } else {
                     // PERBAIKAN POIN 2: Redirect ke Riwayat Pengiriman
                     App.showAppModal('success', 'Laporan berhasil terkirim!', 'lapbul_riwayat');
                }
            })
            .withFailureHandler(err => {
                App.showAppModal('error', `Gagal mengirim laporan: ${err.message}`);
                submitButton.disabled = false;
            })
            .processLapbulFormPaud(data);
    };

    const reader = new FileReader();
    reader.onload = function(event) {
        payload.fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
        sendData(payload);
    };
    reader.readAsDataURL(file);
});

    App.showAppModal('loading', 'Memuat formulir...');
    
    // Tambahkan event listener untuk update validasi murid secara real-time
    form.querySelector('#dataMurid').addEventListener('input', () => {
        App.calculateTotalMuridPaud(form);
    });

    google.script.run
    .withSuccessHandler(schoolLists => {
        const availableJenjangs = Object.keys(schoolLists).filter(k => schoolLists[k] && schoolLists[k].length > 0);
        
        jenjangSelect.innerHTML = '<option value="" disabled selected>-- Pilih Jenjang --</option>';
        namaSekolahSelect.innerHTML = '<option value="" disabled selected>-- Pilih Jenjang Dahulu --</option>';

        availableJenjangs.forEach(j => {
            jenjangSelect.add(new Option(j, j));
        });

        const handleJenjangChange = () => {
            const selectedJenjang = jenjangSelect.value;
            const schoolList = schoolLists[selectedJenjang] || []; 
            
            namaSekolahSelect.innerHTML = '<option value="" disabled selected>-- Pilih Lembaga --</option>';
            
            schoolList.forEach(school => {
                namaSekolahSelect.add(new Option(school, school));
            });
            namaSekolahSelect.disabled = false;
        };
        
        jenjangSelect.addEventListener('change', handleJenjangChange);
        
        // Inisialisasi awal validasi murid
        form.querySelector('#dataMurid').dispatchEvent(new Event('input'));
        
        document.getElementById('appModal').classList.remove('show');
    })
    .withFailureHandler(err => App.showAppModal('error', `Gagal memuat daftar sekolah: ${err.message}`))
    .getPaudSchoolLists();
}

App.submitLapbulSd = (form) => {
    
    const submitButton = form.querySelector('#finalSubmitBtn'); 
    submitButton.disabled = true;

    const fileInput = form.querySelector('#fileLapbul');
    const file = fileInput.files[0];
    const MAX_SIZE = 300 * 1024; // 300 KB

    // 1. VALIDASI FILE TIDAK BOLEH KOSONG
    if (!file) {
         App.showAppModal('error', 'Unggah Dokumen: File Laporan Bulan wajib dilampirkan.');
         submitButton.disabled = false;
         return;
    }

    // 2. VALIDASI BATAS UKURAN FILE
    if (file.size > MAX_SIZE) {
        App.showAppModal('error', 'Ukuran file melebihi batas maksimal 300 KB. Harap kompresi file PDF Anda.');
        submitButton.disabled = false;
        return; 
    }
    
    // 3. JIKA LOLOS VALIDASI, BARU TAMPILKAN LOADING MODAL
    App.showAppModal('loading', 'Mengirim Laporan Bulanan...');

    const formData = new FormData(form);
    const payload = Object.fromEntries(formData.entries());
    
    // Kumpulkan field penting dari Tab 1
    payload.laporanBulan = form.querySelector('[name="laporanBulan"]').value;
    payload.tahun = form.querySelector('[name="tahun"]').value;
    payload.statusSekolah = form.querySelector('[name="statusSekolah"]').value;
    payload.namaSekolah = form.querySelector('[name="namaSekolah"]').value;

    const sendData = (data) => {
        google.script.run
            .withSuccessHandler(res => {
                if (res && res.error) {
                     App.showAppModal('error', res.error);
                     submitButton.disabled = false;
                } else {
                     App.showAppModal('success', 'Laporan berhasil terkirim!', 'lapbul_riwayat');
                }
            })
            .withFailureHandler(err => {
                App.showAppModal('error', `Gagal mengirim laporan: ${err.message}`);
                submitButton.disabled = false;
            })
            .processLapbulFormSd(data);
    };

    const reader = new FileReader();
    reader.onload = function(event) {
        payload.fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
        sendData(payload);
    };
    reader.readAsDataURL(file);
};

function initLapbulFormSdPage() {
    const form = document.getElementById('lapbulFormSd');
    if (!form) return;

    const formLogic = App.setupTabForm('lapbulFormSd'); 

    // Helper functions for internal use
    function setupInitialDropdowns() {
        const bulanSelect = form.querySelector('[name="laporanBulan"]');
        const tahunSelect = form.querySelector('[name="tahun"]');
        const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const d = new Date();
        const currentYear = d.getFullYear();
        const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
        bulanSelect.innerHTML = bulanOptions.map((m, i) => `<option value="${m}" ${i === prevMonthIndex ? 'selected' : ''}>${m}</option>`).join('');
        tahunSelect.innerHTML = [currentYear, currentYear - 1].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
    }

    function generateKelasHTML(kelas) {
        const rombels = ['A', 'B', 'C'];
        const agama = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
        const agamaDefault = { 'Islam': 'Ada', 'Kristen': 'Tidak Ada', 'Katolik': 'Tidak Ada', 'Hindu': 'Tidak Ada', 'Buddha': 'Tidak Ada', 'Konghucu': 'Tidak Ada' };

        let rombelInputsHTML = `
            <div class="rombel-input-group" id="rombel-${kelas}-Tunggal" style="display: none;">
                <label class="rombel-group-label">Kelas ${kelas}</label>
                <div class="murid-input-pair">
                    <div class="form-group"><label>L</label><input type="number" name="k${kelas}_rombel_tunggal_L" min="0" required></div>
                    <div class="form-group"><label>P</label><input type="number" name="k${kelas}_rombel_tunggal_P" min="0" required></div>
                </div>
            </div>
        `;
        for (const rombel of rombels) {
            rombelInputsHTML += `<div class="rombel-input-group" id="rombel-${kelas}-${rombel}" style="display: none;"><label class="rombel-group-label">Kelas ${kelas}${rombel}</label><div class="murid-input-pair"><div class="form-group"><label>L</label><input type="number" name="k${kelas}_rombel_${rombel.toLowerCase()}_L" min="0" required></div><div class="form-group"><label>P</label><input type="number" name="k${kelas}_rombel_${rombel.toLowerCase()}_P" min="0" required></div></div></div>`;
        }
        
        let agamaInputsHTML = '<div class="agama-container-grid">';
        
        for (const ag of agama) {
            const agId = ag.toLowerCase().replace(/\s/g, '_');
            const defaultValue = agamaDefault[ag] || 'Tidak Ada';
            const isVisible = defaultValue === 'Ada';

            agamaInputsHTML += `
                <div class="agama-input-group">
                    <label class="agama-group-label">${ag}</label>
                    <select class="agama-toggle" data-kelas="${kelas}" data-agama="${agId}">
                        <option value="Ada" ${defaultValue === 'Ada' ? 'selected' : ''}>Ada</option>
                        <option value="Tidak Ada" ${defaultValue === 'Tidak Ada' ? 'selected' : ''}>Tidak Ada</option>
                    </select>
                    <div class="murid-input-pair" id="agama-input-${kelas}-${agId}" style="display: ${isVisible ? 'flex' : 'none'}; margin-top: 10px;">
                        <div class="form-group"><label>L</label><input type="number" name="k${kelas}_agama_${agId}_L" min="0" required></div>
                        <div class="form-group"><label>P</label><input type="number" name="k${kelas}_agama_${agId}_P" min="0" required></div>
                    </div>
                </div>
            `;
        }
        agamaInputsHTML += '</div>';

        const validationHTML = `<div id="murid-validation-feedback-${kelas}" class="murid-validation-container" style="margin-top: 20px;"><p>Total per Rombel: <span id="totalRombel-${kelas}">0</span></p><p>Total per Agama: <span id="totalAgama-${kelas}">0</span></p><p id="murid-validation-status-${kelas}" class="status-ok">Jumlah Sesuai</p></div>`;
        
        let footerHTML = '';
        if (kelas === 1) {
            footerHTML = `<div class="tab-form-footer"><button type="button" class="submit-btn prev-tab-btn" style="width: auto;">Sebelumnya</button></div>`;
        } else if (kelas === 6) {
            footerHTML = `<div class="tab-form-footer"><button type="button" class="submit-btn next-tab-btn" style="width: auto; margin-left: auto;">Berikutnya</button></div>`;
        }
        
        return `
            <fieldset class="ptk-fieldset"><legend>Menurut Rombel</legend><div class="form-group form-group-rombel-toggle" style="margin-bottom: 20px;"><label>Jumlah Rombel</label><select class="rombel-toggle" name="k${kelas}_jumlah_rombel" data-kelas="${kelas}"><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option><option value="0">0</option></select></div><h4 class="sub-section-title">Jml Murid per Rombel</h4><div class="rombel-container" id="rombel-container-${kelas}" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px;">${rombelInputsHTML}</div></fieldset>
            <fieldset class="ptk-fieldset" style="margin-top: 20px;"><legend>Menurut Agama</legend>${agamaInputsHTML}</fieldset>
            ${validationHTML}${footerHTML}
        `;
    }

    function generatePtkNegeriHTML() {
        return `<fieldset class="ptk-fieldset"><legend>Data Jumlah PTK (Negeri)</legend>
        <fieldset class="ptk-sub-fieldset"><legend>Kepala Sekolah</legend><div class="ptk-row ptk-grid-2">
            <div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_ks_pns" min="0" max="1"></div>
            <div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_ks_pppk" min="0" max="1"></div>
        </div></fieldset>
        <fieldset class="ptk-sub-fieldset"><legend>Guru</legend>
            <div class="ptk-row has-label"><label>Guru Kelas</label><div><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_kelas_pns" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_kelas_pppk" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_kelas_pppkpw" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_kelas_gtt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Guru PAI</label><div><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_pai_pns" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_pai_pppk" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_pai_pppkpw" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_pai_gtt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Guru PJOK</label><div><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_pjok_pns" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_pjok_pppk" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_pjok_pppkpw" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_pjok_gtt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Guru PA Kristen</label><div><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_kristen_pns" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_kristen_pppk" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_kristen_pppkpw" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_kristen_gtt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Guru Bhs. Inggris</label><div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_inggris_gtt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Guru Mapel Lainnya</label><div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_lainnya_gtt" min="0"></div></div></div>
        </fieldset>
        <fieldset class="ptk-sub-fieldset"><legend>Tenaga Kependidikan</legend>
            <div class="ptk-row has-label"><label>Pengelola Umum Operasional</label><div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_tendik_pengelola_pppk" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_tendik_pengelola_pppkpw" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_pengelola_ptt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Operator Layanan Operasional</label><div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_tendik_operator_pppk" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_tendik_operator_pppkpw" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_operator_ptt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Pengelola Layanan Operasional</label><div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_plo_pppk" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_plo_pppkpw" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_plo_ptt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Penata Layanan Operasional</label><div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_penata_lo_pppk" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_penata_lo_pppkpw" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_penata_lo_ptt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Administrasi Perkantoran</label><div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_adm_perkantoran_pppk" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_adm_perkantoran_pppkpw" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_adm_perkantoran_ptt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Penjaga</label><div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_penjaga_ptt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Tenaga Adm.</label><div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_tas_ptt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Pustakawan</label><div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_pustakawan_ptt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Tendik Lain</label><div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_lainnya_ptt" min="0"></div></div></div>
        </fieldset>
        </fieldset>`;
    }

    function generatePtkSwastaHTML() {
        return `<fieldset class="ptk-fieldset"><legend>Data Jumlah PTK (Swasta)</legend>
        <fieldset class="ptk-sub-fieldset"><legend>Kepala Sekolah</legend><div class="ptk-row ptk-grid-4">
            <div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_ks_gty" min="0" max="1"></div>
            <div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_ks_gtt" min="0" max="1"></div>
            <div class="form-group"><label>PNS</label><input type="number" name="ptk_swasta_ks_pns" min="0" max="1"></div>
            <div class="form-group"><label>PPPK</label><input type="number" name="ptk_swasta_ks_pppk" min="0" max="1"></div>
        </div></fieldset>
        <fieldset class="ptk-sub-fieldset"><legend>Guru</legend>
            <div class="ptk-row has-label"><label>Guru Kelas</label><div><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_kelas_gty" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_kelas_gtt" min="0"></div><div class="form-group"><label>PNS</label><input type="number" name="ptk_swasta_guru_kelas_pns" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_swasta_guru_kelas_pppk" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Guru PAI</label><div><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_pai_gty" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_pai_gtt" min="0"></div><div class="form-group"><label>PNS</label><input type="number" name="ptk_swasta_guru_pai_pns" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_swasta_guru_pai_pppk" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Guru PJOK</label><div><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_pjok_gty" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_pjok_gtt" min="0"></div><div class="form-group"><label>PNS</label><input type="number" name="ptk_swasta_guru_pjok_pns" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_swasta_guru_pjok_pppk" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Guru PA Kristen</label><div><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_kristen_gty" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_kristen_gtt" min="0"></div><div class="form-group"><label>PNS</label><input type="number" name="ptk_swasta_guru_kristen_pns" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_swasta_guru_kristen_pppk" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Guru Bhs. Inggris</label><div><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_inggris_gty" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_inggris_gtt" min="0"></div><div class="form-group"><label>PNS</label><input type="number" name="ptk_swasta_guru_inggris_pns" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_swasta_guru_inggris_pppk" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Guru Mapel Lain</label><div><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_lainnya_gty" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_lainnya_gtt" min="0"></div><div class="form-group"><label>PNS</label><input type="number" name="ptk_swasta_guru_lainnya_pns" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_swasta_guru_lainnya_pppk" min="0"></div></div></div>
        </fieldset>
        <fieldset class="ptk-sub-fieldset"><legend>Tenaga Kependidikan</legend>
            <div class="ptk-row has-label"><label>Penjaga</label><div><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_penjaga_pty" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_penjaga_ptt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Tenaga Administrasi</label><div><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_tas_pty" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_tas_ptt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Pustakawan</label><div><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_pustakawan_pty" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_pustakawan_ptt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Tendik Lainnya</label><div><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_lain_pty" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_lain_ptt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Operator Layanan Operasional</label><div><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_operator_pty" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_operator_ptt" min="0"></div></div></div>
            <div class="ptk-row has-label"><label>Pengelola Umum Operasional</label><div><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_pengelola_pty" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_pengelola_ptt" min="0"></div></div></div>
        </fieldset>
        </fieldset>`;
    }

    function checkKelasTotals(kelas) {
        const kelasContent = document.getElementById(`kelas-content-${kelas}`);
        if (!kelasContent) return true;

        const rombelInputs = kelasContent.querySelectorAll('.rombel-container input[type="number"]');
        const agamaInputs = kelasContent.querySelectorAll('.agama-container-grid input[type="number"]');
        
        const totalRombel = Array.from(rombelInputs).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);
        const totalAgama = Array.from(agamaInputs).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);

        const statusEl = document.getElementById(`murid-validation-status-${kelas}`);
        document.getElementById(`totalRombel-${kelas}`).textContent = totalRombel;
        document.getElementById(`totalAgama-${kelas}`).textContent = totalAgama;

        if (totalRombel !== totalAgama) {
            statusEl.textContent = "Jumlah TIDAK SAMA!";
            statusEl.className = 'status-error';
            return false;
        } else {
            statusEl.textContent = "Jumlah Sesuai";
            statusEl.className = 'status-ok';
            return true;
        }
    }

    function setupDataMurid() {
        const tabsContainer = document.getElementById('kelas-tabs');
        const contentContainer = document.getElementById('kelas-content-container');
        for (let i = 1; i <= 6; i++) {
            tabsContainer.innerHTML += `<button type="button" class="tab-link ${i === 1 ? 'active' : ''}" data-kelas="${i}">Kelas ${i}</button>`;
            const content = document.createElement('div');
            content.id = `kelas-content-${i}`;
            content.className = 'tab-content';
            content.style.display = i === 1 ? 'block' : 'none';
            content.innerHTML = generateKelasHTML(i);
            content.dataset.kelas = i;
            contentContainer.appendChild(content);

            const defaultRombelSelect = content.querySelector('.rombel-toggle');
            const defaultRombelCount = parseInt(defaultRombelSelect.value, 10);
            if (defaultRombelCount === 1) document.getElementById(`rombel-${i}-Tunggal`).style.display = 'block';
            
            checkKelasTotals(i);
        }

        tabsContainer.addEventListener('click', function(e) { 
            const clickedTab = e.target.closest('.tab-link');
            if (clickedTab) {
                e.stopPropagation();
                document.querySelectorAll('.tab-link').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
                
                clickedTab.classList.add('active');
                document.getElementById(`kelas-content-${clickedTab.dataset.kelas}`).style.display = 'block';
            }
        });
        
        contentContainer.addEventListener('input', function(e) {
            if (e.target.type === 'number') {
                const kelas = e.target.closest('.tab-content').dataset.kelas;
                checkKelasTotals(kelas);
            }
        });

        contentContainer.addEventListener('change', function(e) {
            const target = e.target;
            const kelas = target.dataset.kelas || target.closest('.tab-content').dataset.kelas;

            if (target.classList.contains('rombel-toggle')) {
                const count = parseInt(target.value, 10);
                document.querySelectorAll(`#rombel-container-${kelas} .rombel-input-group`).forEach(el => el.style.display = 'none');
                if (count === 1) { document.getElementById(`rombel-${kelas}-Tunggal`).style.display = 'block'; }
                else if (count > 1) { ['A', 'B', 'C'].slice(0, count).forEach(r => document.getElementById(`rombel-${kelas}-${r}`).style.display = 'block'); }
                checkKelasTotals(kelas);
            }
            if (target.classList.contains('agama-toggle')) {
                document.getElementById(`agama-input-${target.dataset.kelas}-${target.dataset.agama}`).style.display = target.value === 'Ada' ? 'flex' : 'none';
            }
        });
    }

    function setupDataSekolah(schoolLists) {
        const statusSekolah = form.querySelector('#statusSekolah');
        const namaSekolah = document.getElementById('namaSekolah');
        const ptkContainer = document.getElementById('ptk-section-container');
        
        ptkContainer.innerHTML = `<div id="ptk-negeri">${generatePtkNegeriHTML()}</div> <div id="ptk-swasta">${generatePtkSwastaHTML()}</div>`;
        
        const ptkNegeri = document.getElementById('ptk-negeri');
        const ptkSwasta = document.getElementById('ptk-swasta');
        ptkNegeri.style.display = 'none';
        ptkSwasta.style.display = 'none';
        
        statusSekolah.addEventListener('change', function() {
            const status = this.value;
            const schoolList = status === 'Negeri' ? schoolLists.SDN : schoolLists.SDS;
            
            namaSekolah.innerHTML = '<option value="" disabled selected>-- Pilih Sekolah --</option>';
            if(schoolList) schoolList.forEach(school => namaSekolah.add(new Option(school, school)));
            namaSekolah.disabled = false;
            
            if (status === 'Negeri') {
                ptkNegeri.style.display = 'block';
                ptkSwasta.style.display = 'none';
            } else if (status === 'Swasta') {
                ptkNegeri.style.display = 'none';
                ptkSwasta.style.display = 'block';
            }
        });
    }

    App.showAppModal('loading', 'Memuat formulir SD...');
    
    google.script.run
        .withSuccessHandler(schoolLists => {
            const formLogic = App.setupTabForm('lapbulFormSd');
            
            setupInitialDropdowns();
            setupDataSekolah(schoolLists);
            setupDataMurid();
            
            // --- VALIDASI CUSTOM UNTUK TAB 2 (MURID) ---
            formLogic.setTabValidation(1, () => {
                let allValid = true;
                let firstInvalidKelas = -1;
                for (let i = 1; i <= 6; i++) {
                    if (!checkKelasTotals(i)) {
                        allValid = false;
                        if(firstInvalidKelas === -1) firstInvalidKelas = i;
                    }
                }
                if (!allValid) {
                     document.querySelector(`#kelas-tabs button[data-kelas="${firstInvalidKelas}"]`).click(); 
                     App.showAppModal('error', 'Terdapat isian murid yang belum lengkap atau jumlah tidak sesuai.');
                }
                return allValid;
            });
            
            // --- VALIDASI CUSTOM UNTUK TAB 3 (PTK) ---
            formLogic.setTabValidation(2, () => {
                const dataPtkContainer = document.getElementById('dataPtk');
                const isSwasta = form.querySelector('[name="statusSekolah"]').value === 'Swasta';
                
                // 1. Hitung Total Kepala Sekolah (Wajib Maksimal 1)
                let totalKepsek = 0;
                
                if (isSwasta) {
                    totalKepsek += parseInt(dataPtkContainer.querySelector('[name="ptk_swasta_ks_gty"]').value, 10) || 0;
                    totalKepsek += parseInt(dataPtkContainer.querySelector('[name="ptk_swasta_ks_gtt"]').value, 10) || 0;
                    totalKepsek += parseInt(dataPtkContainer.querySelector('[name="ptk_swasta_ks_pns"]').value, 10) || 0;
                    totalKepsek += parseInt(dataPtkContainer.querySelector('[name="ptk_swasta_ks_pppk"]').value, 10) || 0;
                } else {
                    totalKepsek += parseInt(dataPtkContainer.querySelector('[name="ptk_negeri_ks_pns"]').value, 10) || 0;
                    totalKepsek += parseInt(dataPtkContainer.querySelector('[name="ptk_negeri_ks_pppk"]').value, 10) || 0;
                }

                // A. Cek Aturan Kepala Sekolah Maksimal 1
                if (totalKepsek > 1) {
                    App.showAppModal('error', 'Jumlah Kepala Sekolah maksimal adalah 1.');
                    return false;
                }
                
                // B. Hitung Total Semua PTK (Untuk Konfirmasi Lanjut)
                const allPtkInputs = dataPtkContainer.querySelectorAll('input[type="number"]');
                const totalPtk = Array.from(allPtkInputs)
                                   .reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);

                if (totalPtk === 0) {
                    const confirmModal = document.getElementById('deleteModal');
                    confirmModal.querySelector('#deleteModalTitle').textContent = 'Konfirmasi Data PTK';
                    confirmModal.querySelector('#deleteModalBody').innerHTML = '<p>Anda belum mengisikan data jumlah PTK (Total: 0). Tetap lanjut?</p>';
                    
                    const confirmBtn = confirmModal.querySelector('#confirmDeleteBtn');
                    const cancelBtn = confirmModal.querySelector('#cancelDeleteBtn');
                    
                    confirmBtn.textContent = 'Lanjut';
                    cancelBtn.textContent = 'Kembali';

                    const newConfirmBtn = confirmBtn.cloneNode(true);
                    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

                    newConfirmBtn.onclick = () => {
                         confirmModal.classList.remove('show');
                         formLogic.unlockAndShowTab(3);
                    };
                    cancelBtn.onclick = () => confirmModal.classList.remove('show');

                    confirmModal.classList.add('show');

                    return false;
                }
                
                return true; 
            });
            
            document.getElementById('appModal').classList.remove('show');
        })
        .withFailureHandler(err => App.showAppModal('error', `Gagal memuat daftar sekolah: ${err.message}`))
        .getSdSchoolLists();
        
    // ** LOGIKA SUBMIT AKHIR (MENGGUNAKAN FUNGSI HELPER YANG DITAMBAHKAN) **
    
    // TIDAK ADA EVENT LISTENER SUBMIT DI SINI LAGI, KARENA DIKONTROL OLEH onclick="App.submitLapbulSd(this.form)"
}

function initLapbulRiwayatPage() {
    App.initializeGenericTablePage({
        tableId: 'lapbulRiwayatTable',
        serverFunction: 'getLapbulRiwayatData', 
        filters: [
            { id: 'filterTahun', dataColumn: 'Tahun', type: 'dropdown', sortReverse: true, defaultText: 'Semua Tahun' },
            { id: 'filterBulan', dataColumn: 'Bulan', type: 'dropdown', specialSort: 'bulan', defaultText: 'Semua Bulan' },
            { id: 'filterJenjang', dataColumn: 'Jenjang', type: 'dropdown', defaultText: 'Semua Jenjang' },
            { 
              id: 'filterNamaSekolah',      
              dataColumn: 'Nama Sekolah',   
              type: 'cascading-local', 
              parent: 'filterJenjang',      
              parentKey: 'Jenjang',      
              defaultText: 'Semua Sekolah' 
            }
        ]
    });
}

function initLapbulStatusPage() {
    App.initializeGenericTablePage({
        tableId: 'lapbulStatusTable',
        serverFunction: 'getLapbulStatusData', 
        filterFunction: 'getLapbulStatusFilterData', 
        filters: [
            // Filter 1: Tahun
            { id: 'filterTahun', dataColumn: 'Tahun', type: 'dropdown', sortReverse: true, defaultText: 'Semua Tahun' },
            
            // Filter 2: Jenjang (Parent)
            { id: 'filterJenjang', dataColumn: 'Jenjang', type: 'dropdown', defaultText: 'Semua Jenjang' },
            
            // Filter 3: Nama Sekolah (Cascading Child)
            { 
                id: 'filterNamaSekolah', 
                dataColumn: 'Nama Sekolah', 
                type: 'cascading-local', 
                parent: 'filterJenjang', 
                parentKey: 'Jenjang', 
                defaultText: 'Semua Sekolah' 
            }
        ]
    });
}

function initLapbulArsipPage() {
    let FOLDER_IDS = {}; 

    let breadcrumbTrail = [];
    const viewContainer = document.getElementById('view-container');
    const breadcrumbDiv = document.getElementById('breadcrumb');

    function updateBreadcrumb() {
        const fragment = document.createDocumentFragment();
        breadcrumbTrail.forEach((item, index) => {
            if (index > 0) {
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                separator.style.margin = '0 5px';
                fragment.appendChild(separator);
            }
            const span = document.createElement('span');
            span.textContent = item.name;

            if (index < breadcrumbTrail.length - 1) {
                span.onclick = () => {
                    breadcrumbTrail.length = index;
                    if (item.type === 'root') {
                        renderJenjangView();
                    } else {
                        renderFolderView(item.id, item.name);
                    }
                };
            } else {
                span.classList.add('inactive');
            }
            fragment.appendChild(span);
        });
        breadcrumbDiv.innerHTML = '';
        breadcrumbDiv.appendChild(fragment);
    }

    function showLoading() {
        viewContainer.innerHTML = '<div class="loading-container"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div><p>Memuat...</p></div>';
    }

    function renderJenjangView() {
        viewContainer.classList.remove('view-container-scrollable');
        // Saat kembali ke jenjang, reset breadcrumb ke kondisi awal
        breadcrumbTrail = [{ name: 'Jenjang', type: 'root', id: null }];
        updateBreadcrumb();
        viewContainer.innerHTML = '<div class="card-grid"></div>';
        const cardGrid = viewContainer.querySelector('.card-grid');
        
        const jenjang = [
            { name: 'KB', icon: 'fa-cubes', color: '#3498db' },
            { name: 'TK', icon: 'fa-shapes', color: '#9b59b6' },
            { name: 'SD', icon: 'fa-school', color: '#e74c3c' }
        ];

        jenjang.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.animationDelay = `${index * 0.05}s`;
            card.innerHTML = `<i class="fas ${item.icon}" style="color: ${item.color};"></i><span>${item.name}</span>`;
            card.onclick = () => renderFolderView(FOLDER_IDS[item.name], item.name);
            cardGrid.appendChild(card);
        });
    }

    function renderFolderView(folderId, folderName) {
        viewContainer.classList.remove('view-container-scrollable');
        // Hanya tambahkan ke breadcrumb jika belum ada
        if (breadcrumbTrail[breadcrumbTrail.length - 1].id !== folderId) {
            breadcrumbTrail.push({ name: folderName, id: folderId, type: 'folder' });
        }
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(folders => {
            if (!folders || folders.length === 0) {
                renderFileView(folderId, folderName);
            } else {
                viewContainer.innerHTML = '<div class="card-grid"></div>';
                const cardGrid = viewContainer.querySelector('.card-grid');
                folders.forEach((folder, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.innerHTML = `<i class="fas fa-folder-open"></i><span>${folder.name}</span>`;
                    card.onclick = () => renderFolderView(folder.id, folder.name);
                    cardGrid.appendChild(card);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat folder: ${err.message}</p>`;
        }).getFolders(folderId);
    }

    function renderFileView(folderId, folderName) {
        viewContainer.classList.add('view-container-scrollable');
        if (breadcrumbTrail[breadcrumbTrail.length - 1].id !== folderId) {
             breadcrumbTrail.push({ name: folderName, id: folderId, type: 'folder' });
        }
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(files => {
            if (!files || files.length === 0) {
                viewContainer.innerHTML = '<p>Tidak ada file ditemukan di folder ini.</p>';
            } else {
                viewContainer.innerHTML = '<div class="file-list-container"></div>';
                const fileList = viewContainer.querySelector('.file-list-container');
                files.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.style.animationDelay = `${index * 0.03}s`;
                    fileItem.innerHTML = `<i class="fas fa-file-pdf"></i><a href="${file.url}" target="_blank">${file.name}</a>`;
                    fileList.appendChild(fileItem);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat file: ${err.message}</p>`;
        }).getFiles(folderId);
    }
    
    showLoading();
    google.script.run
        .withSuccessHandler(ids => {
            FOLDER_IDS = ids;
            renderJenjangView();
        })
        .withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat konfigurasi folder: ${err.message}</p>`;
        })
        .getLapbulArsipFolderIds();
}

function initLapbulKelolaPage() {
    App.initializeGenericTablePage({
        tableId: 'lapbulKelolaTable',
        serverFunction: 'getLapbulKelolaData',
        filters: [ 
            { id: 'filterTahun', dataColumn: 'Tahun', type: 'dropdown', sortReverse: true, defaultText: 'Semua Tahun' },
            { id: 'filterJenjang', dataColumn: 'Jenjang', type: 'dropdown', defaultText: 'Semua Jenjang' },
            { 
                id: 'filterNamaSekolah', 
                dataColumn: 'Nama Sekolah', 
                type: 'cascading-local', 
                parent: 'filterJenjang',
                parentKey: 'Jenjang',
                defaultText: 'Semua Sekolah'
            }
        ],
        // --- KODE BARU YANG DIMINTA: INITIAL SORT ---
        initialSort: [
            { column: 'Update', order: 'DESC', parser: parseCustomDateTime },
            { column: 'Tanggal Unggah', order: 'DESC', parser: parseCustomDateTime }
        ]
        // ------------------------------------------
    });
}

function initLapbulEditPaudPage(params) {
    const form = document.getElementById('lapbulEditFormPaud');
    const loadingDiv = document.getElementById('loading-data');
    const formContainer = document.getElementById('edit-form-container');
    
    if (!form || !params || !params.rowIndex || !params.source) {
        document.getElementById('main-content').innerHTML = `<p style="color:red; text-align:center;">Error: Parameter edit tidak lengkap.</p>`;
        return;
    }

    // Set nilai rowIndex dan source
    form.querySelector('#rowIndex').value = params.rowIndex;
    form.querySelector('input[name="source"]').value = params.source;
    
    // Inisialisasi logika Tab Form
    const formLogic = App.setupTabForm('lapbulEditFormPaud'); 
    
    // Panggil server untuk mengambil data baris
    google.script.run
        .withSuccessHandler(rowData => {
            loadingDiv.style.display = 'none';
            formContainer.style.display = 'block';

            if (rowData.error) {
                App.showAppModal('error', `Gagal memuat data baris: ${rowData.error}`);
                return;
            }
            
            // KUNCI PERBAIKAN: Mengisi semua field form dengan data yang diterima
            for (const key in rowData) {
                const field = form.querySelector(`[name="${key}"]`);
                if (field) {
                    if (field.type === 'file') continue;
                    
                    // Khusus untuk input number yang kosong, set ke 0
                    if (field.type === 'number') {
                         field.value = rowData[key] ? Number(rowData[key]) : 0;
                    } 
                    // Mengisi select dan input readonly
                    else if (field.tagName === 'SELECT' || field.readOnly) {
                        field.value = rowData[key];
                    } 
                    // Input teks biasa
                    else {
                        field.value = rowData[key];
                    }
                }
            }
            
            // Perbaikan Tab Unlocking
            const allTabs = form.querySelectorAll('.tab-link');
            allTabs.forEach((btn, index) => {
                btn.disabled = false;
            });
            formLogic.unlockAndShowTab(0); // Kembali ke Tab 1 (Data Lembaga)

            // Menampilkan link file lama
            const fileLinkContainer = document.getElementById('existingFileLink');
            if (rowData.Dokumen) { 
                fileLinkContainer.innerHTML = `<a href="${rowData.Dokumen}" target="_blank">Lihat File Saat Ini</a>`; 
            } else { 
                fileLinkContainer.innerHTML = 'Tidak ada file.'; 
            }

        })
        .withFailureHandler(err => {
            loadingDiv.innerHTML = `<p style="color:red;">Gagal menghubungi server: ${err.message}</p>`;
        })
        .getLapbulDataByRow(params.rowIndex, params.source);

    // SUBMIT HANDLER (tetap sama)
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan perubahan laporan...');

        const formData = new FormData(form);
        const payload = {};
        
        // Memastikan input number kosong menjadi 0 saat submit
        for (const [key, value] of formData.entries()) {
            const field = form.querySelector(`[name="${key}"]`);
            if (field?.type === 'number' && !value) {
                payload[key] = "0"; 
            } else {
                payload[key] = value;
            }
        }
        
        const sendData = (data) => {
            google.script.run
                .withSuccessHandler(res => {
                    App.showAppModal('success', res, 'lapbul_kelola');
                })
                .withFailureHandler(err => {
                    App.showAppModal('error', err.message);
                    submitButton.disabled = false;
                })
                .updateLapbulData(data);
        };

        const file = form.querySelector('input[type="file"]').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                payload.fileData = { 
                    fileName: file.name, 
                    mimeType: file.type, 
                    data: event.target.result.split(',')[1] 
                };
                sendData(payload);
            };
            reader.readAsDataURL(file);
        } else {
            sendData(payload);
        }
    });
}

function initLapbulEditSdPage(params) {
    if (!params || !params.rowIndex) {
        document.getElementById('main-content').innerHTML = `<div class="error-box"><h3>Error</h3><p>Parameter untuk edit data tidak ditemukan.</p></div>`;
        return;
    }

    const form = document.getElementById('lapbulEditFormSd');
    const loadingDiv = document.getElementById('loading-data');
    const formContainer = document.getElementById('edit-form-container');

    // --- SEMUA FUNGSI BANTU SEKARANG ADA DI DALAM SATU FUNGSI INI ---
    function generateKelasHTML(kelas) {
        const rombels = ['A', 'B', 'C'];
        const agama = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
        let rombelInputsHTML = `<div class="rombel-input-group" id="rombel-${kelas}-Tunggal" style="display: none;"><label class="rombel-group-label">Kelas ${kelas}</label><div class="murid-input-pair"><div class="form-group"><label>Laki-laki</label><input type="number" name="K${kelas} L" value="0" min="0" required></div><div class="form-group"><label>Perempuan</label><input type="number" name="K${kelas} P" value="0" min="0" required></div></div></div>`;
        for (const rombel of rombels) {
            rombelInputsHTML += `<div class="rombel-input-group" id="rombel-${kelas}-${rombel}" style="display: none;"><label class="rombel-group-label">Kelas ${kelas}${rombel}</label><div class="murid-input-pair"><div class="form-group"><label>Laki-laki</label><input type="number" name="K${kelas}${rombel} L" value="0" min="0" required></div><div class="form-group"><label>Perempuan</label><input type="number" name="K${kelas}${rombel} P" value="0" min="0" required></div></div></div>`;
        }
        let agamaInputsHTML = '';
        for (const ag of agama) {
            const agId = ag;
            agamaInputsHTML += `<div class="form-grid agama-row"><div class="form-group"><label>${ag}</label><select class="agama-toggle" data-kelas="${kelas}" data-agama="${agId}"><option value="Ada">Ada</option><option value="Tidak Ada" selected>Tidak Ada</option></select></div><div class="agama-input-pair" id="agama-input-${kelas}-${agId}" style="display: none;"><div class="form-group"><label>Laki-laki</label><input type="number" name="K${kelas} ${agId} L" value="0" min="0" required></div><div class="form-group"><label>Perempuan</label><input type="number" name="K${kelas} ${agId} P" value="0" min="0" required></div></div></div>`;
        }
        return `<div class="form-grid"><div class="form-group"><label>Jumlah Rombel Kelas ${kelas}</label><select class="rombel-toggle" name="Rombel ${kelas}" data-kelas="${kelas}"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div></div><h4 class="sub-section-title">Jumlah Murid per Rombel</h4><div class="rombel-container" id="rombel-container-${kelas}">${rombelInputsHTML}</div><h4 class="sub-section-title">Jumlah Murid per Agama</h4><div class="agama-container">${agamaInputsHTML}</div>`;
    }
    function generatePtkNegeriHTML() {
    return `<fieldset class="ptk-fieldset"><legend>Data Jumlah PTK (Negeri)</legend>
      <fieldset class="ptk-sub-fieldset"><legend>Kepala Sekolah</legend><div class="ptk-row ptk-grid-2"><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_ks_pns" value="0" min="0" max="1"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_ks_pppk" value="0" min="0" max="1"></div></div></fieldset>
      <fieldset class="ptk-sub-fieldset"><legend>Guru</legend>
        <div class="ptk-row has-label"><label>Guru Kelas</label><div><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_kelas_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_kelas_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_kelas_pppkpw" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_kelas_gtt" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Guru PAI</label><div><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_pai_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_pai_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_pai_pppkpw" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_pai_gtt" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Guru PJOK</label><div><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_pjok_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_pjok_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_pjok_pppkpw" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_pjok_gtt" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Guru PA Kristen</label><div><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_kristen_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_kristen_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_kristen_pppkpw" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_kristen_gtt" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Guru Bhs. Inggris</label><div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_inggris_gtt" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Guru Mapel Lainnya</label><div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_lainnya_gtt" value="0" min="0"></div></div></div>
      </fieldset>
      <fieldset class="ptk-sub-fieldset"><legend>Tenaga Kependidikan</legend>
        <div class="ptk-row has-label"><label>Pengelola Umum Operasional</label><div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_tendik_pengelola_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_tendik_pengelola_pppkpw" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_pengelola_ptt" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Operator Layanan Operasional</label><div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_tendik_operator_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_tendik_operator_pppkpw" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_operator_ptt" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Pengelola Layanan Operasional</label><div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_plo_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_plo_pppkpw" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_plo_ptt" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Penata Layanan Operasional</label><div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_penata_lo_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_penata_lo_pppkpw" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_penata_lo_ptt" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Administrasi Perkantoran</label><div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_adm_perkantoran_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_adm_perkantoran_pppkpw" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_adm_perkantoran_ptt" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Penjaga</label><div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_penjaga_ptt" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Tenaga Adm.</label><div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_tas_ptt" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Pustakawan</label><div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_pustakawan_ptt" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Tendik Lain</label><div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_lainnya_ptt" value="0" min="0"></div></div></div>
      </fieldset>
    </fieldset>`;
}
    function generatePtkSwastaHTML() {
    return `<fieldset class="ptk-fieldset"><legend>Data Jumlah PTK (Swasta)</legend>
      <fieldset class="ptk-sub-fieldset"><legend>Kepala Sekolah</legend><div class="ptk-row ptk-grid-4">
        <div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_ks_gty" value="0" min="0" max="1"></div>
        <div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_ks_gtt" value="0" min="0" max="1"></div>
        <div class="form-group"><label>PNS</label><input type="number" name="ptk_swasta_ks_pns" value="0" min="0"></div>
        <div class="form-group"><label>PPPK</label><input type="number" name="ptk_swasta_ks_pppk" value="0" min="0"></div>
      </div></fieldset>
      <fieldset class="ptk-sub-fieldset"><legend>Guru</legend>
        <div class="ptk-row has-label"><label>Guru Kelas</label><div><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_kelas_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_kelas_gtt" value="0" min="0"></div><div class="form-group"><label>PNS</label><input type="number" name="ptk_swasta_guru_kelas_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_swasta_guru_kelas_pppk" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Guru PAI</label><div><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_pai_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_pai_gtt" value="0" min="0"></div><div class="form-group"><label>PNS</label><input type="number" name="ptk_swasta_guru_pai_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_swasta_guru_pai_pppk" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Guru PJOK</label><div><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_pjok_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_pjok_gtt" value="0" min="0"></div><div class="form-group"><label>PNS</label><input type="number" name="ptk_swasta_guru_pjok_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_swasta_guru_pjok_pppk" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Guru PA Kristen</label><div><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_kristen_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_kristen_gtt" value="0" min="0"></div><div class="form-group"><label>PNS</label><input type="number" name="ptk_swasta_guru_kristen_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_swasta_guru_kristen_pppk" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Guru Bhs. Inggris</label><div><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_inggris_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_inggris_gtt" value="0" min="0"></div><div class="form-group"><label>PNS</label><input type="number" name="ptk_swasta_guru_inggris_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_swasta_guru_inggris_pppk" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Guru Mapel Lain</label><div><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_lainnya_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_lainnya_gtt" value="0" min="0"></div><div class="form-group"><label>PNS</label><input type="number" name="ptk_swasta_guru_lainnya_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_swasta_guru_lainnya_pppk" value="0" min="0"></div></div></div>
      </fieldset>
      <fieldset class="ptk-sub-fieldset"><legend>Tenaga Kependidikan</legend>
        <div class="ptk-row has-label"><label>Penjaga</label><div><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_penjaga_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_penjaga_ptt" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Tenaga Administrasi</label><div><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_tas_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_tas_ptt" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Pustakawan</label><div><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_pustakawan_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_pustakawan_ptt" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Operator Layanan Operasional</label><div><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_operator_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_operator_ptt" value="0" min="0"></div></div></div>
        <div class="ptk-row has-label"><label>Pengelola Umum Operasional</label><div><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_pengelola_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_pengelola_ptt" value="0" min="0"></div></div></div>
      </fieldset>
    </fieldset>`;
}
    function setupFormUI() {
        const tabsContainer = document.getElementById('kelas-tabs');
        const contentContainer = document.getElementById('kelas-content-container');
        tabsContainer.innerHTML = ''; contentContainer.innerHTML = '';
        for (let i = 1; i <= 6; i++) {
            tabsContainer.innerHTML += `<button type="button" class="tab-link ${i === 1 ? 'active' : ''}" data-kelas="${i}">Kelas ${i}</button>`;
            const content = document.createElement('div');
            content.id = `kelas-content-${i}`; content.className = 'tab-content';
            content.style.display = i === 1 ? 'block' : 'none';
            content.innerHTML = generateKelasHTML(i);
            contentContainer.appendChild(content);
        }
        tabsContainer.addEventListener('click', function(e) { if (e.target.classList.contains('tab-link')) { document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none'); e.target.classList.add('active'); document.getElementById(`kelas-content-${e.target.dataset.kelas}`).style.display = 'block'; } });
        contentContainer.addEventListener('change', function(e) { 
            const t = e.target; 
            if (t.classList.contains('rombel-toggle')) { 
                const k = t.dataset.kelas, c = parseInt(t.value, 10); 
                document.querySelectorAll(`#rombel-container-${k} .rombel-input-group`).forEach(el => el.style.display = 'none'); 
                if (c === 1) { 
                    document.getElementById(`rombel-${k}-Tunggal`).style.display = 'block'; 
                } else if (c > 1) { 
                    ['A', 'B', 'C'].slice(0, c).forEach(r => {
                        const rombelEl = document.getElementById(`rombel-${k}-${r}`);
                        if (rombelEl) rombelEl.style.display = 'block';
                    });
                } 
            } 
            if (t.classList.contains('agama-toggle')) { 
                document.getElementById(`agama-input-${t.dataset.kelas}-${t.dataset.agama}`).style.display = t.value === 'Ada' ? 'grid' : 'none'; 
            } 
        });
        document.getElementById('ptk-section-container').innerHTML = `<div id="ptk-negeri" style="display:none;">${generatePtkNegeriHTML()}</div><div id="ptk-swasta" style="display:none;">${generatePtkSwastaHTML()}</div>`;
    }
    function lockField(fieldName) {
        const field = form.querySelector(`[name="${fieldName}"]`);
        if (field) { field.disabled = true; field.style.cssText = 'background-color: rgba(0,0,0,0.3); cursor: not-allowed;'; if (field.tagName === 'INPUT') field.readOnly = true; }
    }

    // --- PROSES UTAMA ---
    setupFormUI();

    google.script.run
        .withSuccessHandler(rowData => {
            if (!rowData || Object.keys(rowData).length === 0) {
                loadingDiv.innerHTML = `<p style="color:red;">Gagal: Data untuk baris ${params.rowIndex} tidak ditemukan.</p>`;
                return;
            }

            form.querySelector('[name="rowIndex"]').value = params.rowIndex;
            
            for (const header in rowData) {
                const fieldName = header.trim();
                const field = form.querySelector(`[name="${fieldName}"]`);
                if (field) {
                    let value = rowData[header];
                    if (field.type === 'number' && (value === '' || value === null || value === undefined)) {
                        value = '0';
                    }
                    field.value = value;
                }
            }
            
            const agama = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
            for (let i = 1; i <= 6; i++) {
                agama.forEach(ag => {
                    const L = parseInt(rowData[`K${i} ${ag} L`] || 0, 10);
                    const P = parseInt(rowData[`K${i} ${ag} P`] || 0, 10);
                    const selectAgama = form.querySelector(`.agama-toggle[data-kelas="${i}"][data-agama="${ag}"]`);
                    if (selectAgama) {
                        selectAgama.value = (L + P > 0) ? 'Ada' : 'Tidak Ada';
                    }
                });
            }

            form.querySelectorAll('select').forEach(select => {
                select.dispatchEvent(new Event('change', { bubbles: true }));
            });

            const bulanSelect = form.querySelector('[name="Bulan"]');
            const tahunSelect = form.querySelector('[name="Tahun"]');
            const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            bulanSelect.innerHTML = bulanOptions.map(m => `<option value="${m}">${m}</option>`).join('');
            const currentYear = new Date().getFullYear();
            tahunSelect.innerHTML = [currentYear + 1, currentYear, currentYear - 1, currentYear - 2].map(y => `<option value="${y}">${y}</option>`).join('');
            bulanSelect.value = rowData['Bulan'];
            tahunSelect.value = rowData['Tahun'];

            if (rowData['Status'] === 'Negeri') {
                document.getElementById('ptk-negeri').style.display = 'block';
            } else if (rowData['Status'] === 'Swasta') {
                document.getElementById('ptk-swasta').style.display = 'block';
            }

            lockField('Bulan'); lockField('Tahun'); lockField('Status'); lockField('Nama Sekolah');
            
            const fileLinkContainer = document.getElementById('existingFileLink');
            if (rowData['Dokumen']) { fileLinkContainer.innerHTML = `<a href="${rowData['Dokumen']}" target="_blank">Lihat File Saat Ini</a>`; } else { fileLinkContainer.innerHTML = 'Tidak ada file.'; }

            loadingDiv.style.display = 'none';
            formContainer.style.display = 'block';
        })
        .withFailureHandler(err => { loadingDiv.innerHTML = `<p style="color:red;">Gagal memuat data baris: ${err.message}</p>`; })
        .getLapbulDataByRow(params.rowIndex, params.source);

    form.addEventListener('submit', function (e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan perubahan...');
        
        const payload = {};
        const allFields = form.querySelectorAll('input, select, textarea');
        allFields.forEach(field => {
            if (field.name) {
                payload[field.name] = field.value;
            }
        });
        
        payload.laporanBulan = form.querySelector('[name="Bulan"]').value;
        payload.tahun = form.querySelector('[name="Tahun"]').value;
        payload.namaSekolah = form.querySelector('[name="Nama Sekolah"]').value;

        const file = form.querySelector('input[type="file"]').files[0];

        const sendData = (data) => {
            google.script.run
                .withSuccessHandler(res => {
                    if (res && res.error) {
                         App.showAppModal('error', res.error);
                         if (submitButton) submitButton.disabled = false;
                    } else {
                         App.showAppModal('success', res, 'lapbul_kelola');
                    }
                })
                .withFailureHandler(err => {
                    App.showAppModal('error', err.message);
                    if (submitButton) submitButton.disabled = false;
                })
                .updateLapbulData(data);
        };

        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                payload.fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
                sendData(payload);
            };
            reader.readAsDataURL(file);
        } else {
            sendData(payload);
        }
      });
  }

function initLapbulUnduhFormatPage() {
    initMenuPage();
    const infoBtn = document.getElementById('infoDropdownBtn');
    const contentDiv = document.getElementById('infoDropdownContent');

    if (!infoBtn || !contentDiv) return;
    let isDataLoaded = false;
    infoBtn.onclick = function() {
        const isOpen = this.classList.toggle('active');
        contentDiv.style.maxHeight = isOpen ? contentDiv.scrollHeight + "px" : "0px";
        if (isOpen && !isDataLoaded) {
            google.script.run
                .withSuccessHandler(infoItems => {
                    if (infoItems && infoItems.length > 0) {
                        const infoContent = `
                            <ul style="text-align: left; padding: 10px 20px 10px 35px; line-height: 1.6; margin: 0;">
                                ${infoItems.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        `;
                        contentDiv.innerHTML = infoContent;
                    } else {
                        contentDiv.innerHTML = '<p style="padding: 15px;">Informasi tidak ditemukan.</p>';
                    }
                    contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                    isDataLoaded = true;
                })
                .withFailureHandler(err => {
                    contentDiv.innerHTML = `<p style="color:red; padding: 15px;">Gagal memuat: ${err.message}</p>`;
                    contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                })
                .getUnduhFormatInfo();
        }
    };
}

// --- Modul Data PTK ---

function initPtkKeadaanPaudPage() {
    App.initializeGenericTablePage({
        tableId: 'keadaanPtkPaudTable',
        serverFunction: 'getPtkKeadaanPaudData',
        filterConfig: [ { id: 'filterJenjang', dataColumn: '_filterJenjang' } ],
        footerConfig: {
            enabled: true,
            labelColumn: 'Nama Lembaga',
            sumStartColumn: 'Jumlah Rombel'
        }
    });
}

function initPtkKeadaanSdPage() {
    App.initializeGenericTablePage({
        tableId: 'keadaanPtkSdTable',
        serverFunction: 'getPtkKeadaanSdData',
        filterConfig: [ { id: 'filterStatusSekolah', dataColumn: 'Status' } ],
        footerConfig: {
            enabled: true,
            labelColumn: 'Nama Sekolah',
            sumStartColumn: 'Rombel'
        }
    });
}

function initPtkJumlahBulananPaudPage() {
    initializeGenericTablePage({
        tableId: 'ptkJumlahBulananPaudTable',
        serverFunction: 'getPtkJumlahBulananPaudData',
        filters: [
            { id: 'filterTahun', dataColumn: '_filterTahun', type: 'dropdown', sortReverse: true },
            { id: 'filterBulan', dataColumn: '_filterBulan', type: 'dropdown', specialSort: 'bulan' },
            { id: 'filterJenjang', dataColumn: '_filterJenjang', type: 'dropdown' },
            { 
              id: 'filterNamaLembaga', 
              dataColumn: 'Nama Lembaga', 
              type: 'cascading-local', 
              parent: 'filterJenjang',
              parentKey: '_filterJenjang'
            }
        ],
        footerConfig: {
            enabled: true,
            labelColumn: 'Nama Lembaga',
            sumStartColumn: 'Jumlah Rombel'
        }
    });
}

function initPtkDaftarPaudPage() {
    App.initializeGenericTablePage({
        tableId: 'daftarPtkPaudTable',
        serverFunction: 'getDaftarPtkPaudData',
        filterConfig: [
            { id: 'filterJenjang', dataColumn: '_filterJenjang' },
            { 
              id: 'filterNamaLembaga', 
              dataColumn: '_filterNamaLembaga', 
              dependsOn: 'filterJenjang',
              dependencyColumn: '_filterJenjang'
            },
            { id: 'filterStatus', dataColumn: '_filterStatus' }
        ]
    });
}

function initPtkKelolaPaudPage() {
    App.initializeGenericTablePage({
        tableId: 'kelolaPtkPaudTable',
        serverFunction: 'getKelolaPtkPaudData',
        editPage: 'ptk_edit_paud',
        filterConfig: [
            { id: 'filterJenjang', dataColumn: 'Jenjang' },
            { 
              id: 'filterNamaLembaga', 
              dataColumn: 'Nama Lembaga', 
              dependsOn: 'filterJenjang',
              dependencyColumn: 'Jenjang'
            }
        ]
    });

    document.getElementById('tambahPtkBtn').addEventListener('click', (e) => {
        App.loadPage(e, 'ptk_tambah_paud');
    });
}

function initPtkTambahPaudPage() {
    const form = document.getElementById('addPtkPaudForm');
    if (!form) return;

    App.showAppModal('loading', 'Memuat formulir...');

    google.script.run
        .withSuccessHandler(options => {
            if (options.error) {
                App.showAppModal('error', `Gagal memuat opsi: ${options.error}`);
                return;
            }

            const jenjangSelect = form.querySelector('#jenjang');
            const lembagaSelect = form.querySelector('#namaLembaga');
            const statusSelect = form.querySelector('#status');
            const jabatanSelect = form.querySelector('#jabatan');

            function populateSingleDropdown(elementId, optionsArray, defaultText) {
                const dropdown = document.getElementById(elementId);
                if (!dropdown) return;
                dropdown.innerHTML = `<option value="" disabled selected>${defaultText}</option>`;
                if (optionsArray && optionsArray.length > 0) {
                    optionsArray.forEach(item => {
                        let option = document.createElement("option");
                        option.value = item;
                        option.textContent = item;
                        dropdown.appendChild(option);
                    });
                }
            }

            populateSingleDropdown("jenjang", options['Jenjang'], "-- Pilih Jenjang --");
            populateSingleDropdown("status", options['Status'], "-- Pilih Status --");
            populateSingleDropdown("jabatan", options['Jabatan'], "-- Pilih Jabatan --");
            
            jenjangSelect.addEventListener('change', function() {
                const selectedJenjang = this.value;
                const lembagaOptions = options['Nama Lembaga'][selectedJenjang] || [];
                lembagaSelect.innerHTML = '<option value="" disabled selected>-- Pilih Lembaga --</option>';
                lembagaOptions.forEach(l => lembagaSelect.add(new Option(l, l)));
                lembagaSelect.disabled = false;
            });
            
            document.getElementById('appModal').classList.remove('show');
        })
        .withFailureHandler(err => App.showAppModal('error', `Gagal memuat opsi form: ${err.message}`))
        .getNewPtkPaudOptions();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan data PTK baru...');

        const formData = Object.fromEntries(new FormData(form));
        
        google.script.run
            .withSuccessHandler(response => {
                App.showAppModal('success', response, 'ptk_kelola_paud');
            })
            .withFailureHandler(error => {
                App.showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .addNewPtkPaud(formData);
    });
}

function initPtkEditPaudPage(params) {
    const form = document.getElementById('editPtkPaudForm');
    const loadingDiv = document.getElementById('loading-data');
    if (!form || !params || !params.rowIndex) {
        document.getElementById('main-content').innerHTML = `<p style="color:red; text-align:center;">Error: Parameter untuk edit tidak ditemukan.</p>`;
        return;
    }

    form.querySelector('[name="rowIndex"]').value = params.rowIndex;

    App.showAppModal('loading', 'Memuat data PTK...');

    google.script.run.withSuccessHandler(options => {
        google.script.run.withSuccessHandler(rowData => {
            App.showAppModal('loading', 'Mengisi formulir...');

            if (options.error || rowData.error) {
                App.showAppModal('error', options.error || rowData.error);
                return;
            }

            // --- Isi semua dropdown dengan opsi dari server ---
            const jenjangSelect = form.querySelector('#jenjang');
            const lembagaSelect = form.querySelector('#namaLembaga');
            const statusSelect = form.querySelector('#status');
            const jabatanSelect = form.querySelector('#jabatan');

            function populateSelect(selectEl, optionsArr, placeholder) {
                selectEl.innerHTML = `<option value="" disabled>${placeholder}</option>`;
                if (optionsArr) optionsArr.forEach(opt => selectEl.add(new Option(opt, opt)));
            }

            populateSelect(jenjangSelect, options['Jenjang'], '-- Pilih Jenjang --');
            populateSelect(statusSelect, options['Status'], '-- Pilih Status --');
            populateSelect(jabatanSelect, options['Jabatan'], '-- Pilih Jabatan --');
            
            // --- Isi form dengan data yang ada ---
            for (const key in rowData) {
                const field = form.querySelector(`[name="${key}"]`);
                if (field) {
                    if (key === 'NUPTK' && rowData[key] === '-') {
                        field.value = ''; 
                    } else {
                        field.value = rowData[key];
                    }
                }
            }
            
            // --- Atur dropdown Nama Lembaga ---
            const selectedJenjang = jenjangSelect.value;
            const lembagaOptions = options['Nama Lembaga'][selectedJenjang] || [];
            lembagaSelect.innerHTML = '<option value="">-- Pilih Lembaga --</option>';
            lembagaOptions.forEach(l => lembagaSelect.add(new Option(l, l)));
            lembagaSelect.value = rowData['Nama Lembaga'];

            // Tambahkan event listener untuk mengubah lembaga jika jenjang diubah
            jenjangSelect.addEventListener('change', function() {
                const newJenjang = this.value;
                const newLembagaOptions = options['Nama Lembaga'][newJenjang] || [];
                lembagaSelect.innerHTML = '<option value="">-- Pilih Lembaga --</option>';
                newLembagaOptions.forEach(l => lembagaSelect.add(new Option(l, l)));
                lembagaSelect.disabled = false;
            });

            // Sembunyikan modal loading dan tampilkan form
            document.getElementById('appModal').classList.remove('show');
            loadingDiv.style.display = 'none';
            form.style.display = 'block';

        }).withFailureHandler(err => App.showAppModal('error', `Gagal mengambil data baris: ${err.message}`)).getPtkPaudDataByRow(params.rowIndex);
    }).withFailureHandler(err => App.showAppModal('error', `Gagal memuat opsi form: ${err.message}`)).getNewPtkPaudOptions();

    // Logika saat form disubmit
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan perubahan...');

        const formData = Object.fromEntries(new FormData(form));
        
        google.script.run
            .withSuccessHandler(response => {
                App.showAppModal('success', response, 'ptk_kelola_paud');
            })
            .withFailureHandler(error => {
                App.showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .updatePtkPaudData(formData);
    });
}

function initPtkJumlahBulananSdPage() {
    App.initializeGenericTablePage({
        tableId: 'jumlahPtkSdBulananTable',
        serverFunction: 'getPtkJumlahBulananSdData',
        filterConfig: [
            { id: 'filterTahun', dataColumn: 'Tahun', sortReverse: true },
            { id: 'filterBulan', dataColumn: 'Bulan', specialSort: 'bulan' },
            { id: 'filterStatusSekolah', dataColumn: 'Status' }
        ],
        isDoubleHeader: true
    });
}

function initPtkDaftarSdnPage() {
    App.initializeGenericTablePage({
        tableId: 'daftarPtkSdnTable',
        serverFunction: 'getDaftarPtkSdnData',
        filterConfig: [
            { id: 'filterUnitKerja', dataColumn: 'Unit Kerja' },
            { id: 'filterStatus', dataColumn: 'Status' },
            { id: 'filterPangkat', dataColumn: 'Pangkat' },
            { id: 'filterJabatan', dataColumn: 'Jabatan' }
        ]
    });
}

function initPtkDaftarSdsPage() {
    App.initializeGenericTablePage({
        tableId: 'daftarPtkSdsTable',
        serverFunction: 'getDaftarPtkSdsData',
        filterConfig: [
            { id: 'filterUnitKerja', dataColumn: 'Unit Kerja' },
            { id: 'filterStatus', dataColumn: 'Status' },
            { id: 'filterJabatan', dataColumn: 'Jabatan' }
        ]
    });
}

function initPtkKelolaSdPage() {
    App.initializeGenericTablePage({
        tableId: 'kelolaPtkSdTable',
        serverFunction: 'getKelolaPtkSdData',
        editPage: 'ptk_edit_sd',
        filterConfig: [
            { id: 'filterUnitKerja', dataColumn: 'Unit Kerja' }
        ]
    });

    document.getElementById('tambahPtkSdBtn').addEventListener('click', (e) => {
        App.loadPage(e, 'ptk_tambah_sd');
    });
}

function initPtkTambahSdPage() {
    const form = document.getElementById('addPtkSdForm');
    if (!form) return;

    const statusSekolahSelect = form.querySelector('#statusSekolah');
    const unitKerjaSelect = form.querySelector('#unitKerja');
    const dynamicFormContainer = form.querySelector('#dynamic-form-container');
    const formNegeri = form.querySelector('#form-negeri');
    const formSwasta = form.querySelector('#form-swasta');
    const jabatanSelect = form.querySelector('#jabatan');
    const tugasTambahanSelect = form.querySelector('#tugasTambahan');
    
    let allOptions = {};

    App.showAppModal('loading', 'Memuat formulir...');

    function populateSelect(selectEl, optionsArr, placeholder) {
        selectEl.innerHTML = `<option value="" disabled selected>-- ${placeholder} --</option>`;
        if (optionsArr) optionsArr.forEach(opt => selectEl.add(new Option(opt, opt)));
    }

    function toggleFormSection(sectionToShow, sectionToHide) {
        sectionToShow.style.display = 'block';
        sectionToHide.style.display = 'none';
        sectionToShow.querySelectorAll('input, select').forEach(input => input.disabled = false);
        sectionToHide.querySelectorAll('input, select').forEach(input => input.disabled = true);
    }

    statusSekolahSelect.addEventListener('change', function() {
        const isNegeri = this.value === 'Negeri';
        dynamicFormContainer.style.display = 'block';
        
        if (isNegeri) {
            toggleFormSection(formNegeri, formSwasta);
            populateSelect(unitKerjaSelect, allOptions['Unit Kerja Negeri'], 'Pilih Unit Kerja');
            populateSelect(formNegeri.querySelector('#statusNegeri'), allOptions['Status Negeri'], 'Pilih Status');
        } else {
            toggleFormSection(formSwasta, formNegeri);
            populateSelect(unitKerjaSelect, allOptions['Unit Kerja Swasta'], 'Pilih Unit Kerja');
            populateSelect(formSwasta.querySelector('#statusSwasta'), allOptions['Status Swasta'], 'Pilih Status');
        }
        unitKerjaSelect.disabled = false;
    });

    formNegeri.querySelector('#statusNegeri').addEventListener('change', function() {
        const status = this.value;
        const isASN = ['PNS', 'PPPK', 'PPPK Paruh Waktu'].includes(status);
        const nipInput = formNegeri.querySelector('#nip');
        const pangkatNegeriSelect = formNegeri.querySelector('#pangkatNegeri');
        
        nipInput.required = isASN;
        nipInput.disabled = !isASN;
        nipInput.placeholder = isASN ? 'Wajib diisi 18 digit' : '-';
        if (!isASN) nipInput.value = '-';

        pangkatNegeriSelect.disabled = (status === 'Tenaga Non ASN');
        if (status === 'PNS') {
            populateSelect(pangkatNegeriSelect, allOptions['Pangkat PNS'], 'Pilih Pangkat');
        } else if (status === 'PPPK') {
            populateSelect(pangkatNegeriSelect, allOptions['Pangkat PPPK'], 'Pilih Golongan');
        } else if (status === 'PPPK Paruh Waktu') {
            populateSelect(pangkatNegeriSelect, allOptions['Pangkat PPPK PW'], 'Pilih Golongan');
        } else {
            pangkatNegeriSelect.innerHTML = '<option value="-">--</option>';
            pangkatNegeriSelect.value = '-';
        }
    });

    google.script.run
        .withSuccessHandler(options => {
            if (options.error) {
                App.showAppModal('error', `Gagal memuat opsi: ${options.error}`);
                return;
            }
            allOptions = options;
            populateSelect(jabatanSelect, allOptions['Jabatan'], 'Pilih Jabatan');
            populateSelect(tugasTambahanSelect, allOptions['Tugas Tambahan'], 'Pilih Tugas Tambahan');
            toggleFormSection(document.createElement('div'), formNegeri);
            toggleFormSection(document.createElement('div'), formSwasta);
            document.getElementById('appModal').classList.remove('show');
        })
        .withFailureHandler(err => App.showAppModal('error', `Gagal memuat opsi form: ${err.message}`))
        .getNewPtkSdOptions();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan data PTK baru...');

        const formData = Object.fromEntries(new FormData(form));
        
        google.script.run
            .withSuccessHandler(response => {
                App.showAppModal('success', response, 'ptk_kelola_sd');
            })
            .withFailureHandler(error => {
                App.showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .addNewPtkSd(formData);
    });
}

function initPtkEditSdPage(params) {
    const form = document.getElementById('editPtkSdForm');
    const loadingDiv = document.getElementById('loading-data');
    const formContainer = document.getElementById('edit-form-container');
    if (!form || !params || !params.rowIndex || !params.source) {
        document.getElementById('main-content').innerHTML = `<p style="color:red; text-align:center;">Error: Parameter untuk edit tidak ditemukan.</p>`;
        return;
    }

    form.querySelector('[name="rowIndex"]').value = params.rowIndex;
    form.querySelector('[name="source"]').value = params.source;

    const statusSekolahInput = form.querySelector('[name="statusSekolah"]');
    const formNegeri = form.querySelector('#form-negeri');
    const formSwasta = form.querySelector('#form-swasta');
    const jabatanSelect = form.querySelector('#jabatan');
    const tugasTambahanSelect = form.querySelector('#tugasTambahan');
    
    let allOptions = {};

    function populateSelect(selectEl, optionsArr, placeholder) {
        selectEl.innerHTML = `<option value="">-- ${placeholder} --</option>`;
        if (optionsArr) optionsArr.forEach(opt => selectEl.add(new Option(opt, opt)));
    }

    function toggleFormSection(sectionToShow, sectionToHide) {
        sectionToShow.style.display = 'block';
        sectionToHide.style.display = 'none';
        sectionToShow.querySelectorAll('input, select').forEach(input => input.disabled = false);
        sectionToHide.querySelectorAll('input, select').forEach(input => input.disabled = true);
    }
    
    App.showAppModal('loading', 'Memuat data PTK...');

    google.script.run.withSuccessHandler(options => {
        allOptions = options;
        populateSelect(jabatanSelect, allOptions['Jabatan'], 'Pilih Jabatan');
        populateSelect(tugasTambahanSelect, allOptions['Tugas Tambahan'], 'Pilih Tugas Tambahan');

        google.script.run.withSuccessHandler(rowData => {
            document.getElementById('appModal').classList.remove('show');
            if (rowData.error) {
                App.showAppModal('error', `Gagal memuat data: ${rowData.error}`);
                return;
            }

            const isNegeri = params.source === 'SDN';
            if (isNegeri) {
                toggleFormSection(formNegeri, formSwasta);
                populateSelect(formNegeri.querySelector('#statusNegeri'), allOptions['Status Negeri'], 'Pilih Status');
            } else {
                toggleFormSection(formSwasta, formNegeri);
                populateSelect(formSwasta.querySelector('#statusSwasta'), allOptions['Status Swasta'], 'Pilih Status');
            }

            for (const key in rowData) {
                const field = form.querySelector(`[name="${key}"]`);
                if (field) {
                    field.value = rowData[key];
                }
            }
            statusSekolahInput.value = isNegeri ? 'Negeri' : 'Swasta';
            
            if (isNegeri) {
                formNegeri.querySelector('#statusNegeri').dispatchEvent(new Event('change'));
            }

            loadingDiv.style.display = 'none';
            formContainer.style.display = 'block';

        }).withFailureHandler(err => App.showAppModal('error', `Gagal mengambil data baris: ${err.message}`)).getPtkSdDataByRow(params.rowIndex, params.source);
    }).withFailureHandler(err => App.showAppModal('error', `Gagal memuat opsi form: ${err.message}`)).getNewPtkSdOptions();
    
    formNegeri.querySelector('#statusNegeri').addEventListener('change', function() {
        const status = this.value;
        const isASN = ['PNS', 'PPPK', 'PPPK Paruh Waktu'].includes(status);
        const nipInput = formNegeri.querySelector('#nip');
        const pangkatNegeriSelect = formNegeri.querySelector('#pangkatNegeri');
        
        nipInput.required = isASN;
        nipInput.disabled = !isASN;
        nipInput.placeholder = isASN ? 'Wajib diisi 18 digit' : '-';
        if (!isASN) nipInput.value = '-';

        pangkatNegeriSelect.disabled = (status === 'Tenaga Non ASN');
        if (status === 'PNS') {
            populateSelect(pangkatNegeriSelect, allOptions['Pangkat PNS'], 'Pilih Pangkat');
        } else if (status === 'PPPK') {
            populateSelect(pangkatNegeriSelect, allOptions['Pangkat PPPK'], 'Pilih Golongan');
        } else if (status === 'PPPK Paruh Waktu') {
            populateSelect(pangkatNegeriSelect, allOptions['Pangkat PPPK PW'], 'Pilih Golongan');
        } else {
            pangkatNegeriSelect.innerHTML = '<option value="-">--</option>';
            pangkatNegeriSelect.value = '-';
        }
    });

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan perubahan...');

        const formData = Object.fromEntries(new FormData(form));
        
        google.script.run
            .withSuccessHandler(response => {
                App.showAppModal('success', response, 'ptk_kelola_sd');
            })
            .withFailureHandler(error => {
                App.showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .updatePtkSdData(formData);
    });
}

function initPtkKebutuhanSdnPage() {
    App.initializeGenericTablePage({
        tableId: 'kebutuhanPtkSdnTable',
        serverFunction: 'getKebutuhanPtkSdnData',
        isDoubleHeader: true
    });
}

function initMuridPaudKelasUsiaPage() {
    App.initializeGenericTablePage({
        tableId: 'muridPaudKelasUsiaTable',
        serverFunction: 'getMuridPaudKelasUsiaData',
        filterConfig: [ { id: 'filterJenjang', dataColumn: 'Jenjang' } ],
        footerConfig: {
            enabled: true,
            labelColumn: 'Nama Lembaga',
            sumStartColumn: 'Rombel'
        }
    });
}

function initMuridPaudJenisKelaminPage() {
    App.initializeGenericTablePage({
        tableId: 'muridPaudJkTable',
        serverFunction: 'getMuridPaudJenisKelaminData',
        filterConfig: [ { id: 'filterJenjang', dataColumn: 'Jenjang' } ],
        isDoubleHeader: true,
        footerConfig: {
            enabled: true,
            labelColumn: 'Nama Lembaga',
            sumStartColumn: 'Rombel'
        }
    });
}

function initMuridPaudJumlahBulananPage() {
    App.initializeGenericTablePage({
        tableId: 'muridPaudBulananTable',
        serverFunction: 'getMuridPaudJumlahBulananData',
        filterConfig: [
            { id: 'filterTahun', dataColumn: 'Tahun', sortReverse: true },
            { id: 'filterBulan', dataColumn: 'Bulan', specialSort: 'bulan' },
            { id: 'filterJenjang', dataColumn: 'Jenjang' }
        ],
        isDoubleHeader: true
    });
}

function initMuridSdKelasPage() {
    App.initializeGenericTablePage({
        tableId: 'muridSdKelasTable',
        serverFunction: 'getMuridSdKelasData',
        filterConfig: [ { id: 'filterStatus', dataColumn: 'Status' } ],
        footerConfig: {
            enabled: true,
            labelColumn: 'Nama Sekolah',
            sumStartColumn: 'Rombel'
        }
    });
}

function initMuridSdRombelPage() {
    App.initializeGenericTablePage({
        tableId: 'muridSdRombelTable',
        serverFunction: 'getMuridSdRombelData',
        filterConfig: [ { id: 'filterStatus', dataColumn: 'Status' } ],
        isDoubleHeader: true,
        footerConfig: {
            enabled: true,
            labelColumn: 'Nama Sekolah',
            sumStartColumn: 'Rombel'
        }
    });
}

function initMuridSdJenisKelaminPage() {
    App.initializeGenericTablePage({
        tableId: 'muridSdJkTable',
        serverFunction: 'getMuridSdJenisKelaminData',
        filterConfig: [ { id: 'filterStatus', dataColumn: 'Status' } ],
        isDoubleHeader: true,
        footerConfig: {
            enabled: true,
            labelColumn: 'Nama Sekolah',
            sumStartColumn: 'Rombel'
        }
    });
}

function initMuridSdAgamaPage() {
    App.initializeGenericTablePage({
        tableId: 'muridSdAgamaTable',
        serverFunction: 'getMuridSdAgamaData',
        filterConfig: [ { id: 'filterStatus', dataColumn: 'Status' } ],
        isDoubleHeader: true,
        footerConfig: {
            enabled: true,
            labelColumn: 'Nama Sekolah',
            sumStartColumn: 'Rombel'
        }
    });
}

function initMuridSdJumlahBulananPage() {
    App.initializeGenericTablePage({
        tableId: 'muridSdBulananTable',
        serverFunction: 'getMuridSdJumlahBulananData',
        filterConfig: [
            { id: 'filterTahun', dataColumn: 'Tahun', sortReverse: true },
            { id: 'filterBulan', dataColumn: 'Bulan', specialSort: 'bulan' },
            { id: 'filterStatus', dataColumn: 'Status' }
        ],
        isDoubleHeader: true
    });
}

function initSiabaDaftarPresensiPage() {
    const filterTahun = document.getElementById('filterTahun');
    const filterBulan = document.getElementById('filterBulan');
    const filterUnitKerja = document.getElementById('filterUnitKerja');
    const terapkanBtn = document.getElementById('terapkanFilterBtn');
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const tableHead = document.getElementById('presensiTable').querySelector('thead');
    const tableBody = document.getElementById('presensiTable').querySelector('tbody');

    let allMonthlyData = [];
    let displayHeaders = [];

    const backgroundMap = {
        'HA': 'cell-bg-cream', 'APL': 'cell-bg-cream', 'TAp': 'cell-bg-cream',
        'HU': 'cell-bg-cream', 'U': 'cell-bg-cream', 'TU': 'cell-bg-cream',
        'CT': 'cell-bg-green', 'CAP': 'cell-bg-green', 'CS': 'cell-bg-green', 'CM': 'cell-bg-green',
        'DD': 'cell-bg-blue', 'DL': 'cell-bg-blue',
        'TA': 'cell-bg-yellow', 'Waktu TA': 'cell-bg-yellow', 'PLA': 'cell-bg-yellow', 'Waktu PLA': 'cell-bg-yellow',
        'LA': 'cell-bg-purple'
    };

    const fontColorMap = {
        'CT': 'font-green', 'CAP': 'font-green', 'CS': 'font-green', 'CM': 'font-green',
        'DD': 'font-blue', 'DL': 'font-blue',
        'DP': 'font-brown'
    };
    
    const redFontColumns = ['TAp', 'TU', 'TA', 'PLA', 'LA'];

    function populateSelect(selectElement, options, defaultValue = null) {
        selectElement.innerHTML = '';
        if (selectElement.id === 'filterUnitKerja') {
            selectElement.add(new Option('Semua', 'Semua'));
        }
        options.forEach(opt => {
            selectElement.add(new Option(opt, opt));
        });
        if (defaultValue && options.includes(defaultValue)) {
            selectElement.value = defaultValue;
        } else if (options.length > 0 && selectElement.id !== 'filterUnitKerja') {
             selectElement.selectedIndex = 0;
        }
    }

    function renderTable() {
        const selectedUnitKerja = filterUnitKerja.value;
        
        const filteredRows = (selectedUnitKerja === "Semua")
            ? allMonthlyData
            : allMonthlyData.filter(row => row[0] === selectedUnitKerja);
        
        tableBody.innerHTML = '';
        if (!filteredRows || filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${displayHeaders.length + 1}">Tidak ada data untuk unit kerja ini.</td></tr>`;
        } else {
            const tpIndex = displayHeaders.indexOf('TP');
            const dayStartIndex = displayHeaders.indexOf('1D');
            const dayEndIndex = displayHeaders.indexOf('31P');

            filteredRows.forEach((row, index) => {
                const rowData = row.slice(1); 
                const tr = document.createElement('tr');
                
                let rowHTML = `<td>${index + 1}</td>`;
                rowData.forEach((cell, cellIndex) => {
                    const header = displayHeaders[cellIndex];
                    let classes = [];
                    const isNumericValuePositive = parseInt(cell, 10) > 0;

                    if (backgroundMap[header]) {
                        classes.push(backgroundMap[header]);
                    }
                    
                    if (dayStartIndex !== -1 && cellIndex >= dayStartIndex && cellIndex <= dayEndIndex) {
                        if (cell === '' || cell === null || cell === undefined) {
                            classes.push('cell-bg-red');
                        } else if (cell === '-') {
                            classes.push('cell-bg-gray');
                        } else if (fontColorMap[cell]) {
                            classes.push(fontColorMap[cell]);
                        }
                    }

                    if (cellIndex === tpIndex && isNumericValuePositive) {
                        classes.push('cell-negative');
                    }
                    
                    if (redFontColumns.includes(header) && isNumericValuePositive) {
                        classes.push('font-red');
                    }
                    
                    const classString = classes.length > 0 ? ` class="${classes.join(' ')}"` : '';
                    const cellContent = (cell === '' || cell === null || cell === undefined || cell === '0') ? '-' : cell;
                    rowHTML += `<td${classString}>${cellContent}</td>`;
                });

                tr.innerHTML = rowHTML;
                tableBody.appendChild(tr);
            });
        }
    }

    function fetchData() {
        const filters = {
            tahun: filterTahun.value,
            bulan: filterBulan.value
        };

        if (!filters.tahun || !filters.bulan) {
            App.showAppModal('info', 'Silakan pilih Tahun dan Bulan terlebih dahulu.');
            return;
        }

        loadingStatus.style.display = 'flex';
        tableWrapper.style.display = 'none';

        google.script.run
            .withSuccessHandler(result => {
                loadingStatus.style.display = 'none';
                if (result.error) {
                     loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${result.error}</p>`;
                     loadingStatus.style.display = 'flex';
                     return;
                }

                allMonthlyData = result.rows; 
                displayHeaders = result.headers.slice(1);

                tableHead.innerHTML = '';
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = '<th>No.</th>' + displayHeaders.map(h => `<th>${h}</th>`).join('');
                tableHead.appendChild(headerRow);
                
                tableWrapper.style.display = 'flex';
                renderTable();
            })
            .withFailureHandler(err => {
                loadingStatus.style.display = 'none';
                loadingStatus.innerHTML = `<p style="color:red;">Gagal menghubungi server: ${err.message}</p>`;
                loadingStatus.style.display = 'flex';
            })
            .getSiabaPresensiData(filters);
    }

    google.script.run
        .withSuccessHandler(options => {
            const now = new Date();
            const currentYear = now.getFullYear().toString();
            const currentMonth = now.toLocaleString('id-ID', { month: 'long' });

            populateSelect(filterTahun, options['Tahun'], currentYear);
            populateSelect(filterBulan, options['Bulan'], currentMonth);
            populateSelect(filterUnitKerja, options['Unit Kerja'], 'Semua');

            terapkanBtn.addEventListener('click', fetchData);
            filterUnitKerja.addEventListener('change', renderTable);
            fetchData();
        })
        .withFailureHandler(err => {
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat filter. Error: ${err.message}</p>`;
        })
        .getSiabaFilterOptions();
}

function initSiabaTidakPresensiPage() {
    const filterTahun = document.getElementById('filterTahun');
    const filterBulan = document.getElementById('filterBulan');
    const filterUnitKerja = document.getElementById('filterUnitKerja');
    const terapkanBtn = document.getElementById('terapkanFilterBtn');
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const tableHead = document.getElementById('tidakPresensiTable').querySelector('thead');
    const tableBody = document.getElementById('tidakPresensiTable').querySelector('tbody');

    function populateSelect(selectElement, options, defaultValue = null) {
        selectElement.innerHTML = '';
        if (selectElement.id === 'filterUnitKerja') {
            selectElement.add(new Option('Semua', 'Semua'));
        }
        options.forEach(opt => {
            selectElement.add(new Option(opt, opt));
        });
        if (defaultValue && options.includes(defaultValue)) {
            selectElement.value = defaultValue;
        } else if (options.length > 0 && selectElement.id !== 'filterUnitKerja') {
             selectElement.selectedIndex = 0;
        }
    }

    function fetchData() {
        const filters = {
            tahun: filterTahun.value,
            bulan: filterBulan.value,
            unitKerja: filterUnitKerja.value
        };
        loadingStatus.style.display = 'flex';
        tableWrapper.style.display = 'none';

        google.script.run
            .withSuccessHandler(result => {
                loadingStatus.style.display = 'none';
                tableHead.innerHTML = '';
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = '<th>No.</th>' + result.headers.map(h => `<th>${h}</th>`).join('');
                tableHead.appendChild(headerRow);

                tableBody.innerHTML = '';
                if (!result.rows || result.rows.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="${result.headers.length + 1}">Tidak ada data ditemukan untuk filter ini.</td></tr>`;
                } else {
                    result.rows.forEach((row, index) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${index + 1}</td>` + row.map(cell => `<td>${cell || '-'}</td>`).join('');
                        tableBody.appendChild(tr);
                    });
                }
                tableWrapper.style.display = 'flex';
            })
            .withFailureHandler(err => {
                loadingStatus.style.display = 'none';
                tableWrapper.style.display = 'flex';
                tableBody.innerHTML = `<tr><td colspan="7" style="color:red;">Gagal memuat data: ${err.message}</td></tr>`;
            })
            .getSiabaTidakPresensiData(filters);
    }

    google.script.run
        .withSuccessHandler(options => {
            const now = new Date();
            const currentYear = now.getFullYear().toString();
            const currentMonth = now.toLocaleString('id-ID', { month: 'long' });

            populateSelect(filterTahun, options['Tahun'], currentYear);
            populateSelect(filterBulan, options['Bulan'], currentMonth);
            populateSelect(filterUnitKerja, options['Unit Kerja'], 'Semua');

            terapkanBtn.addEventListener('click', fetchData);
            fetchData();
        })
        .withFailureHandler(err => {
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat opsi filter: ${err.message}</p>`;
        })
        .getSiabaTidakPresensiFilterOptions();
}


/**
 * ===================================================================
 * =================== 3. OBJEK INISIALISASI & TRIGGER ===============
 * ===================================================================
 */
 
App.pageInitializers = {
    'home': initMenuPage,
    'sk_menu': initMenuPage,
    'sk_unggah': initSkUnggahPage,
    'sk_riwayat': initSkRiwayatPage,
    'sk_status': initSkStatusPage,
    'sk_kelola': initSkKelolaPage,
    'sk_edit': initSkEditPage,
    'sk_arsip': initSkArsipPage,
    'lapbul_menu': initMenuPage,
    'lapbul_unggah': initLapbulUnggahPage,
    'lapbul_form_paud': initLapbulFormPaudPage,
    'lapbul_form_sd': initLapbulFormSdPage,
    'lapbul_riwayat': initLapbulRiwayatPage,
    'lapbul_status': initLapbulStatusPage,
    'lapbul_arsip': initLapbulArsipPage,
    'lapbul_kelola': initLapbulKelolaPage,
    'lapbul_edit_paud': initLapbulEditPaudPage,
    'lapbul_edit_sd': initLapbulEditSdPage,
    'lapbul_unduh_format': initLapbulUnduhFormatPage,
    'ptk_menu': initMenuPage,
    'ptk_paud_menu': initMenuPage,
    'ptk_sd_menu': initMenuPage,
    'ptk_keadaan_paud': initPtkKeadaanPaudPage,
    'ptk_keadaan_sd': initPtkKeadaanSdPage,
    'ptk_jumlah_bulanan_sd': initPtkJumlahBulananSdPage,
    'ptk_jumlah_bulanan_paud': initPtkJumlahBulananPaudPage,
    'ptk_daftar_paud': initPtkDaftarPaudPage,
    'ptk_kelola_paud': initPtkKelolaPaudPage,
    'ptk_tambah_paud': initPtkTambahPaudPage,
    'ptk_edit_paud': initPtkEditPaudPage,
    'ptk_daftar_sd_negeri': initPtkDaftarSdnPage,
    'ptk_daftar_sd_swasta': initPtkDaftarSdsPage,
    'ptk_kelola_sd': initPtkKelolaSdPage,
    'ptk_kebutuhan_sd_negeri': initPtkKebutuhanSdnPage,
    'ptk_tambah_sd': initPtkTambahSdPage,
    'ptk_edit_sd': initPtkEditSdPage,
    'ptk_bezetting_sd_negeri': initMenuPage,
    'murid_menu': initMenuPage,
    'murid_paud_kelas_usia': initMuridPaudKelasUsiaPage,
    'murid_paud_jenis_kelamin': initMuridPaudJenisKelaminPage,
    'murid_paud_jumlah_bulanan': initMuridPaudJumlahBulananPage,
    'murid_sd_kelas': initMuridSdKelasPage,
    'murid_sd_rombel': initMuridSdRombelPage,
    'murid_sd_jenis_kelamin': initMuridSdJenisKelaminPage,
    'murid_sd_agama': initMuridSdAgamaPage,
    'murid_sd_jumlah_bulanan': initMuridSdJumlahBulananPage,
    'siaba_menu': initMenuPage,
    'siaba_panduan': initMenuPage,
    'siaba_daftar_presensi': initSiabaDaftarPresensiPage,
    'siaba_tidak_presensi': initSiabaTidakPresensiPage,
    'siaba_apel_upacara': initMenuPage,
    'siaba_lupa_presensi': initMenuPage,
    'siaba_salah_presensi': initMenuPage,
    'siaba_perjalanan_dinas': initMenuPage,
    'siaba_cuti': initMenuPage,
    'siaba_rekap_terlambat': initMenuPage,
    'siaba_rekap_pulang_awal': initMenuPage,
    'siaba_unduh_rekap': initMenuPage,
    'pns_menu': initMenuPage,
    'rapor_pendidikan_menu': initMenuPage,
    'tata_naskah_menu': initMenuPage,
    'mutasi_murid_menu': initMenuPage,
    'tapera_sitara_menu': initMenuPage,
    'administrasi_sekolah_menu': initMenuPage,
    'data_sekolah_menu': initMenuPage,
    'komunitas_belajar_menu': initMenuPage,
    'gelar_karya_menu': initMenuPage
};

document.addEventListener('DOMContentLoaded', () => {
    // PERBAIKAN TIMING ERROR: Menggunakan setTimeout(..., 0)
    setTimeout(() => {
        App.loadPage(null, 'home');
    }, 0);
    
    document.body.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        if (!link) return;
        const pageName = link.dataset.page;
        const parentLi = link.parentElement;
        const isParentToggle = parentLi.classList.contains('has-submenu');
        if (pageName) {
            e.preventDefault();
            if (isParentToggle && parentLi.classList.contains('open')) {
                parentLi.classList.remove('open');
                return;
            }
            App.loadPage(null, pageName);
        }
    });
});
</script>